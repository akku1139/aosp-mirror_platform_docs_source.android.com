<html devsite>
  <head>
    <title>Setting up CTS</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->
{% include "_versions.html" %}

<p>
  To run CTS, first prepare your physical environment, your desktop
  machine, and the device you're using for testing.
    </p>
<h2 id="physical_environment">Physical environment</h2>

<h3 id="ble_beacons">Bluetooth LE beacons</h3>
<p>If the device under test (DUT) supports Bluetooth LE, place at least three
  Bluetooth LE beacons within five meters of the DUT for
  Bluetooth LE scan testing. Those beacons can be any kind, don't need to be
  configured or emit anything specific, and can include iBeacon, Eddystone, or
  even devices simulating BLE beacons.</p>

<h3 id="camera">Cameras</h3>
<p>When running camera CTS, use normal lighting conditions with a test pattern chart (such as a
checkerboard pattern) that isn't too close to the lens (the distance depends on the device's
minimum focus distance).</p>

<p>Point the camera sensors to a scene
with sufficient lighting to allow the sensors under test to reach and
remain at the maximum configured target frames per second (FPS) as specified in
<a
href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest#CONTROL_AE_TARGET_FPS_RANGE"
class="external"><code>CONTROL_AE_TARGET_FPS_RANGE</code></a>. This applies to
all camera sensors reported by <a
href="https://developer.android.com/reference/android/hardware/camera2/CameraManager#getCameraIdList()"
class="external"><code>getCameraIdList</code></a> as the test iterates over all listed
devices and measures performance individually.</p>

<p>If the DUT supports external cameras, such as USB
webcams, plug in an external camera when running CTS.
Otherwise, the CTS tests fails.</p>

<h3 id="gnss">GPS/GNSS</h3>
<p>If the DUT supports the global positioning system/global navigation satellite system (GPS/GNSS)
feature, provide a GPS/GNSS signal (with GPS portion
compliant with ICD-GPS-200C) to the DUT at a suitable signal
level for reception and GPS location calculation. The GPS/GNSS signal source can
be of any kind, ranging from a satellite simulator, to a GPS/GNSS repeater of
outdoor signals, to placement of the DUT close enough to a window such that
it can directly receive enough GPS/GNSS signal.</p>

<aside class="caution">
  <strong>Caution:</strong> For the GPS testing, the internet connection setup
  must not block connections to <code>supl.google.com</code> port 7276. This port
  downloads GPS assistance data for testing position calculation on the local device.
</aside>

<h3 id="wifi">Wi-Fi and IPv6</h3>
<p>CTS tests require a Wi-Fi network that supports IPv6, can treat the DUT
as an isolated client, and has an internet connection. An isolated client refers to a
configuration where the DUT doesn't have visibility to the
broadcast/multinetwork messages on that subnetwork, either by a Wi-Fi AP
configuration or by running the DUT on an isolated subnetwork without
other devices being connected.</p>

<p>If you don't have access to a native IPv6 network, an IPv6 carrier network,
or a VPN to pass some tests depending on IPv6, you can use a Wi-Fi
access point and an IPv6 tunnel. See Wikipedia's
  <a href="http://en.wikipedia.org/wiki/List_of_IPv6_tunnel_brokers"
     class="external">list of IPv6 tunnel brokers</a>.</p>

<h3 id="rtt">Wi-Fi RTT</h3>
<p>Android includes the
<a href="https://developer.android.com/reference/android/net/wifi/rtt/package-summary">Wi-Fi RTT API</a>
for a <a ref="/devices/tech/connect/wifi-rtt">Wi-Fi
round trip time (RTT)</a> capability, which allows devices to measure their distance to access
points with an accuracy of 1 to 2 meters, significantly increasing indoor location
accuracy. Two recommended devices supporting Wi-Fi RTT are
<a href="https://store.google.com/product/google_wifi" class="external">Google Wifi</a> and
<a href="https://fit-iot.com/web/products/fitlet2/" class="external">Compulab's fitlet2 access
point</a> (set to 40&nbsp;MHz bandwidth at 5&nbsp;GHz).</p>

<p>The access points should be powered up, but aren't required to be connected to
  any network. Access points don't need to be next to the testing device but
  are recommended to be within 40&nbsp;ft of the DUT.
  One access point is typically sufficient.</p>

<h2 id="desktop_setup">Desktop machine setup</h2>
<aside class="caution"><strong>Caution:</strong> CTS supports 64-bit
Linux and macOS host machines. CTS doesn't work on Windows OS.</aside>

<h3 id="adb">ADB and AAPT</h3>
<p>Before running the CTS, make sure that you have recent versions of both
  <a href="http://developer.android.com/tools/help/adb.html"
     class="external">Android Debug Bridge (adb)</a> and
  <a href="http://developer.android.com/guide/topics/manifest/uses-feature-element.html#testing"
     class="external">Android Asset Packaging Tool (AAPT)</a> installed and
  the location of those tools added to the system path of your machine.</p>

<p>To install ADB, download the
  <a href="http://developer.android.com/sdk/index.html#Other"
     class="external">Android SDK Tools</a> package for your operating system,
  open it, and follow the instructions in the included README file. For
  troubleshooting information, see
  <a href="http://developer.android.com/sdk/installing/index.html?pkg=tools"
     class="external">Installing the Stand-alone SDK Tools</a>.</p>

<p>Ensure that <code>adb</code> and <code>aapt</code> are in your system path. The
  following command assumes that you've opened the package archive in your home
  directory:</p>

<pre class="devsite-terminal devsite-click-to-copy">
export PATH=$PATH:$HOME/android-sdk-linux/build-tools/<var>version</var>
</pre>

<aside class="note"><strong>Note:</strong> Ensure that your starting path and
directory name are correct.</aside>

<h3 id="JDK">Java Development Kit</h3>
<p>Install the proper version of the Java Development Kit (JDK). For Android
  7.0 and higher:
</p>
<ul>
  <li>On Ubuntu, use <a href="http://openjdk.java.net/install/" class="external">OpenJDK 8</a>.
  <li>On macOS, use
    <a href="http://www.oracle.com/technetwork/java/javase/downloads/java-archive-javase8-2177648.html#jdk-8u45-oth-JPR"
       class="external">jdk 8u45 or higher</a>.</li>
</ul>
<p>
For details, see the <a href="/setup/build/requirements#jdk">JDK requirements</a>.
</p>

<h3 id="CTS_files">CTS files</h3>

<p><a href="/compatibility/cts/downloads">Download</a> and open the CTS
  packages matching your devices' Android version and all the application
  binary interfaces (ABIs) that your devices support.</p>

<p>Download and open the latest version of the
  <a href="/compatibility/cts/downloads#cts-media-files">CTS media files</a>.
</p>

<h3 id="system_detect">Device detection</h3>
<p>Follow the step to
  <a href="http://developer.android.com/tools/device.html#setting-up"
     class="external">set up your system to detect your device</a>, such as
  creating a <code>udev</code> rules file for Ubuntu Linux.</p>

<h2 id="device_setup">Android device setup</h2>

<h3 id="user_builds">User builds</h3>

<p>A compatible device is defined as a device with a user/release-key signed
  build, so your device should be running a system image based on the known to
  be compatible user build (Android 4.0 and higher) from
  <a href="/setup/start/build-numbers">Codenames, Tags, and Build Numbers</a>.
</p>

<aside class="caution"><strong>Caution:</strong> When used to confirm Android
compatibility of your final system image, CTS must be executed on devices with
a user build.</aside>

<h3 id="first-api-level">First API level build property</h3>

<p>Certain CTS requirements depend on the build that a device was originally shipped
  with. For example, devices that originally ship with earlier builds may be
  excluded from system requirements that apply to devices that ship with later
  builds.</p>

<p>To make this information available to CTS, device manufacturers may define
  the build-time property <code>ro.product.first_api_level</code>. The value
  of this property is the first API level that the device was commercially launched
  with.</p>

<p>The device manufacturers can launch a new product as an upgrade of an existing
product in the same device group when choosing to reuse the common underlying
implementation with the existing product. The device manufacturers can optionally set the API level
of the existing product to <code>ro.product.first_api_level</code>, so that upgrade
requirements are applied for CTS and Treble/VTS.</p>

<p>The device manufacturers can add <code>PRODUCT_PROPERTY_OVERRIDES</code> into their
<code>device.mk</code> file to set this property, as shown in the following example: </p>

<pre class="devsite-click-to-copy">
#ro.product.first_api_level indicates the first api level that the device has
been commercially launched on.
PRODUCT_PROPERTY_OVERRIDES +=\
ro.product.first_api_level=21
</pre>

<h4 id="android-9-higher">First API level for Android 9 and higher</h4>

  <p>
    For devices launched with Android 9 or higher, set the
    <code>ro.product.first_api_level</code> property to a valid value found on
    <a href="/setup/start/build-numbers">Codenames, Tags, and Build Numbers</a>.
  </p>

<h4 id="android-8x-lower">First API level for Android 8.x and lower</h4>

  <p>
    For devices launched on Android 8.x or lower, unset (remove) the
    <code>ro.product.first_api_level</code> property for the first build of the
    product. For all subsequent builds, set
    <code>ro.product.first_api_level</code> to the correct API level value.
    This allows the property to correctly identify a new product and preserves
    information about the first API level of the product. If the flag is
    unset, Android assigns <code>Build.VERSION.SDK_INT</code> to
    <code>ro.product.first_api_level</code>.
  </p>

<h3 id="cts-shim-apps">CTS shim apps</h3>

<p> Android 7.0 includes the following prebuilt apps (built from
  <a href="https://android.googlesource.com/platform/frameworks/base/+/master/packages/CtsShim/build/"
     class="external">this source</a>), which don't contain any code except for
  the manifest: </p>

<ul>
  <li><code><a href="https://android.googlesource.com/platform/frameworks/base/+/android-7.0.0_r1/packages/CtsShim/CtsShim.apk"
               class="external">frameworks/base/packages/CtsShim/CtsShim.apk</a></code><br>
  This APK file is copied to <code>/system/app/CtsShimPrebuilt.apk</code>
    on the system image.</li>
  <li><code><a href="https://android.googlesource.com/platform/frameworks/base/+/android-7.0.0_r1/packages/CtsShim/CtsShimPriv.apk"
               class="external">frameworks/base/packages/CtsShim/CtsShimPriv.apk</a></code><br>
  This APK file is copied to <code>/system/priv-app/CtsShimPrivPrebuilt.apk</code>
  on the system image.</li>
</ul>

<p> CTS uses these apps to test privileges and permissions. To pass the tests, you must
preload the apps into the appropriate directories on the system image without
re-signing them.</p>

<h3 id="cts-shim-apex">CTS shim APEX</h3>
<p> Android {{ androidQVersionNumber }} and higher includes a package format
  called <a href="/devices/tech/ota/apex">APEX</a>. To write CTS tests for APEX
  management APIs (for example, updating to a new version, reporting active
  APEXes, and so on) you must preinstall a <code>CtsShimApex</code> package on
  the target device.</p>
<p>
<code><a href="https://android.googlesource.com/platform/system/apex/+/master/shim/com.android.apex.cts.shim.v1.apex"
         class="external">CtsShimApex</a></code> is required to be preinstalled
  on a <code>/system</code> partition.
</p>
<p>If the <code>ro.apex.updatable</code> property is set to <code>true</code>,
  <code>CtsShimApex</code> is required for all devices that support APEX
  package management. If the <code>ro.apex.updatable</code> property is missing or
  isn't set, <code>CtsShimApex</code> isn't required to be preinstalled on a
  device. The APEX shim validation test verifies the implementation of
  <code>CtsShimApex</code>.</p>

<h3 id="sample-applet">Sample Applet</h3>
<p>Android 9 introduced Open Mobile APIs. For devices that report
more than one secure element, CTS adds test cases to validate the
behavior of the Open Mobile APIs. These test cases require the one-time
installation of a sample applet into the embedded Secure Element (eSE)
of the DUT or into the SIM card used by the DUT. The
<a
href="https://android.googlesource.com/platform/cts/+/master/tests/tests/secure_element/sample_applet/Google-eSE-test.cap"
class="external">eSE sample applet</a> and the
<a href="https://android.googlesource.com/platform/cts/+/master/tests/tests/secure_element/sample_applet/uicc/google-cardlet.cap"
class="external">SIM sample applet</a> can be found in AOSP.</p>

<p>See <a href="/compatibility/cts/secure-element">CTS Test for Secure Element</a> for more
detailed information on Open Mobile API test cases and Access Control test cases.</p>

<h3 id="storage_requirements">Storage requirements</h3>
<p>The CTS media stress tests require video clips to be on external storage
(<code>/sdcard</code>). Most of the clips are from <a
href="https://peach.blender.org/" class="external">Big Buck Bunny</a>, which
  is copyrighted by the Blender Foundation under the
  <a href="http://creativecommons.org/licenses/by/3.0/"
     class="external">Creative Commons Attribution 3.0 license</a>.</p>
<p>The required space depends on the maximum video playback resolution supported
  by the device (see section 5 in the compatibility definition document for the
  platform version of the required resolutions). Note that the video playback
  capabilities of the DUT are checked through the
  <code>android.media.CamcorderProfile</code> APIs for earlier versions of Android and
  the <code>android.media.MediaCodecInfo.CodecCapabilities</code> APIs from Android 5.0.</p>
<p>Here are the storage requirements by maximum video playback resolution:</p>
<ul>
  <li>480x360: 98&nbsp;MB</li>
  <li>720x480: 193&nbsp;MB</li>
  <li>1280x720: 606&nbsp;MB</li>
  <li>1920x1080: 1863&nbsp;MB</li>
</ul>

<h3 id="screen_storage">Screen and storage</h3>
<ul>
<li>Any device that doesn't have an embedded screen needs to be connected to a screen.</li>
<li>If the device has a memory card slot, plug in an empty SD card. <em>Use an
SD card that supports ultra high speed (UHS) bus with SDHC or SDXC capacity or
one with at least speed class 10 or higher to ensure that it can pass the CTS.</em>
<aside class="warning"><strong>Warning:</strong> CTS may modify/erase data on
  the SD card plugged into the device.</aside>
</li>
<li>If the device has SIM card slots, plug an activated SIM card into each slot. If the device
  supports SMS, each SIM card should have its own number field populated.</li>
</ul>

<h3 id="developer_uicc">Developer UICC</h3>

<p>In order to run CTS carrier API tests, the device needs to have a SIM card
with carrier privilege rules on it. See <a
href="/devices/tech/config/uicc#prepare_uicc">Preparing
the UICC</a>.</p>

<h2 id="config_device">Android device configuration</h2>
<ol>
  <li>Factory data reset the device: <strong>Settings &gt; Backup &amp; reset &gt;
    Factory data reset</strong>
    <aside class="warning"><strong>Warning:</strong> This reset erases all user
      data from the device.</aside>
  </li>
  <li>Set your device's language to English (<strong>United States</strong>):
  <strong>Settings &gt; Language &amp; input &gt; Language</strong>
  </li>
  <li>Turn on the location setting if there's a GPS or Wi-Fi/cellular
    network feature on the device: <strong>Settings &gt; Location &gt;
    On</strong>
  </li>
  <li>Connect to a Wi-Fi network that supports IPv6, can treat the DUT
    as an <em>isolated client</em> (see <a href="#physical_environment">Physical Environment</a>
    above), and has an internet connection: <strong>Settings &gt; Wi-Fi</strong>
  </li>
  <li>Make sure that no lock pattern or password is set on the device:
    <strong>Settings &gt; Security &gt; Screen lock &gt; None</strong>
  </li>
  <li>Enable <strong>USB debugging</strong> on your device: <strong>Settings
    &gt; Developer options &gt; USB debugging</strong>
       <aside class="note"><strong>Note:</strong> On Android 4.2 and higher,
         <strong>Developer options</strong> is hidden by default. To make it
         available, go to <strong>Settings &gt; About phone</strong> and tap
         <strong>Build number</strong> seven times. Return to the previous
         screen to find <strong>Developer options</strong>. See
         <a href="http://developer.android.com/studio/run/device.html#developer-device-options"
             class="external">Enabling On-device Developer Options</a> for
         additional details.</aside>
  </li>
  <li>Set the time to 12-hour format: <strong>Settings &gt; Date &amp; time &gt; Use
    24-hour format &gt; Off</strong>
  </li>
  <li>Set the device to stay awake: <strong>Settings &gt; Developer options &gt; Stay Awake &gt;
    On</strong>
  </li>
  <li>In <strong>Android 5.x and 4.4.x only</strong>, set the device to allow mock locations:
    <strong>Settings &gt; Developer options &gt; Allow mock locations &gt; On</strong></li>
  <li>In <strong>Android 4.2 and higher</strong>, turn off USB app verification:
    <strong>Settings &gt; Developer options &gt; Verify apps over USB &gt; Off</strong></li>
  <li>Launch the browser and dismiss any startup/setup screen.
  </li>
  <li>Connect the desktop machine that will be used to test the device with a
    USB cable.
    <aside class="note"><strong>Note:</strong> When you connect a device
      running Android 4.2.2 or higher to your computer, the system shows a
      dialog asking whether to accept an RSA key that allows debugging through
      this computer. Select <em>Allow USB debugging</em>.</aside>
  </li>
  </ol>
<h3 id="file-installation">File installation</h3>
<p>Install and configure helper apps on the device.</p>
<ol>
  <li>Set up your device according to your CTS version:
    <ul>
      <li><strong>CTS versions 2.1 R2 through 4.2 R4:</strong> Set up your device (or emulator)
      to run the accessibility tests with:
      <pre class="devsite-terminal devsite-click-to-copy">
      adb install -r android-cts/repository/testcases/CtsDelegatingAccessibilityService.apk</pre>
  <br>On the device, enable delegation: <strong>Settings &gt; Accessibility &gt;
      Accessibility &gt; Delegating Accessibility Service</strong></li>
   <li><strong>CTS versions 6.x and lower:</strong>
      On devices that declare <code>android.software.device_admin</code>, set
      up your device to run the device administration test using:
      <pre class="devsite-terminal devsite-click-to-copy">
      adb install -r android-cts/repository/testcases/CtsDeviceAdmin.apk</pre>
    <br>In <strong>Settings &gt; Security &gt; Select device
      administrators</strong>, enable the two
      <code>android.deviceadmin.cts.CtsDeviceAdminReceiver*</code> device
      administrators. Ensure that
      <code>android.deviceadmin.cts.CtsDeviceAdminDeactivatedReceiver</code>
      and any other preloaded device administrators remain disabled.
      </li></ul>
  </li>
  <li>Copy the CTS media files to the device as follows:
    <aside class="note"><strong>Note:</strong> For CTS 2.3 R12 and higher, if
      the device supports video codecs, the CTS media files must be copied to
      the device.</aside>
    <ul>
      <li>Navigate (<code>cd</code>) to the path the media files are downloaded
        and unzipped to.
      </li>
      <li>Change the file permissions:
        <pre class="devsite-terminal devsite-click-to-copy">
        chmod u+x copy_media.sh</pre>
      </li>
      <li>Run <code>copy_media.sh</code>:
        <ul>
          <li>To copy clips up to a resolution of 720x480, run:
            <pre class="devsite-terminal devsite-click-to-copy">
            ./copy_media.sh 720x480</pre>
          </li>
          <li>If you aren't sure of the maximum resolution, copy all of the files:
            <pre class="devsite-terminal devsite-click-to-copy">
            ./copy_media.sh all</pre>
          </li>
          <li>If there are multiple devices under adb, add the serial option
            (<code>-s</code>) to the end. For example, to copy up to 720x480
            to the device with serial 1234567, run:
            <pre class="devsite-terminal devsite-click-to-copy">
            ./copy_media.sh 720x480 -s 1234567</pre>
          </li>
        </ul>
      </li>
    </ul>
  </li>
    </ol>
  </body>
</html>
