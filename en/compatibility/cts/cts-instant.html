<html devsite>
<head>
  <title>CTS for Instant Apps</title>
  <meta name="project_path" value="/_project.yaml" />
  <meta name="book_path" value="/_book.yaml" />
</head>

<body>
  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->
  {% include "_versions.html" %}

<p>
Instant Apps are a key feature of {{ androidQVersionNumber }}, so it's essential that they work
properly. Instant Apps are implicitly installed, so they have a restricted set of
capabilities and run in a more restrictive security sandbox. Due to the pervasive nature
of these restrictions, any part of the system is at risk for not properly working with Instant
Apps. A CTS test subset is created to ensure that behaviors allowed by Instant Apps are
working. The key idea is to minimize the size growth of CTS by isolating the
minimal set of tests to port. CTS running in Instant Apps mode means
installing the test APK as an Instant App and running the tests.
</p>

<h2 id="restrictions">Instant App restrictions</h2>


<p>
Instant Apps aren't installed by the user, so they run in a restricted sandbox with
the following restrictions:
</p><ul>

<li>Can hold only certain permissions.
<li>Can't see other apps unless those apps are marked as visible to Instant Apps.
<li>Can access only certain system settings.
<li>Can access only certain system properties.
<li>Can't expose services/providers.
<li>Can receive and send with special rules around broadcasts. </li></ul>

<p>
In addition, Instant Apps have to opt in to allowing the new security sandbox to add more
restrictions. This wide range of special behaviors around Instant Apps cross cut
the entire platform, so there needs to be a way to validate that Instant Apps work as expected for all
devices in the ecosystem.
</p>

<h2 id="current-approach">Tests running in Instant Apps mode</h2>
<p>
Not all CTS modules have tests applicable to Instant Apps. If the functionality tested by
the module has interaction with the system server, then these tests should be run in the
Instant App mode. For example, the OpenGL tests aren't interacting with the system server and so
there's no need to run them in Instant App mode while the accessibility tests interact with the
system server but there is a need to run them in Instant App mode.
</p>
<p>
In addition to identifying which modules are applicable, users need to determine
which tests in these modules are relevant. For example, testing service-specific behaviors for
a pluggable architecture (for example, AccessibilityService) isn't applicable for Instant App
mode as Instant Apps can't expose services to other apps (including the platform) while tests
validating app-side behaviors are applicable for Instant Apps mode. Another example is a test that
validates behaviors behind a permission that an Instant App can't hold aren't relevant in Instant
App mode. There's a set of tests that apply only to Instant Apps that validate the rules around
how they behave, for example, not exposing services, or not seeing other apps. Typically,
these are already written and don't require porting.
</p>


<h2 id="failures">Test failures in Instant mode</h2>
<p>
If the test is failing because it validates functionality that Instant Apps can't access, then it
isn't applicable in Instant App mode. Mark the test to run only in Full App mode by annotating
it with <code>@AppModeFull</code>. You can apply this annotation to the class level to exclude all
tests in it.
</p>
<p>
If the test fails because some functionality accessible to Instant Apps is broken,
<a href="/setup/contribute/report-bugs">file a bug</a>.
</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>
If your test fails with <em>Failed to install MyCtsModule.apk on DEVICE. Reason: '-116'</em>,
look for PackageManager messages on logcat. For example, if it says <em>Can't replace Full
App with Instant App: your_app</em>, then adb uninstall your app first.
</p>

</body>
</html>
