<html devsite>
  <head>
    <title>Camera ITS-in-a-Box</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->



<p>Android Camera Image Test Suite (ITS) is part of Android Compatibility Test
Suite (CTS) Verifier and includes tests that verify image content. As of CTS
7.0_r8, CTS Verifier supports ITS test automation via Camera ITS-in-a-box;
support for manual tests continues to ensure coverage for all Android device
form factors.</p>

<p>ITS-in-a-box brings the following benefits:</p>
<ul>
<li><strong>Automation</strong>. No human intervention is needed during the
test.</li>
<li><strong>Reduced testing time</strong>. Parallel testing of front/back camera
cuts
testing cycle time by 50%.</li>
<li><strong>Easier troubleshooting</strong>. Consistency of test environment
leads to fewer setup errors and increases reproducibility.</li>
<li><strong>Efficiency</strong>. Ability to retry for individual Camera/Scene
improves test execution efficiency.</li>
</ul>

<h2 id=get-started>Getting started</h2>
<p>ITS-in-a-box consists of a plastic box that is laser cut from computer-aided
design (CAD) drawings, a chart tablet, and a device under test (DUT). You can
use the wide field of view (WFoV) ITS-in-a-box, which is capable
of testing both WFoV (FoV &gt; 90 degrees) and RFoV (FoV &lt; 90 degrees)
cameras, or
the regular field of view (RFoV) ITS-in-a-box.</p>

<p>To get started with the Camera ITS-in-a-box:</p>
<ol>
<li>Purchase or build a <a
href="/compatibility/cts/camera-wfov-box-assembly">wide field of view
(WFoV)</a> or <a href="/compatibility/cts/camera-its-box-assembly">regular field
of view (RFoV)</a> ITS-in-a-box.</li>
<li><a href="#configure-tablet">Configure a tablet</a> with Camera ITS
software.</li>
<li><a href="#run-tests">Run tests</a>.</li>
<li><a href="#get-results">Get results</a> from the DUT.</li>
</ol>

<h2 id=configure-tablet>Configuring the tablet</h2>
<p>This section provides step-by-step instructions for setting up a
tablet for use with the Camera ITS software. These instructions use a Pixel C as
  an example tablet. For information on tablet
requirements and recommendations, see <a href="#tablet-requirements">Tablet
requirements</a>.</p>

<p class="note"><strong>Note:</strong> The Camera ITS python scripts
automatically set the following options on the tablet for you:
<br><em>Settings > Display > Sleep > After 30 minutes of inactivity</em>
<br><em>Adaptive brightness > OFF</em>
</p>

<ol>
<li>Charge the tablet and power it on. If prompted to set up an account, skip it
(Camera ITS does not require any account paired with the tablet).</li>
<li>Update the tablet to Android 7.0 or higher. Android 6.x and lower versions
do not support Camera ITS.</li>
<li>Enable <a href="https://developer.android.com/studio/debug/dev-options#enable"
              class="external">developer mode</a>.</li>
<li>Return to <em>Settings</em> and select <strong>Developer options</strong>.

<table>
<tr>
<th>Enable options</th>
<td>
<ul>
<li>On</li>
<li>Stay awake</li>
<li>USB debugging (This allows the host to run the tablet in debug mode. When you
connect the tablet to the host for the first time, the tablet prompts you to
"Allow USB debugging?" If the tablet does not display the debug prompt,
disconnect then reconnect tablet.)</li>
</ul>
</td>
</tr>
<tr>
<th>Disable options</th>
<td>
<ul>
<li>Automatic system updates</li>
<li>Verify apps over USB</li>
</ul>
</td>
</tr>
</table>
</li>
<li>Determine DUT and chart IDs by running <code>$ adb devices</code> to list
available devices. To determine <code>device_id</code> and
<code>chart_id</code>, plug and unplug devices and observe the devices that
connect and disconnect.</li>
<li>Perform three test runs to suppress hints and user prompts that can obscure
charts on the tablet screen.
<ol style=list-style-lower-alpha>
<li>Position the tablet face-up on a table (do not attach the tablet to the back
panel of the box)</li>
<li>Run the following command:
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=$device_id camera=0 chart=$chart_id scenes=2,3
</pre>
Scenes 2 and 3 require the tablet to display an image, so the tablet prompts you
to "Allow Drive to access photos, media, and files on your device?". Clear this
prompt (and prevent future prompts) by pressing <strong>Allow</strong>.</li>
<li>Run the command again. The tablet prompts you to "Keep a copy of this file?"
and suggests Google Drive. Clear this prompt (and prevent future prompts) by
pressing the Drive icon then <strong>Cancel</strong> for upload to drive.</li>
<li>Finally, run <code>tools/run_all_tests.py</code> and confirm that scenes
change automatically as script cycles through different scenes. While most
tests will fail (as the camera is not pointed at the chart), you can verify the
tablet correctly cycles through the scenes without displaying any prompts or
other pop-ups on the screen.</li></ol></li></ol>

<h2 id=run-tests>Running tests</h2>
<p>Before running the ITS-in-a-box, ensure your test setup includes the
following hardware and software:</p>
<ul>
<li>One (1) ITS-in-a-box</li>
<li>One (1) Pixel C for displaying Scenes, S/N: 5811000011</li>
<li>Two (2) DUTs that use the same build fingerprint and have the CTS Verifier
7.0_8+ application installed. Example DUTs:

<ul>
<li>One (1) Pixel NOF26W for the back camera(0) testing, S/N: FA6BM0305016. To
install the CTS Verifier app, unzip android-cts-verifier.zip then run
<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305016 install -r android-cts-verifier/CtsVerifier.apk
</pre></li>
<li>One (1) Pixel NOF26W for the front camera(1) testing, S/N: FA6BM0305439. To
install the CTS Verifier app, unzip android-cts-verifier.zip then run
<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305439 install -r android-cts-verifier/CtsVerifier.apk
</pre>
</li>
</ul>
</li></ul>

<h3 id=scenes-0-4>Running scenes 0-4</h3>
<p>To run scenes 0 to 4 on the front and back camera in parallel:</p>
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">cd android-cts-verifier/CameraITS</code>
<code class="devsite-terminal">. build/envsetup.sh</code>
<code class="devsite-terminal">python tools/run_parallel_tests.py device0=FA6BM0305016 device1=FA6BM0305439 chart=5811000011</code>
</pre>

<p>Examples:</p>
<table>
<tr>
<td><img src=/compatibility/cts/images/camera_its_cam0.png align="center"></td>
<td align="center"><img src=/compatibility/cts/images/camera_its_cam0.png></td>
</tr>
<tr>
<td align="center"><p class=caption><strong>Figure 1.</strong> Camera 0 S/N:
FA6BM0305016</p>
</td>
<td align="center"><p class=caption><strong>Figure 2.</strong> Camera 1 S/N:
FA6BM0305439</p>
</td>
</tr>
</table>

<h3 id=retry-scenes>Retrying scenes</h3>
<p>You can retry scenes for both front and back cameras or a single camera:
<ul>
<li>To retry scenes on front and back cameras in parallel:
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_parallel_tests.py device0=FA6BM0305016 device1=FA6BM0305439 chart=5811000011 scenes=3,4
</pre>
</li>
<li>To retry scenes on a single camera:
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=FA6BM0305016 chart=5811000011 camera=1 scenes=3,4
</pre>
</li>
</ul>

<h3 id=scenes-0-4>Running scene 5</h3>
<p>Scene 5 requires special setup with specific lighting (for details, refer to
<code>CameraITS.pdf</code> in CTS Verifier, which you can download at
<a href="/compatibility/cts/downloads">Compatibility Test Suite Downloads</a>).
You can run scene 5 separately
(outside of the box) to test two devices in parallel.</p>
<ul>
<li>To run scene 5 on front and back cameras on two devices in parallel:
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_parallel_tests.py device0=FA6BM0305016 device1=FA6BM0305439 chart=5811000011 scenes=5
</pre>
<br><img src=/compatibility/cts/images/camera_its_scene5.png width="50%"><br>
<strong>Figure 3.</strong> Camera scene 5</li>
<li>To run scene 5 for front and back cameras on a single device:
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">python tools/run_all_tests.py device=FA6BM0305016 camera=0 scenes=5</code>
<code class="devsite-terminal">python tools/run_all_tests.py device=FA6BM0305016 camera=1 scenes=5</code>
</pre></li>
</ul>

<h2 id=get-results>Getting results</h2>
<p>You can view results during testing and save the completed results as a
report.</p>
<ul>
<li><strong>View progress of running tests</strong>. The command
<code>run_parallel_tests</code> prints results only after Camera-Scene tests
have finished, so to view results during test execution you must use Android
Device Monitor or <code>adb logcat</code> to verify progress and/or view
screenshots.<br>
<br>Example adb command:
<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305016 logcat -v time
</pre>
Example screenshots command:
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb -s FA6BM0305016 shell screencap -p /sdcard/screencap.png</code>
<code class="devsite-terminal">adb -s FA6BM0305016 pull /sdcard/screencap.png</code>
<code class="devsite-terminal">display ./screencap.png</code>
</pre></li>
<li><strong>View results</strong>. To save Camera ITS results as a report:
<ol>
<li>Press <strong>Pass</strong> and save the report:
<br><img src=/compatibility/cts/images/camera_its_results.png width="50%"><br>
<strong>Figure 4.</strong> Camera ITS report</li>
<li>Pull reports from the device:
<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305016 pull /sdcard/verifierReports
</pre>
</li>
<li>Unzip the report file and view the test_result.xml.
<br><img src=/compatibility/cts/images/camera_its_reports.png><br>
<strong>Figure 5.</strong> Camera ITS reports<br></li>
</ol>
</li>
</ul>

<h2 id=tablet-requirements>Tablet requirements</h2>

<p>Tablets must have a display size of around 10 inches with a screen resolution
  greater than 2000 x 1500 pixels. The <code>DISPLAY_LEVEL</code> value must be
  set in
<code>CameraITS/tools/wake_up_screen.py</code> according to the tablet model.
The table below lists the values for recommended tablets.</p>

<p>Recommended tablets for ITS testing are shown below:</p>

<table>
  <tr>
    <th>Device</th>
    <th>Display size<br>(inches)</th>
    <th>Display size<br>(pixels)</th>
    <th>Tablet dimensions<br>(inches)</th>
    <th>DISPLAY_LEVEL</th>
    <th>OS</th>
  </tr>
  <tr>
    <td>Asus Zen Pad 3</td>
    <td>9.7</td>
    <td>2048 x 1536</td>
    <td>9.47 x 6.44 x 0.28</td>
    <td>192</td>
    <td>Android 6.0</td>
  </tr>
  <tr>
    <td>Huawei Mediapad m5</td>
    <td>10.8</td>
    <td>2560 x 1600</td>
    <td>10.18 x 6.76 x 0.29</td>
    <td>192</td>
    <td>Android 8.0</td>
  </tr>
  <tr>
    <td>Pixel C</td>
    <td>10.2</td>
    <td>2560 x 1800</td>
    <td>9.53 x 7.05 x 0.28</td>
    <td>96</td>
    <td>Android 8.0</td>
  </tr>
  <tr>
    <td>Samsung S3</td>
    <td>9.7</td>
    <td>2048 x 1536</td>
    <td>10.76 x 6.65 x 0.24</td>
    <td>192</td>
    <td>Android 7.0</td>
  </tr>
  <tr>
    <td>Sony Xperia Z4</td>
    <td>10.1</td>
    <td>2560 x 1600</td>
    <td>10 x 6.57 x 0.24</td>
    <td>192</td>
    <td>Android 7.0</td>
  </tr>
</table>

<h2 id="faq">Frequently asked qustions (FAQ)</h2>

<h3 id="faq-1">Q1: How do I determine which test rigs I need for my device?</h3>

<p>The <a href="/compatibility/cts/camera-its-box-assembly">
RFoV ITS-in-a-box revision 1</a> tests regular
  field-of-view (RFoV) cameras for scene 0 to scene 4 tests in the
<code><a href="https://android.googlesource.com/platform/cts/+/master/apps/CameraITS/tests/">
  CameraITS/tests</a></code> directory. RFoV is defined as
<em>60&deg;&nbsp;&lt;&nbsp;FoV&nbsp;&lt;&nbsp;90&deg;</em>.
For larger FoV cameras, the lights might appear in the images or the charts
might cover too small an area in the FoV, affecting test results.</p>

<p>The <a href="/compatibility/cts/camera-wfov-box-assembly">WFoV ITS-in-a-box
revision 2</a> tests wide field-of-view cameras
(WFoV) for scene 0 to scene 4 tests in the
<code><a href="https://android.googlesource.com/platform/cts/+/master/apps/CameraITS/tests/">
  CameraITS/tests</a></code> directory. WFoV is defined as
<em>FoV&nbsp;&gt;=&nbsp;90&deg;</em>.
It's functionally identical to revision 1, but larger. The revision 2 test rig
can test both RFoV and WFoV cameras in Android 9 and higher.</p>

<p>The <a href="/compatibility/cts/sensor-fusion-quick-start">
sensor fusion box</a> tests the camera/gyroscope timing
offset and multi-camera systems frame sync with tests in
<code>scenes=sensor_fusion</code>. A camera/gyroscope timing offset of less
than 1&nbsp;ms is required for the <code>REALTIME</code> feature flag and
VR/AR applications.</p>

<p>Multi-camera devices can be tested with a single rig for static ITS tests
and a sensor fusion rig if the camera has the <code>REALTIME</code> feature
flag.</p>

<p>A set of example configurations is provided in the table below.</p>

<table>
<tr>
<th>Example</th>
<th>Camera FoVs</th>
<th>REALTIME?</th>
<th>Recommended rigs</th>
<th>Notes</th>
</tr>
<tr>
<td>1</td>
<td>75&deg;</td>
<td>No</td>
<td>Rev 1</td>
<td>Android 7.0 or higher</td>
</tr>
<tr>
<td>2</td>
<td>75&deg;</td>
<td>Yes</td>
<td>Rev 1 + sensor fusion</td>
<td>Android 9 or higher</td>
</tr>
<tr>
<td>3</td>
<td>75&deg; + 95&deg;</td>
<td>Yes</td>
<td>Rev 2 + sensor fusion</td>
<td>Android 9 or higher</td>
</tr>
</table>

<h3 id="faq-2">Q2: How do I debug a single test?</h3>

<p>Tests can be run individually for debugging purposes, but the results aren't
reported to <code>CtsVerifier.apk</code> unless the entire scene is run. Results
are printed to the local screen and images are saved in the local directory
instead of the generated <code>/tmp/tmp###</code> directory when
running <code>tools/run_all_tests.py</code>.</p>

<p>To run an individual scene:</p>

<ol>
  <li>Load a scene by adding the <code>scenes</code> flag in
  <code>tools/run_all_tests.py</code>:
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=# camera=# chart=# scenes=#
</pre>
  <li>
  <p>Press <kbd><strong>Control+C</strong></kbd> to halt tests after the scene
    is logged as
    loaded to <code>stdout</code>.</p>
  <p>If the correct scene is already on the
    screen, wake up the screen:</p>
<pre class="devsite-terminal devsite-click-to-copy">
python tools/wake_up_screen.py screen=#
</pre>
  </li>
  <li>
    <p>Run an individual test.</p>
    <pre class="devsite-terminal devsite-click-to-copy">python tests/scene#/test_*.py device=# camera=#</pre>
    <p>Plots are then generated in the local directory and
    <code>stdout</code> and <code>stderr</code> are printed to the screen.</p>
    <p>To get more information for debugging, add <code>print</code>
      statements to the script. To increase the test output for debugging, add
      the <code>debug=True</code> flag.</p>
    <pre class="devsite-terminal devsite-click-to-copy">python tests/scene#/test_*.py device=# camera=# debug=True</pre>
  </li>
</ol>

<h3 id="faq-3">Q3: Why do I need to run failing tests as an entire scene instead
  of rerunning tests individually?</h3>

<p>Tests can be run individually for debugging purposes, but the results are not
reported to <code>CtsVerifier.apk</code> unless the entire scene is run.</p>

<p>Camera ITS ensures that third-party apps have a compatible camera interface.
Similar to a <em>unit test</em>, each test stresses a single specification in
the camera. To catch unreliable behavior, these tests are expected to
pass as a group for an entire scene. For example, although a single unreliable
test may pass a rerun of an entire scene, it would be difficult for multiple
unreliable tests to pass.</p>

<p>As an extreme example, consider the case where there are 10 tests in a scene
that each has a 50% probability of returning <code>PASS</code>. By running each
test individually, there's a high chance that an operator can get the camera to
pass Camera ITS. However, if the tests are run in the aggregate as a scene,
there's only a 0.1% chance that the scene will pass.</p>

<h3 id="faq-4">Q4: How do I run a single scene or reorder the run scenes?</h3>

<p>The script <code>tools/run_all_tests.py</code> runs all scenes in order by
default. However, scenes can be run individually or in a specified order and
be reported to <code>CtsVerifier.apk</code>.</p>

<p>To run an individual scene (for example scene2):</p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=# camera=# chart=# <strong>scenes=2</strong>
</pre>

<p>To run more than one scene in a specific order:</p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=# camera=# chart=# <strong>scenes=3,2</strong>
</pre>

<h3 id="faq-5">Q5: A number of scene 1 tests fail with the tablet setup but pass
  with a paper chart. What's wrong?</h3>

<p>Ensure that the tablet and test environment meet the following
specifications.</p>

<h4>Tablet specifications</h4>
<p>Make sure that the tablet meets the following specifications:</p>
<ul>
  <li>Display size (inches): 10"</li>
  <li>Display size (pixels): greater than 2000 x 1400 pixels</li>
</ul>
<p>For more details, see
  <a href="/compatibility/cts/camera-its-box#tablet-requirements">
    Tablet requirements</a>.
</p>

<h4>Tablet brightness</h4>
<p>Tests may not obtain correct results if the tablet display brightness is too
low. To increase the brightness on tablets running Android 7.0 and higher, run:</p>
<pre class="devsite-click-to-copy">
edit tools/wake_up_screen.py
DISPLAY_LEVEL=96 → DISPLAY_LEVEL=<strong>192</strong>
</pre>

<h4>Box lighting level (requires lux meter)</h4>
<p>Make sure that the target lux value at tablet opening is between 100 and
300.</p>
<p>
  If the lux level is too high, <code>scene1/test_param_flash_mode.py</code>
  returns <code>FAIL</code>. If the lux level is too low, multiple tests fail.
</p>

<h3 id="faq-6">Q6: Why do scenes have objects out of FoV with the WFoV
  ITS-in-a-box revision 2?</h3>

<p>The chart might not be scaled properly. Chart scaling works with Android 9 or
higher. Ensure that the chart distance input is correct for the version of the
test rig.</p>

<p><strong>WFoV ITS-in-a-box revision 2</strong></p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py ... chart=# <strong>dist=22</strong>
</pre>

<p><strong>RFoV ITS-in-a-box revision 1 (<code>dist=30</code> is the default)</strong></p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py ... chart=#
</pre>

<h3 id="faq-7">Q7: How do I debug sensor fusion tests?</h3>

<ol>
<li><p>Ensure that you're in a <code>dialout</code> group.</p>
<pre class="devsite-terminal devsite-click-to-copy">groups | egrep ‘dialout'</pre>
</li>
<li><p>Ensure that the sensor fusion controller is connected by determining if
Microchip Technology is connected to the USB port.</p>
<pre class="devsite-terminal devsite-click-to-copy">
lsusb
…
Bus 003 Device 004: ID 04d8:fc73 Microchip Technology, Inc.
…
</pre>
</li>
<li><p>Run the test multiple times to get a distribution of test attempts with
  the command:</p>
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_sensor_fusion_box.py device=A camera=0 num_runs=10 rotator=default
</pre>
<p>
Run outputs will be in the <code>/tmp/tmp###</code> folder created under
the <code>sensor_fusion_#</code> folders, where <code>#</code> is the run
number. Common reasons for failure are:
</p>
  <ol>
  <li>The phone isn't centered properly.</li>
  <li>Not enough features are found in the image (often a FoV or lighting issue).</li>
  <li>The returned <code>FAIL</code> is valid, and the timing offset between
    the camera and the gyroscope must be corrected.</li>
  </ol>
</li>
</ol>

<h3 id="faq-8">Q8: What information should I include when reporting a
  testing bug?</h3>

<p>
When reporting a testing bug, include the generated files and images
for the test.
</p>

<ol>
<li>If you ran the test through <code>tools/run_all_tests.py</code>, attach a
zipped <code>/tmp/tmp###</code> directory to the bug.</li>
<li>If you ran the test by itself, attach all of the screen outputs and
generated images to the bug.</li>
</ol>

<p>
You should also include a bug report. After the test in question fails, use the
following command to generate a bug report and attach the generated zip file to
the bug.
</p>

<pre class="devsite-terminal devsite-click-to-copy">
adb -s device_id bugreport
</pre>

</body>
</html>

