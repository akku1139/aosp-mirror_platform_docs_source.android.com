<html devsite>
  <head>
    <title>Protected Confirmation Implementation</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<aside class="key-point"><b>Key Point:</b> Protected Confirmation provides
a guarantee that the user has read and confirmed a transaction.
This guarantee relies on proper implementation. The considerations described
in this section help to ensure a secure implementation. Review the device
architecture with respect to these guarantees, even under the premise that
the bootloader may be unlocked and a custom Android image installed.</aside>

<h2 id="considerations">Considerations</h2>
<p>The following considerations must be addressed to ensure the integrity of
Android Protected Confirmation. If these considerations can't be satisfactorily
addressed, Protected Confirmation can't be implemented on the device.</p>

<h3 id="kernel-considerations">Linux kernel considerations</h3>
<p>Protected Confirmation is designed to operate securely even if the device's
kernel is compromised. While the Protected Confirmation dialog is active, the
kernel can't interfere with the integrity of the screen content, the integrity
of the user's input, and the atomicity between user input and output.
Architecturally, the kernel must be prevented from augmenting the user's
decision and from spoofing user events in the first place. The kernel isn't
considered trustworthy for this use case, as it could be under the control of an
attacker or replaced with something completely different.</p>

<h3 id="Firmware-considerations">Firmware considerations</h3>
<p>Protected Confirmation can be implemented on a device only if all of the
components involved have trusted firmware. Protected Confirmation is designed to
ensure that the user has a chance to read a message displayed in the Trusted UI
to make an informed decision whether or not to proceed with a transaction. The
display panel driver is especially important as this could prevent the user from
being able to view the Trusted UI.</p>

<h3 id="input-considerations">Input considerations</h3>
<p>Choose a secure input method to ensure that input events generated by this
chosen input method aren't conveyed to the Protected Confirmation dialog unless
the user generates the event while that dialog is active.</p>

<h4 id="physical-considerations">Physical hardware</h4>
<p>Any component that can be controlled by the Android kernel, such as the
system on chip (SoC) or power management integrated circuit (PMIC), must not be
able to drive a wire connected to a physical confirmation button.</p>

<h4 id="touch-considerations">Touch controller considerations</h4>
<p>Protected Confirmation can use on-screen software buttons as input. Anytime
the touch controller is being driven by the TEE, measures must be taken to
sanitize the touch controller's state.</p>

<aside class="note"><b>Note:</b> The availability of this feature isnâ€™t
guaranteed. That is, a compromised Android System or Android Kernel may
block the dialog. In this case, a confirmation token must not be issued.
</aside>

<h2 id="expected-behavior">Expected behavior</h2>

<h3 id="interruptions">Interruptions</h3>
<p>If the system interrupts the confirmation session because of an incoming
phone call or power event, the HAL must report
<code>ResponseCode::Aborted</code>. Apps get the <code>onCanceled()</code>
callback and know the user didn't choose an action. Alarms don't need to abort
the session but do need to notify the user. Notification overlays of any kind
aren't allowed while the dialog is active.</p>

<h3 id="grace-period">Input grace period</h3>
<p>After Protected Confirmation is initiated, the input needs to remain inactive
for a minimum of 1 second before it becomes responsive to user interaction. This
grace period ensures that the user has a chance to react to an unexpected
confirmation dialog. This grace period must be enforced by the trusted app.</p>

<h3 id="Screen-rotation">Screen rotation</h3>
<p>Portrait is the only mandated mode, and screen rotation isn't supported.
Screen rotation allows the potential for abuse on a compromised system, such as
misleading button placement or body text manipulation.</p>

<h3 id="rendering-failures">Body text rendering failures</h3>
<p>There's a <a
href="/reference/hidl/android/hardware/confirmationui/1.0/types#messagesize">hard
boundary of 6144 (0x1800) bytes</a> for the body text including extra
nondisplayed data and CBOR header information.
In addition, there's a soft boundary that must be enforced. If the
rendered message doesn't completely fit in the available screen space,
ensure that Protected Confirmation aborts and the transaction is canceled.
If <code>MessageSize</code> exceeds the maximum allowable size, your
implementation must return <code>UIErrorMessageTooLong</code> on
<code>promptUserConfirmation</code>.</p>

<p>Best practice is to format the body text after receiving the API call. The
body text must be shown to the user in full.</p>

<h3 id="secondary-displays">Secondary Displays</h3>
<p>Secondary displays are supported under certain conditions. The integrity of
output and user input must be maintained, and no misleading information can be
displayed through other means. Otherwise, the dialog may only be displayed on
the primary display and all other displays should be deactivated or blank.
Streaming and screen-sharing solutions aren't allowed to display the dialog or
generate confirmations.</p>

  </body>
</html>
