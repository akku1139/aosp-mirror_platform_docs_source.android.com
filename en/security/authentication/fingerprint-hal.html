<html devsite>
  <head>
    <title>Fingerprint HIDL</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>On devices with a fingerprint sensor, users can enroll one or more
fingerprints and use those fingerprints to unlock the device and perform other
tasks. Android uses the Fingerprint Hardware Interface Definition Language
(HIDL) to connect to a vendor-specific library and fingerprint hardware (for
example, a fingerprint sensor).</p>

<p>To implement the Fingerprint HIDL, you must implement <a
href="https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/biometrics/fingerprint/2.1/IBiometricsFingerprint.hal"
class="external"><code>IBiometricsFingerprint.hal</code></a>
in a vendor-specific library.</p>

<h2 id="fingerprint_matching">Fingerprint matching</h2>

<p>The fingerprint sensor of a device is generally idle. However, in response to
a call to <code>authenticate</code> or <code>enroll</code>, the
fingerprint sensor listens for a touch (the screen might also wake when a user
touches the fingerprint sensor). The high-level flow of fingerprint matching
includes the following steps:</p>

<ol>
  <li>User places a finger on the fingerprint sensor.</li>
  <li>The vendor-specific library determines if there is a fingerprint match in
    the current set of enrolled fingerprint templates.</li>
  <li>Matching results are passed to <code>FingerprintService</code>.</li>
</ol>

<p>This flow assumes that a fingerprint has already been enrolled on the device, that is,
the vendor-specific library has enrolled a template for the fingerprint. For more
details, see <a
href="/security/authentication/index.html">Authentication</a>.</p>

<aside class="note"><strong>Note:</strong> The more fingerprint templates stored
on a device, the more time required for fingerprint matching.</aside>

<h2 id="architecture">Architecture</h2>

<p>The Fingerprint HAL interacts with the following components.</p>

<ul>
  <li><code>BiometricManager</code> interacts directly with an app in an app process.
    Each app has an instance of <code>IBiometricsFingerprint.hal</code></li>
  <li><code>FingerprintService</code> operates in the
    system process, which handles communication with fingerprint HAL.</li>
  <li><strong>Fingerprint HAL</strong> is a C/C++ implementation of the
    IBiometricsFingerprint HIDL interface. This contains the vendor-specific library
    that communicates with the device-specific hardware.</li>
  <li><strong>Keystore API and Keymaster</strong> components provide
    hardware-backed cryptography for secure key storage in a secure environment,
    such as the Trusted Execution Environment (TEE).</li>
</ul>

<img src="../images/fingerprint-data-flow.png" alt="Data flow for fingerprint
authentication" id="figure1" />
<figcaption><strong>Figure 1.</strong> High-level data flow for fingerprint
authentication</figcaption>

<p>A vendor-specific HAL implementation must use the communication protocol
required by a TEE. Raw images and processed fingerprint features must not
be passed in untrusted memory. All such biometric data needs to be stored
in the secure hardware such as the TEE. Rooting <strong>must not</strong>
be able to compromise biometric data.</p>

<p><code>FingerprintService</code> and <code>fingerprintd</code> make calls through the Fingerprint HAL to
the vendor-specific library to enroll fingerprints and perform other
operations.</p>

<img src="../images/fingerprint-daemon.png" alt="Interaction with fingerprintd"
id="figure2" />
<figcaption><strong>Figure 2.</strong> Interaction of the fingerprint daemon
  with the fingerprint vendor-specific library</figcaption>

<h2 id="implementation">Implementation guidelines</h2>

<p>The following Fingerprint HAL guidelines are designed to ensure that
fingerprint data is <strong>not leaked</strong> and is <strong>removed</strong>
when a user is removed from a device:</p>

<ul>
  <li>Raw fingerprint data or derivatives (for example, templates) must never
    be accessible from outside the sensor driver or TEE. If the hardware supports
    a TEE, hardware access must be limited to the TEE and protected by an SELinux
    policy. The Serial Peripheral Interface (SPI) channel must be accessible only to
    the TEE and there must be an explicit SELinux policy on all device files.</li>
  <li>Fingerprint acquisition, enrollment, and recognition must occur inside the TEE.
  </li>
  <li>Only the encrypted form of the fingerprint data can be stored on the file
    system, even if the file system itself is encrypted.
  </li>
  <li>Fingerprint templates must be signed with a private, device-specific key.
    For Advanced Encryption Standard (AES), at a minimum a template must be signed
    with the absolute file-system path, group, and finger ID such that template
    files are inoperable on another device or for anyone other than the user that
    enrolled them on the same device. For example, copying fingerprint data from a
    different user on the same device or from another device must not work.
  </li>
  <li>Implementations must either use the file-system path provided by the
    <code>setActiveGroup()</code> function or provide a way to erase all user
    template data when the user is removed. It's strongly recommended that
    fingerprint template files be stored as encrypted and stored in the path provided. If this
    is infeasible due to TEE storage requirements, the implementer must add hooks to
    ensure removal of the data when the user is removed.
  </li>
</ul>

<h2 id="methods">Fingerprint methods</h2>

<p>The Fingerprint HIDL interface contains the following major methods in
<a
href="https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/biometrics/fingerprint/2.1/IBiometricsFingerprint.hal"
class="external"><code>IBiometricsFingerprint.hal</code></a>.</p>

<table>
  <thead>
  <tr>
    <th>Method</th>
    <th>Description</th>
  </tr>
  </thead>
<tbody>
  <tr>
    <td><code>enroll()</code></td>
    <td>Switches the HAL state machine to start the
    collection and storage of a fingerprint template. When enrollment is complete,
    or after a timeout, the HAL state machine returns to the idle state.</td>
  </tr>
  <tr>
    <td><code>preEnroll()</code></td>
    <td>Generates a unique token to indicate the start of a
    fingerprint enrollment. Provides a token to the <code>enroll</code> function to
    ensure there was prior authentication, for example, using a password. To prevent
    tampering, the token is wrapped after the device
    credential is confirmed. The token must be checked during enrollment to verify
    that it's still valid.</td>
  </tr>
  <tr>
    <td><code>getAuthenticatorId()</code></td>
    <td>Returns a token associated with the
    current fingerprint set.</td>
  </tr>
  <tr>
    <td><code>cancel()</code></td>
    <td>Cancels pending enroll or authenticate operations. The
    HAL state machine is returned to the idle state.</td>
  </tr>
  <tr>
    <td><code>enumerate()</code></td>
    <td>Synchronous call for enumerating all known
    fingerprint templates.</td>
  </tr>
  <tr>
    <td><code>remove()</code></td>
    <td>Deletes a fingerprint template.</td>
  </tr>
  <tr>
    <td><code>enumerate()</code></td>
    <td>Enumerates all face templates associated with the active user.</td>
  </tr>
  <tr>
    <td><code>remove()</code></td>
    <td>Removes a face template or all face templates associated with the active
    user.</td>
  </tr>
  <tr>
    <td><code>setActiveGroup()</code></td>
    <td>Restricts a HAL operation to a set of
    fingerprints that belong to a specified group, identified by a group identifier
    (GID).</td>
  </tr>
  <tr>
    <td><code>authenticate()</code></td>
    <td>Authenticates a fingerprint-related operation
    (identified by an operation ID).</td>
  </tr>
  <tr>
    <td><code>setNotify()</code></td>
    <td>Registers a user function that receives
    notifications from the HAL. If the HAL state machine is in a busy state, the
    function is blocked until the HAL leaves the busy state.</td>
  </tr>
  <tr>
    <td><code>postEnroll()</code></td>
    <td>Finishes the enroll operation and invalidates the
    <code>preEnroll()</code> generated challenge. This must be called at the end of a
    multifinger enrollment session to indicate that no more fingers may be added.</td>
  </tr>
</tbody>
</table>

<p>For more details on these, refer to the comments in <a
href="https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/biometrics/fingerprint/2.1/IBiometricsFingerprint.hal"
class="external"><code>IBiometricsFingerprint.hal</code></a>.</p>

  </body>
</html>
