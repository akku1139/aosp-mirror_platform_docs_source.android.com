<html devsite>
<head>
  <title>Boot Image Header Versioning</title>
  <meta name="project_path" value="/_project.yaml">
  <meta name="book_path" value="/_book.yaml">
</head>
{% include "_versions.html" %}
<body>
  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->


  <p>Starting in Android {{ androidPVersionNumber }}, the boot image header contains
  a field to indicate the header version. The bootloader must check this header
  version field and parse the header accordingly. Versioning the boot image header
  allows future modifications to the header while maintaining backward compatibility.</p>


  <p>All devices launching with Android {{ androidPVersionNumber }} must use boot header
  version 1.</p>


  <h2 id="boot-image-header-changes">Boot image header changes</h2>


  <p>In the legacy boot image header (shown below), the <code>unused</code>
  field is converted to a header version field for devices launching with
  Android {{ androidPVersionNumber }}.</p>

  <pre class="prettyprint">struct boot_img_hdr
{
    uint8_t magic[BOOT_MAGIC_SIZE];
    uint32_t kernel_size;  /* size in bytes */
    uint32_t kernel_addr;  /* physical load addr */

    uint32_t ramdisk_size; /* size in bytes */
    uint32_t ramdisk_addr; /* physical load addr */

    uint32_t second_size;  /* size in bytes */
    uint32_t second_addr;  /* physical load addr */

    uint32_t tags_addr;    /* physical addr for kernel tags */
    uint32_t page_size;    /* flash page size we assume */
    uint32_t unused;
    uint32_t os_version;
    uint8_t name[BOOT_NAME_SIZE]; /* asciiz product name */
    uint8_t cmdline[BOOT_ARGS_SIZE];
    uint32_t id[8]; /* timestamp / checksum / sha1 / etc */
    uint8_t extra_cmdline[BOOT_EXTRA_ARGS_SIZE];
};</pre>

  <p>Devices launched before Android {{ androidPVersionNumber }} using the legacy boot
  image header are considered as using a boot image header version 0. All devices
  launching with Android {{ androidPVersionNumber }} must use the following structure
  for the boot image header with the header version set to 1.</p>

  <pre class="prettyprint">struct boot_img_hdr
{
    uint8_t magic[BOOT_MAGIC_SIZE];
    uint32_t kernel_size;  /* size in bytes */
    uint32_t kernel_addr;  /* physical load addr */

    uint32_t ramdisk_size; /* size in bytes */
    uint32_t ramdisk_addr; /* physical load addr */

    uint32_t second_size;  /* size in bytes */
    uint32_t second_addr;  /* physical load addr */

    uint32_t tags_addr;    /* physical addr for kernel tags */
    uint32_t page_size;    /* flash page size we assume */
    uint32_t header_version;
    uint32_t os_version;
    uint8_t name[BOOT_NAME_SIZE]; /* asciiz product name */
    uint8_t cmdline[BOOT_ARGS_SIZE];
    uint32_t id[8]; /* timestamp / checksum / sha1 / etc */
    uint8_t extra_cmdline[BOOT_EXTRA_ARGS_SIZE];
    uint32_t recovery_dtbo_size;   /* size of recovery dtbo image */
    uint64_t recovery_dtbo_offset; /* offset in boot image */
    uint32_t header_size;   /* size of boot image header in bytes */
};</pre>

  <p>The <code>header_size</code> field contains the size of the boot image
  header. If the boot image header version is set to 1, the <code>id</code> field contains
  the SHA-1 digest for the <code>recovery_dtbo</code> section of the boot image
  in addition to the <code>kernel</code>, <code>ramdisk</code>,
  and <code>second sections</code>. For details on the
  <code>recovery_dtbo_size</code> and <code>recovery_dtbo_offset</code> fields,
  refer to <em><a href="/devices/bootloader/recovery-image">Including
  DTBO in Recovery for Non-A/B Devices</a></em>.</p>


  <h2 id="implementation">Implementation</h2>


  <p>The <code>mkbootimg</code> tool that creates boot images adds the
  following arguments to support the new boot image header.</p>


  <table>
    <tr>
      <th>Argument</th>
      <th>Description</th>
    </tr>


    <tr>
      <td><code>header_version</code>
      </td>

      <td>Sets the boot image header version.</td>
    </tr>


    <tr>
      <td><code>recovery_dtbo</code>
      </td>

      <td>Path to the recovery DTBO image to be included in the recovery
      image.</td>
    </tr>
  </table>


  <p>The device <code>BoardConfig.mk</code> uses the config
  <code>BOARD_MKBOOTIMG_ARGS</code> to add <code>header version</code> to the
  other board-specific arguments of <code>mkbootimg</code>. For example:</p>

  <pre class="prettyprint">
  BOARD_MKBOOTIMG_ARGS := --ramdisk_offset $(BOARD_RAMDISK_OFFSET) --tags_offset $(BOARD_KERNEL_TAGS_OFFSET) --header_version $(BOARD_BOOTIMG_HEADER_VERSION)</pre>

<p>The Android build system uses the <code>BoardConfig</code> variable
  <code>BOARD_PREBUILT_DTBOIMAGE</code> to set the argument
  <code>recovery_dtbo</code> of the <code>mkbootimg</code> tool during the creation
  of the recovery image.</p>


  <p>For details on the Android Open Source Project (AOSP) changes, review the
  <a href="https://android-review.googlesource.com/q/topic:%22recovery_dtbo%22+(status:open%20OR%20status:merged)" class="external">
  associated changelists for boot image header versioning</a>.</p>


  <h2 id="validation">Validation</h2>


  <p>For all devices launching with Android {{ androidPVersionNumber }}, the
  <a href="/compatibility/vts/">Vendor Test Suite (VTS)</a>
  checks the format of the boot/recovery image to ensure that the boot image header
  uses version 1.</p>

<h2 id="including-dtb">Including DTB in the boot image</h2>

<p>
Android {{ androidQVersionNumber }} updates the boot image header to version 2,
which includes a section to store the device tree blob (DTB) image.
Android {{ androidQVersionNumber }} VTS tests verify that all devices launching with
Android {{ androidQVersionNumber }} use boot image header version 2 and include a valid
DTB image as part of the boot/recovery images.
</p>

<h2 id="about-dtb">About DTB</h2>


<p>
In Android {{ androidPVersionNumber }} and earlier releases, the DTB image was
either placed in its own partition or appended to the kernel <code>image.gz</code> to
create the kernel + DTB image (which is then passed to <code>mkbootimg</code> to
create <code>boot.img</code>). In Android {{ androidQVersionNumber }},
the boot image format is further updated with a section for DTB images.
This change means that Android doesn't need to support scripts that append the DTB image
to <code>image.gz</code> in the kernel and enables the use of VTS tests to verify
(and standardize) DTB placement.
</p>
<p>
In addition, for non-A/B devices, it's safer to have the DTB as part of the recovery
image rather than in a separate partition to prevent issues caused by interrupted OTAs.
During an OTA, if a problem occurs after the DTB partition is updated
(but prior to completing the full update), the device tries to boot
into recovery mode to complete the OTA. However, because the DTB partition
has already been updated, a mismatch could occur with the recovery image
(which has not yet been updated). Having the DTB image as part of the boot
image format prevents such issues by making the recovery image self
sufficient (that is, it doesn't depend on another partition).
</p>

<h2 id="boot-image-header-version-2">Boot image header version 2</h2>


<p>
Boot image header version 2 is defined as shown below with fields representing the
size of the DTB image and its physical load address.
</p>



<pre class="prettyprint">struct boot_img_hdr
{
    uint8_t magic[BOOT_MAGIC_SIZE];
    uint32_t kernel_size;  /* size in bytes */
    uint32_t kernel_addr;  /* physical load addr */

    uint32_t ramdisk_size; /* size in bytes */
    uint32_t ramdisk_addr; /* physical load addr */

    uint32_t second_size;  /* size in bytes */
    uint32_t second_addr;  /* physical load addr */

    uint32_t tags_addr;    /* physical addr for kernel tags */
    uint32_t page_size;    /* flash page size we assume */
    uint32_t header_version;
    uint32_t os_version;
    uint8_t name[BOOT_NAME_SIZE]; /* asciiz product name */
    uint8_t cmdline[BOOT_ARGS_SIZE];
    uint32_t id[8]; /* timestamp / checksum / sha1 / etc */
    uint8_t extra_cmdline[BOOT_EXTRA_ARGS_SIZE];
    uint32_t recovery_dtbo_size;   /* size of recovery dtbo image */
    uint64_t recovery_dtbo_offset; /* offset in boot image */
    uint32_t header_size;   /* size of boot image header in bytes */
    uint32_t dtb_size;   /* size of dtb image */
    uint64_t dtb_addr; /* physical load address */
};</pre>


<p>
To allow the inclusion of the DTB image, update the boot image format as follows.
</p>

<table>
  <tr>
   <th>Boot image format</th>
   <th>Number of pages</th>
  </tr>
  <tr>
   <td>Boot header (1 page)
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Kernel (l pages)
   </td>
   <td>l = (<code>kernel_size</code> + <code>page_size</code> - 1) / <code>page_size</code>
   </td>
  </tr>
  <tr>
   <td>Ramdisk (m pages)
   </td>
   <td>m = (<code>ramdisk_size</code> + <code>page_size</code> - 1) / <code>page_size</code>
   </td>
  </tr>
  <tr>
   <td>Second stage bootloader (n pages)
   </td>
   <td>n = (<code>second_size</code> + <code>page_size</code> - 1) / <code>page_size</code>
   </td>
  </tr>
  <tr>
   <td>Recovery DTBO (o pages)
   </td>
   <td>o = (<code>recovery_dtbo_size</code> + <code>page_size</code> - 1) / <code>page_size</code>
   </td>
  </tr>
  <tr>
   <td>DTB (p pages)
   </td>
   <td>p = (<code>dtb_size</code> + <code>page_size</code> - 1) / <code>page_size</code>
   </td>
  </tr>
</table>



<p>
The DTB image must use one of the following formats:
</p><ul>

<li><strong>DT blobs concatenated one after the other.</strong> Bootloader
uses the <code>totalsize</code> field in each FDT header to read and parse the corresponding blob.
<li><strong><a href="/devices/architecture/dto/partitions#structures">DTB/DTBO
partitions structure</a>.</strong> Bootloader has an efficient way to select the correct DT blob by
examining the <code>dt_table_entry</code> struct (contains <code>id</code>,
<code>rev</code>, and <code>custom</code> fields) that can hold hardware identifying
information for the entry.</li></ul>

<p>
Android {{ androidQVersionNumber }} modifies <code>mkbootimg.py</code> to support the
following arguments.
</p>

<table>
  <tr>
   <th>Argument</th>
   <th>Description</th>
  </tr>
  <tr>
   <td>dtb
   </td>
   <td>Path to the DTB image to be included in the boot/recovery images.
   </td>
  </tr>
  <tr>
   <td>dtb_offset
   </td>
   <td>When added to the <code>base</code> argument, provides the physical load address for
   the final device tree. For example, if the <code>base</code> argument is<code>
   0x10000000</code> and the <code>dtb_offset</code> argument is <code>0x01000000</code>,
   the <code>dtb_addr_field</code> in the boot image header is populated as <code>0x11000000</code>.
   </td>
  </tr>
</table>


<p>
The board config variable <code>BOARD_PREBUILT_DTBIMAGE_DIR</code> must be used to specify
the path to the DTB image. If more than one file with extension <code>*.dtb</code> is
present in the directory <code>BOARD_PREBUILT_DTBIMAGE_DIR</code>, the Android build
system concatenates the files to create the final DTB image used in the boot image creation.
</p>
<p>
The board config variable <code>BOARD_INCLUDE_DTB_IN_BOOTIMG</code> must be set to true.
</p>



<pre class="prettyprint">BOARD_INCLUDE_DTB_IN_BOOTIMG := true</pre>

<p>
This causes the argument <code>dtb</code> to be passed to <code>mkbootimg.py</code> with the DTB image
from the directory specified by <code>BOARD_PREBUILT_DTBIMAGE_DIR</code>.
</p>
<p>
The <code>dtb_offset</code> argument can be appended to the board config variable
<code>BOARD_MKBOOTIMG_ARGS</code> along with the other offsets and header version.
</p>



<pre class="prettyprint">BOARD_MKBOOTIMG_ARGS := --ramdisk_offset $(BOARD_RAMDISK_OFFSET) --dtb_offset $(BOARD_DTB_OFFSET) --tags_offset $(BOARD_KERNEL_TAGS_OFFSET) --header_version $(BOARD_BOOTIMG_HEADER_VERSION)</pre>


<p>
Bootloader must support the updated boot image and must add a new kernel command line
parameter <code>androidboot.dtb_idx</code> to indicate the index of
the selected DT to facilitate VTS verification. <strong>You can only specify one (1) index.</strong>
For example, the parameter <code>androidboot.dtb_idx=N</code>
reports <code><em>N</em></code> as the zero-based index of the device tree selected by
the bootloader from the set of DT blobs present in the boot image.

</body>
</html>
