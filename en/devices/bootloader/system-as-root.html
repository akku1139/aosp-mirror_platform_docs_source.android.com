<html devsite>
<head>
  <title>Partition Layout</title>
  <meta name="project_path" value="/_project.yaml">
  <meta name="book_path" value="/_book.yaml">
</head>
{% include "_versions.html" %}
<body>
  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->


<p>
  In Android {{ androidQVersionNumber }}, the root file system is no longer
  included in <code>ramdisk.img</code> and is instead merged into
  <code>system.img</code> (that is, <code>system.img</code> is always created as
  if <code>BOARD_BUILD_SYSTEM_ROOT_IMAGE</code> was set). Devices
  launching with Android {{ androidQVersionNumber }}:
</p>
<ul>
  <li>Use a system-as-root partition layout (automatically enforced by the
  build with no options to change the behavior).</li>
  <li>Must use a ramdisk, which is required for dm-linear.</li>
  <li>Must set <code>BOARD_BUILD_SYSTEM_ROOT_IMAGE</code> to <code>false</code>.
  This setting is used only to differentiate between devices that use a ramdisk
  and devices that don't use a ramdisk (and instead mount
  <code>system.img</code> directly).</li>
</ul>

<p>
  The meaning of a system-as-root configuration differs between Android 9 and
  Android {{ androidQVersionNumber }}. In an Android 9 system-as-root
  configuration, <code>BOARD_BUILD_SYSTEM_ROOT_IMAGE</code> is set to
  <code>true</code>, which forces the build to merge the root file system into
  <code>system.img</code> then mount <code>system.img</code> as the root file
  system (rootfs). This configuration is <em>mandatory</em> for devices
  launching with Android 9 but is <em>optional</em> for devices upgrading to
  Android 9 and for devices running lower versions of Android. In an Android
  {{ androidQVersionNumber }} system-as-root configuration, the build always
  merges <code>$TARGET_SYSTEM_OUT</code> and <code>$TARGET_ROOT_OUT</code> into
  <code>system.img</code>; this config is the default behavior for all devices
  running Android {{ androidQVersionNumber }}.
</p>

<p>
  Android {{ androidQVersionNumber }} makes further changes to support
  <a href="/devices/tech/ota/dynamic_partitions">dynamic partitions</a>,
  a userspace partitioning system that enables over-the-air (OTA) updates to
  create, resize, or destroy partitions. As part of this change, the Linux
  kernel can no longer mount the logical system partition on devices running
  Android {{ androidQVersionNumber }}, so this operation is handled by the first
  stage init.
</p>

<p>
  The following sections describe the system-as-root requirements for
  system-only OTAs, provide guidance on updating devices to use system-as-root
  (including partition layout changes and dm-verity kernel requirements, and
  detail <a href="#ramdisk">changes to ramdisk</a> in Android
  {{ androidQVersionNumber }}.
</p>

<h2 id="about-system-only-otas">About system-only OTAs</h2>

<p>
  System-only OTAs, which enable Android releases to update
  <code>system.img</code> without changing other partitions, require a
  system-as-root partition layout. All devices running Android
  {{ androidQVersionNumber }} must use a system-as-root partition layout to
  enable system-only OTAs.
</p>

<ul>
  <li>A/B devices, which mount the <code>system</code> partition as rootfs,
  already use system-as-root and don't require changes to support system OTAs.
  </li>
  <li>Non-A/B devices, which mount the <code>system</code> partition at
  <code>/system</code>, must be updated to use a system-as-root partition layout
  to support system OTAs.</li>
</ul>

<p>
  For details on A/B and non-A/B devices, refer to
  <a href="/devices/tech/ota/ab/index">A/B (Seamless) System Updates</a>.
</p>

<h2 id="about-system-as-root">Updating to system-as-root</h2>

<p>
  To update non-A/B devices to use system-as-root, you must update the
  partioning scheme for <code>boot.img</code> and <code>system.img</code>, set
  up dm-verity, and remove any boot dependencies on the device-specific root
  folders.
</p>

<h3 id="sar-partitioning">Updating partitions</h3>

<p>
  Unlike A/B devices that repurpose <code>/boot</code> as the
  <a href="/devices/tech/ota/ab/ab_implement#recovery">recovery</a> partition,
  <strong>non-A/B devices must keep the <code>/recovery</code> partition
  separate as they don't have the fallback slot partition</strong> (for example,
  from <code>boot_a</code> → <code>boot_b</code>). If <code>/recovery</code> is
  removed on non-A/B device and made similar to the A/B scheme, recovery mode
  could break during a failed update to the <code>/boot</code> partition. For
  this reason, the <code>/recovery</code> partition <strong>must</strong> be a
  separate partition from <code>/boot</code> for non-A/B devices, which implies
  that the recovery image will continue to be updated in a deferred manner (that
  is, the same as in pre-{{ androidPVersionNumber }} devices).
</p>

<p>
  The following table lists image partition differences for non-A/B devices
  before and after Android {{ androidPVersionNumber }}.
</p>

<table>
  <tr>
    <th>Image</th>
    <th>ramdisk (before {{ androidPVersionNumber }})</th>
    <th>system-as-root (after {{ androidPVersionNumber }})</th>
  </tr>
  <tr>
  <td><code>boot.img</code></td>
    <td>Contains a kernel and a <code>ramdisk.img</code>:
    <pre class="prettyprint">ramdisk.img
  -/
    - init.rc
    - init
    - etc -&gt; /system/etc
    - system/ (mount point)
    - vendor/ (mount point)
    - odm/ (mount point)
    ...</pre>
    </td>
    <td>Contains a normal boot kernel only.</td>
  </tr>
  <tr>
  <td><code>recovery.img</code></td>
    <td colspan="2">Contains a recovery kernel and a recovery
    <code>ramdisk.img</code>.</td>
  </tr>
  <tr>
  <td><code>system.img</code></td>
    <td>Contains the following:
    <pre class="prettyprint">system.img
  -/
    - bin/
    - etc
    - vendor -&gt; /vendor
    - ...</pre>
    </td>
    <td>Contains the merged content of original <code>system.img</code> and
    <code>ramdisk.img</code>:
    <pre class="prettyprint">system.img
  -/
    - init.rc
    - init
    - etc -&gt; /system/etc
    - system/
      - bin/
      - etc/
      - vendor -&gt; /vendor
      - ...
    - vendor/ (mount point)
    - odm/ (mount point)
    ...</pre>
    </td>
  </tr>
</table>

<p>
  The partitions themselves don't change; both ramdisk and system-as-root use
  the following partition scheme:
</p>

<ul>
  <li>/boot</li>
  <li>/system</li>
  <li>/recovery</li>
  <li>/vendor, … etc.</li>
</ul>

<h3 id="setting-up-dm-verity">Setting up dm-verity</h3>

<p>
  In system-as-root, the kernel must mount <code>system.img</code> under
  <strong><code>/</code></strong> (mount point) with
  <a href="https://www.kernel.org/doc/Documentation/device-mapper/verity.txt"
  class="external">dm-verity</a>. AOSP supports the following dm-verity
  implementations for <code>system.img</code>.
</p>

<h4 id="vboot1">vboot 1.0</h4>

<p>
  For <a href="/security/verifiedboot/">vboot 1.0</a>, the kernel must parse
  Android-specific
  <a href="/security/verifiedboot/dm-verity#metadata">metadata</a> on
  <code>/system</code>, then convert to
  <a href="https://www.kernel.org/doc/Documentation/device-mapper/verity.txt"
  class="external">dm-verity params</a> to set up dm-verity (requires
  <a href="/devices/tech/ota/ab/ab_implement#kernel">these kernel patches</a>).
  The following example shows dm-verity related settings for system-as-root in
  kernel command line:
</p>

<pre class="prettyprint">ro root=/dev/dm-0 rootwait skip_initramfs init=/init
dm="system none ro,0 1 android-verity /dev/sda34"
veritykeyid=id:7e4333f9bba00adfe0ede979e28ed1920492b40f</pre>

<h4 id="vboot2">vboot 2.0</h4>

<p>
  For vboot 2.0
  (<a href="https://android.googlesource.com/platform/external/avb/"
  class="external">AVB</a>), the bootloader must integrate
  <a href="https://android.googlesource.com/platform/external/avb/+/master/libavb/"
  class="external">external/avb/libavb</a>, which then parses the
  <a href="https://android.googlesource.com/platform/external/avb/+/master/libavb/avb_hashtree_descriptor.h"
  class="external"> hashtree descriptor</a> for <code>/system</code>, converts
  it to
  <a href="https://www.kernel.org/doc/Documentation/device-mapper/verity.txt"
  class="external">dm-verity params</a>, and finally passes the params to the
  kernel via kernel command line. (Hashtree descriptors of <code>/system</code>
  might be on <code>/vbmeta</code> or on <code>/system</code> itself.)
</p>

<p>
  vboot 2.0 requires the following kernel patches:
</p>

<ul>
  <li><a href="https://android-review.googlesource.com/#/c/kernel/common/+/158491/"
  class="external">https://android-review.googlesource.com/#/c/kernel/common/+/158491/</a>
  </li>
  <li>
  <a href="https://android-review.googlesource.com/q/hashtag:avb-kernel-patch-4.4"
  class="external">kernel 4.4 patches</a>,
  <a href="https://android-review.googlesource.com/q/hashtag:avb-kernel-patch-4.9"
  class="external">kernel 4.9 patches</a>, etc.
  </li>
</ul>

<aside class="note"><strong>Note:</strong> AVB-specific kernel patch files are
  also available on
  <a href="https://android.googlesource.com/platform/external/avb/+/master/contrib/linux/"
  class="external">external/avb/contrib/linux/</a>.
</aside>

<p>
  The following example shows dm-verity related settings for system-as-root in
  kernel command line:
</p>

<pre class="prettyprint">
ro root=/dev/dm-0 rootwait  skip_initramfs init=/init

dm="1 vroot none ro 1,0 5159992 verity 1
PARTUUID=00000016-0000-0000-0000-000000000000
PARTUUID=00000016-0000-0000-0000-000000000000 4096 4096 644999 644999
sha1 d80b4a8be3b58a8ab86fad1b498640892d4843a2
8d08feed2f55c418fb63447fec0d32b1b107e42c 10 restart_on_corruption
ignore_zero_blocks use_fec_from_device
PARTUUID=00000016-0000-0000-0000-000000000000 fec_roots 2 fec_blocks
650080 fec_start 650080"
</pre>

<h3 id="device-specific-folders">Using device-specific root folders</h3>

<p>
  With system-as-root, after the <a href="/setup/build/gsi">generic system image
  (GSI)</a> is flashed on the device (and before running
  <a href="/compatibility/vts/">Vendor Test Suite</a> tests), any
  device-specific root folders added with <code>BOARD_ROOT_EXTRA_FOLDERS</code>
  will be gone because the entire root directory content has been replaced by
  the system-as-root GSI. The removal of these folders might cause the device to
  become unbootable if a dependency on the device-specific root folders exists
  (for example, they're used as mount points).
</p>

<p>
  To avoid this issue, don't use <code>BOARD_ROOT_EXTRA_FOLDERS</code> to
  add device-specific root folders. If you need to specify device-specific mount
  points, use <code>/mnt/vendor/&lt;mount point&gt;</code> (added in these
  <a href="https://android-review.googlesource.com/q/topic:vmount"
  class="external">changelists</a>). These vendor-specific mount points can be
  directly specified in both the <code>fstab</code> device tree (for first-stage
  mount) and the <code>/vendor/etc/fstab.{ro.hardware}</code> file without
  additional setup (as <code>fs_mgr</code> creates them under
  <code>/mnt/vendor/*</code> automatically).
</p>

<h2 id=ramdisk>Ramdisk</h2>

<p>
  In Android {{ androidQVersionNumber }}, the first stage ramdisk contains the
  first stage init binary (which performs early mounting as specified by fstab
  entries) and vendor fstab files. (As in Android 9, <code>system.img</code>
  contains the contents of <code>$TARGET_ROOT_OUT</code>.)
</p>

<ul>
  <li>For devices with a boot-ramdisk (non-A/B), first stage init is a static
  executable located at <code>/init</code>. These devices mount
  <code>system.img</code> as <code>/system</code>, then perform a switch root
  operation to move the mount at <code>/system</code> to <code>/</code>. The
  contents of the ramdisk are freed after mounting has completed.
  </li>
  <li>For devices that use recovery as a ramdisk, first stage init is located at
  <code>/init</code> within the recovery ramdisk. These devices first switch
  root to <code>/first_stage_ramdisk</code> to remove the recovery components
  from the environment, then proceed the same as devices with a boot-ramdisk
  (that is, mount <code>system.img</code> as <code>/system</code>, switch root
  to move that mount to <code>/</code>, and free ramdisk contents after
  mounting). If <code>androidboot.force_normal_boot=1</code> is present in the
  kernel command line, devices boot normally (into Android) instead of booting
  into recovery mode.</li>
</ul>

<p>
  After first stage init finishes, it executes <code>/system/bin/init</code>
  with the <code>selinux_setup</code> argument to compile and load SELinux onto
  the system. Finally, init executes <code>/system/bin/init</code> again with
  the <code>second_stage</code> argument. At this point, the main phase of init
  runs and continues the boot process using the <code>init.rc</code> scripts.
</p>

<aside class="caution"><strong>Caution:</strong>
  Android {{ androidQVersionNumber }} replaces ramdisk contents with a first
  stage init executable, which is incompatible with how previous ramdisks booted
  the system.
</aside>

<h3 id="partition-layouts-nonabdevices">Partition layouts (non-A/B devices)</h3>

<p>
  The following sections detail differences in partition layouts for non-A/B
  devices before and after Android {{ androidQVersionNumber }}.
</p>

<h4 id="boot-img">boot.img</h4>

<table>
  <tr>
    <th>Ramdisk<br><em>(Android 8.x and lower)</em></th>
    <th>System as root<br><em>(Android 9)</em></th>
    <th>Ramdisk<br><em>(Android {{ androidQVersionNumber }})</em></th>
  </tr>
  <tr>
   <td>Contains a kernel and a <code>ramdisk.img</code>.<br><br>
   <pre>
ramdisk.img
  -/
    - init.rc
    - init
    - etc -> /system/etc
    - system/ (mount point)
    - vendor/ (mount point)
    - odm/ (mount point)
    ...
    </pre>
   </td>
   <td>Contains a normal boot kernel only.</td>
   <td>Contains a kernel and <code>ramdisk.img</code>.<br><br>
   <pre>
ramdisk.img
  -/
    - init
    - vendor fstab files
    - system/ (mount point)
    - vendor/ (mount point)
    - odm/ (mount point)
    ...
    </pre>
   </td>
  </tr>
</table>

<h4 id="recovery-img">recovery.img</h4>

<table>
  <tr>
    <th>Ramdisk<br><em>(Android 8.x and lower)</em></th>
    <th>System as root<br><em>(Android 9)</em></th>
    <th>Ramdisk<br><em>(Android {{ androidQVersionNumber }})</em></th>
  </tr>
  <tr>
   <td colspan="3" style="text-align: center">Contains a recovery kernel and a
   recovery <code>ramdisk.img</code>.</td>
  </tr>
</table>

<h4 id="system-img">system.img</h4>

<table>
  <tr>
    <th>Ramdisk<br><em>(Android 8.x and lower)</em></th>
    <th>System as root<br><em>(Android 9)</em></th>
    <th>Ramdisk<br><em>(Android {{ androidQVersionNumber }})</em></th>
  </tr>
  <tr>
   <td>Contains a <code>system.img</code>.<br><br><br>
   <pre>
system.img
  -/
    - bin/
    - etc
    - vendor -> /vendor
    - ...
   </pre>
   </td>
   <td>Contains the merged contents of <code>$TARGET_SYSTEM_OUT</code> and
   <code>$TARGET_ROOT_OUT</code>.<br><br>
   <pre>
system.img
  -/
    - init.rc
    - init
    - etc -> /system/etc
    - system/
      - bin/
      - etc/
      - vendor -> /vendor
      - ...
    - vendor/ (mount point)
    - odm/ (mount point)
    ...
    </pre>
   </td>
   <td>Contains the merged contents of <code>$TARGET_SYSTEM_OUT</code> and
   <code>$TARGET_ROOT_OUT</code>.<br><br>
   <pre>
system.img
  -/
    - init.rc
    - init -> /system/bin/init
    - etc -> /system/etc
    - system/
      - bin/
      - etc/
      - vendor -> /vendor
      - ...
    - vendor/ (mount point)
    - odm/ (mount point)
    ...
    </pre>
    </td>
  </tr>
</table>

<h3 id="partition-layouts-abdevices">Partition layouts (A/B devices)</h3>

<p>
  The following sections detail differences in partition layouts for A/B devices
 before and after Android {{ androidQVersionNumber }}.
</p>

<h4 id="boot-img">boot.img</h4>

<table>
  <tr>
    <th>System as root<br><em>(Android 9)</em></th>
    <th>Ramdisk<br><em>(Android {{ androidQVersionNumber }})</em></th>
  </tr>
  <tr>
   <td>Contains normal boot kernel and recovery-ramdisk
   (<code>BOARD_USES_RECOVERY_AS_BOOT := true</code>).<br><br>Recovery-ramdisk
   is used only to boot into recovery.</td>
   <td>Contains normal boot kernel and recovery-ramdisk
   (<code>BOARD_USES_RECOVERY_AS_BOOT := true</code>). <br><br>Recovery-ramdisk
   is used to boot into both recovery and Android.
   <pre>
ramdisk.img
  -/
    - init -> /system/bin/init
    - first_stage_ramdisk
       - vendor fstab files
    - etc -> /system/etc
    - system/ (mount point)
    - vendor/ (mount point)
    - odm/ (mount point)
    ...
    </pre>
   </td>
  </tr>
</table>

<h4 id="system-img">system.img</h4>

<table>
  <tr>
    <th>System as root<br><em>(Android 9)</em></th>
    <th>Ramdisk<br><em>(Android {{ androidQVersionNumber }})</em></th>
  </tr>
  <tr>
   <td colspan="2" style="text-align: center">Contains the merged contents of
   <code>$TARGET_SYSTEM_OUT</code> and <code>$TARGET_ROOT_OUT</code>.<br><br>
   <pre>
system.img
  -/
    - init.rc
    - init -> /system/bin/init
    - etc -> /system/etc
    - system/
      - bin/
      - etc/
      - vendor -> /vendor
      - ...
    - vendor/ (mount point)
    - odm/ (mount point)
    ...
    </pre>
   </td>
  </tr>
</table>

</body>
</html>
