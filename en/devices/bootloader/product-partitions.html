<html devsite>
<head>
  <title>Building Product Partitions</title>
  <meta name="project_path" value="/_project.yaml">
  <meta name="book_path" value="/_book.yaml">
</head>
{% include "_versions.html" %}
<body>
  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>
  Android 9 and higher includes support for building
  <code>/product</code> partitions using the Android build system. Previously,
  Android 8.x enforced the separation of SoC-specific components
  from the <code>/system</code> partition to the <code>/vendor</code>
  partition without dedicating space for OEM-specific components built from the
  Android build system. Android 9 and higher provides additional
  <a href="#product-partitions-and-permissions">permissions
  and whitelisting features</a> that apply to priv-apps on different partitions.
</p>

<h2 id="product-partitions">About product partitions</h2>

<p>
  Many OEMs customize the AOSP system image to implement their own features,
  as well as carrier requirements. However, such customizations make it
  impossible to use a single system image for multiple software SKUs. Each
  image must be different to support the customizations, such as with
  different locales or carriers. Using a
  separate <code>/product</code> partition to contain customizations makes it
  possible to use a single system image for multiple software SKUs. (The
  <code>/system</code> partition hosts generic code that can be shared among
  many software SKUs). The <code>/vendor</code> partition continues to host
  SoC-specific BSP code which can be shared among multiple
  devices based on the given SoC.
</p>

<p>
  Using separate partitions has some disadvantages, such as
  managing disk space (a limited amount of space must remain reserved for future
  growth) and <a href="/devices/architecture/vndk/abi-stability">maintaining
  a stable application binary interface (ABI)</a> between partitions. Before
  deciding to use <code>/product</code> partitions, take time to consider your
  unique AOSP implementation and possible mitigation tactics (such as
  repartitioning a device during an <a href="/devices/tech/ota/">over-the-air
  (OTA) update</a>, which isn't done by Google but is done by some OEMs).
</p>

<h3 id="product-partitions-and-permissions">Product partitions and permissions</h3>

<p>
  In Android 9 and higher, a change in the permissions
  and whitelisting process affects how you grant priv-apps permissions on
  your product partitions. The <code>permissions.xml</code> file
  must reside in the same partition as the priv-apps. Placing a
  <code>permissions.xml</code> file in the <code>/system</code> partition
  for priv-apps doesn't extend those permissions to priv-apps in the <code>/product</code>
  partition, even though the former is an extension of the latter.
  For details on the permissions and whitelisting processes, see
  <a href="/devices/tech/config/perms-whitelist">Privileged Permission Whitelisting</a>.</p>

<h3 id="legacy-oem">Legacy /oem vs /product</h3>

<p>
  The new <code>/product</code> partition is different than the legacy
  <code>/oem</code> partition:
</p>

<table>
  <tr>
  <th>Partition</th>
  <th>Attributes</th>
  </tr>
  <tr>
  <td><code>/oem</code></td>
  <td>
  <ul>
   <li>Not updateable; usually flashed once at the factory.</li>
    <li>Built per small variations, such as branding and color. Having
    different <code>/oem</code> partition contents doesn't mean the product
    software is different.</li>
    <li>The <code>/system</code> partition doesn't depend on
    the <code>/oem</code> partition. (It uses the <code>/oem</code>
    partition only when a specific file is found there).</li>
    <li>Only uses public API on the <code>/system</code> partition.</li>
  </ul>
  </td>
  </tr>
  <tr>
  <td><code>/product</code></td>
  <td>
   <ul>
    <li>Updateable</li>
    <li>Coupled with the system image (they update together)</li>
    <li>Built per product or product families.</li>
    <li>System partition can depend on <code>/product</code> partition.</li>
    <li>Can use non-public APIs since they are updated simultaneously.</li>
  </ul>
  </td>
  </tr>
  </table>

<p>
  For these reasons, Android 9 supports the new
  <code>/product</code> partition while retaining support for the legacy
  <code>/oem</code> partition, for devices that depend on it.
</p>

<h3 id="product-components">/product components</h3>

<p>
  The <code>/product</code> partition contains the following components:
</p>

<ul>
  <li>Product-specific system properties (<code>/product/build.prop</code>)</li>
  <li>Product-specific RROs (<code>/product/overlay/*.apk</code>)</li>
  <li>Product-specific apps (<code>/product/app/*.apk</code>)</li>
  <li>Product-specific priv-apps (<code>/product/priv-app/*.apk</code>)</li>
  <li>Product-specific libraries (<code>/product/lib/*</code>)</li>
  <li>Product-specific java libraries (<code>/product/framework/*.jar</code>)
  </li>
  <li>Product-specific Android Framework system configs
  (<code>/product/etc/sysconfig/*</code> and
  <code>/product/etc/permissions/*</code>)</li>
  <li>Product-specific media files (<code>/product/media/audio/*</code>)</li>
  <li>Product-specific <code>bootanimation</code> files</li>
</ul>

<h3 id="custom-images">No custom_images</h3>

<p>
  You can't use <code>custom_images</code>. They lack support for the
  following:
</p>

<ul>
  <li><strong>Installing modules into a specific target</strong>.
  <code>custom_images</code> support copying artifacts into an image but
  can't install a module into a specific partition by specifying its target
  partition as a part of a build rule.</li>
  <li><strong>Soong support</strong>. <code>custom_images</code> can't be
  built using the Soong build system.</li>
  <li><strong>OTA update support</strong>. <code>custom_images</code> are used as factory ROM
  images that can't receive OTA updates.</li>
</ul>

<h3 id="maintaining-abis">Maintaining ABIs between partitions</h3>

<p>
  The <code>/product</code> partition in Android 9
   is an extension of the <code>/system</code> partition. There's a weak ABI
  between <code>/product</code> and <code>/system</code> partitions, so both must
  be upgraded at the same time, and the ABI should be system SDK-based. If the
  system SDK doesn't cover all API surfaces between <code>/product</code> and
  <code>/system</code>, OEMs must maintain their own ABIs between
  the two partitions.
</p>

<p>The <code>/product</code> and <code>/system</code> partitions can have
  dependency on each other. However, tests with the
  <a href="/setup/build/gsi">Generic&nbsp;System&nbsp;Image&nbsp;(GSI)</a> must work properly
  without the <code>/product</code> partition.
</p>

<p>The <code>/product</code> partition must not have any dependency on
  <code>/vendor</code> partition. Direct interaction between the
  <code>/product</code> and <code>/vendor</code> partitions is forbidden.
  (This is enforced by SEpolicy.)
</p>

<h2 id="implementing-product-partitions">Implementing product partitions</h2>

<p>
  Before implementing a new product partition, review the
  <a href="https://android-review.googlesource.com/q/topic:product_partition+(status:open+OR+status:merged)" class="external">related
  product partition changes in AOSP</a>. Then, to set up <code>/product</code>,
  include the following board or product-build flags:
</p>

<ul>
  <li><code>BOARD_USES_PRODUCTIMAGE</code></li>
  <li><code>BOARD_PRODUCTIMAGE_PARTITION_SIZE</code></li>
  <li><code>BOARD_PRODUCTIMAGE_FILE_SYSTEM_TYPE</code></li>
  <li><code>PRODUCT_PRODUCT_PROPERTIES</code> for <code>/product/build.prop</code>.
  These must be within a <code>$(call inherit-product path/to/device.mk)</code>,
  as in <code>PRODUCT_PRODUCT_PROPERTIES += product.abc=ok</code>.
   </li>
 </ul>

<h3 id="installing-to-product-partition">Installing a module to the product partition</h3>

<p>
  Use the following build flags to install a module to the <code>product</code> partition.
</p>

<ul>
  <li><code>product_specific: true</code> in <code>Android.bp</code></li>
  <li><code>LOCAL_PRODUCT_MODULE := true</code> in <code>Android.mk</code></li>
</ul>

<h3 id="enabling-verified-boot">Enabling verified boot</h3>

<p>
  To prevent the <code>/product</code> partition from being tampered with by
  malicious software, enable
  <a href="https://android.googlesource.com/platform/external/avb/" class="external">Android
  Verified Boot (AVB)</a> for that partition (just as you do for the
  <code>/vendor</code> and <code>/system</code> partitions). To enable AVB,
  include the following build flags:
  <code>BOARD_AVB_PRODUCT_ADD_HASHTREE_FOOTER_ARGS</code>.
</p>

</body>
</html>
