Project: /_project.yaml
Book: /_book.yaml

{% include "_versions.html" %}

<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

# HEIF Imaging

Devices running Android {{ androidQVersionNumber }} support the HEIC
compressed image format, a high
efficiency video encoding (HEVC) specific _brand_ of the high efficiency image
file format (HEIF) as specified in
[ISO/IEC 23008-12](https://www.iso.org/standard/66067.html){: .external}.
HEIC-encoded images offer
better image quality with smaller file sizes as compared to JPEG files.

HEIC images are generated by the camera framework requesting an uncompressed
image from the
[camera HAL](/devices/camera/camera3) and sending it to the media subsystem to
be encoded by an HEIC or HEVC encoder.

## Requirements

To support the HEIC image format, your device must have a hardware encoder
supporting
[`MIMETYPE_IMAGE_ANDROID_HEIC`](https://developer.android.com/reference/android/media/MediaFormat.html#MIMETYPE_IMAGE_ANDROID_HEIC){: .external}
or
[`MIMETYPE_VIDEO_HEVC`](https://developer.android.com/reference/android/media/MediaFormat.html#MIMETYPE_VIDEO_HEVC){: .external}
with the
[constant quality mode](https://developer.android.com/reference/android/media/MediaCodecInfo.EncoderCapabilities.html#BITRATE_MODE_CQ){: .external}.

## Implementation

To support the HEIC image format on your device, implement an HEIC/HEVC codec
and provide support for the required stream configurations, which are the
`IMPLEMENTATION_DEFINED`/`YUV` streams and JPEG app segment streams.

### Media

Implement the HEIC/HEVC codec in constant quality (CQ) mode for the
corresponding hardware as follows:

+   The HEVC type codec consumes either the `IMPLEMENTATION_DEFINED`
    format with the `GRALLOC_USAGE_HW_VIDEO_ENCODER` usage or the
    `HAL_PIXEL_FORMAT_YCBCR_420_888` format depending on the image size.
+   The HEIC type codec consumes the `IMPLEMENTATION_DEFINED` format with the
    `GRALLOC_USAGE_HW_IMAGE_ENCODER` usage.

### Camera

In the static metadata, set `ANDROID_HEIC_INFO_SUPPORTED` to true, and
`ANDROID_HEIC_INFO_MAX_JPEG_APP_SEGMENTS_COUNT` to a value between `[1, 16]`,
indicating the number of JPEG app segments.

For each mandatory stream combination, your camera device must support swapping
a JPEG stream with a HEIC stream of the same size.

For an HEIC output stream at the public API, the camera service creates two HAL
internal streams:

+   A BLOB stream with the `JPEG_APPS_SEGMENT` usage flag to store app
    segments including EXIF and thumbnail segments
+   An `IMPLEMENTATION_DEFINED` or `YCBCR_420_888` stream the size of the
    HEIC stream depending on the target codec and HEIC stream size

Based on `ANDROID_HEIC_INFO_MAX_JPEG_APP_SEGMENTS_COUNT`, the camera framework
allocates buffers large enough for the camera HAL to populate the JPEG app
segments. The `APP1` segment is required but segments following the `APP1`
segment (`APP2` and above) are optional. The camera framework overrides the EXIF
tags in the `APP1` segment that can be derived from the capture result metadata
or are related to the main image bitstream and sends them to `MediaMuxer`.

Because the media encoder embeds the orientation in the metadata of output
images, to ensure a consistent orientation between the main image and thumbnail,
the camera HAL must not rotate the thumbnail image based on
`android.jpeg.orientation.` The framework writes the orientation into the EXIF
metadata and HEIC container.

The static, control, and dynamic metadata tags related to the JPEG format also
apply to the HEIC format. For example, the `android.jpeg.orientation` and
`android.jpeg.quality` metadata tags in the capture request are used to control
the orientation and quality of HEIC images.

Note: JPEG and HEIC streams can't be
configured at the same time.

To use the HEIC format in an application, use the
[HEIC public API](https://developer.android.com/reference/android/graphics/ImageFormat#HEIC){: .external}.

For more information, see the following sources.

**Camera HAL**

+   [`docs.html`](https://android.googlesource.com/platform/system/media/+/a44fd450eae51e671b1020d4f2fb146b181bc1f7/camera/docs/docs.html#31733){: .external}
+   [`CameraBlob`](https://android.googlesource.com/platform/hardware/interfaces/+/55386823a318309bfe1cc40175afa615225cabb1/camera/device/3.5/types.hal#156){: .external}
+   [`ANDROID_HEIC_INFO_SUPPORTED`](https://android.googlesource.com/platform/hardware/interfaces/+/55386823a318309bfe1cc40175afa615225cabb1/camera/metadata/3.4/types.hal#166){: .external}
+   [`ANDROID_HEIC_INFO_MAX_JPEG_APP_SEGMENTS_COUNT`](https://android.googlesource.com/platform/hardware/interfaces/+/55386823a318309bfe1cc40175afa615225cabb1/camera/metadata/3.4/types.hal#172){: .external}

**Graphic buffer data space**

+   [`JPEG_APP_SEGMENTS`](https://android.googlesource.com/platform/hardware/interfaces/+/55386823a318309bfe1cc40175afa615225cabb1/graphics/common/1.2/types.hal#66){: .external}
+   [`HEIF`](https://android.googlesource.com/platform/hardware/interfaces/+/55386823a318309bfe1cc40175afa615225cabb1/graphics/common/1.2/types.hal#77){: .external}

**Graphic buffer usage space**

+   [`HW_IMAGE_ENCODER`](https://android.googlesource.com/platform/hardware/interfaces/+/55386823a318309bfe1cc40175afa615225cabb1/graphics/common/1.2/types.hal#105){: .external}

## Validation

To validate that your implementation supports HEIC images, use the
[`TestingCamera2`](https://android.googlesource.com/platform/pdk/+/refs/heads/master/apps/TestingCamera2/){: .external}
test application and run the following Camera CTS and VTS tests.

**Camera CTS tests**

+   [`NativeImageReaderTest#testHeic`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/NativeImageReaderTest.java#46){: .external}
+   [`ImageReaderTest#testHeic`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ImageReaderTest.java#207){: .external}
+   [`ImageReaderTest#testRepeatingHeic`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ImageReaderTest.java#257){: .external}
+   [`ReprocessCaptureTest#testBasicYuvToHeicReprocessing`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ReprocessCaptureTest.java#122){: .external}
+   [`ReprocessCaptureTest#testBasicOpaqueToHeicReprocessing`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ReprocessCaptureTest.java#170){: .external}
+   [`RobustnessTest#testMandatoryOutputCombinations`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/RobustnessTest.java#230){: .external}
+   [`StillCaptureTest#testHeicExif`](https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/StillCaptureTest.java#116){: .external}

**Camera VTS tests**

+   [`VtsHalCameraProviderV2_4TargetTest.cpp`](https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/camera/provider/2.4/vts/functional/VtsHalCameraProviderV2_4TargetTest.cpp#2357){: .external}
