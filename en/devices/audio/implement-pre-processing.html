<html devsite>
  <head>
    <title>Configuring Preprocessing Effects</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
    {% include "_versions.html" %}

  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

  <p>The Android {{ androidQVersionNumber }} release includes the following
  requirements for capture with <code>VOICE_COMMUNICATION</code>.</p>

<ul>
 <li>Implementations should provide an acoustic echo canceler (AEC) on the capture path when
 capturing with <code>VOICE_COMMUNICATION</code>.</li>
 <li>If providing an AEC, it must be discoverable and controllable through the SDK API's
 <code>AcousticEchoCanceler</code>.</li>
</ul>

<p>The Android platform provides audio effects on supported devices in the
<a href="http://developer.android.com/reference/android/media/audiofx/package-summary.html"
class="external">
<code>audiofx</code></a> package, which is available for developers to access.
For example, the Nexus 10 supports the following preprocessing effects:</p>

<ul>
<li>
<a href="http://developer.android.com/reference/android/media/audiofx/AcousticEchoCanceler.html">Acoustic
Echo Cancellation</a></li>
<li>
<a href="http://developer.android.com/reference/android/media/audiofx/AutomaticGainControl.html">Automatic Gain Control</a></li>
<li>
<a href="http://developer.android.com/reference/android/media/audiofx/NoiseSuppressor.html">Noise
Suppression</a></li>
</ul>

<h2 id="audiosources">Pairing with AudioSources</h2>
<p>Preprocessing effects are paired with the use case mode in which the
preprocessing is requested. In Android app development, a use case is referred
to as an <code>AudioSource</code> instance; and app developers request to use the
<code>AudioSource</code> abstraction instead of the actual audio hardware
device. The Android Audio Policy Manager maps an <code>AudioSource</code> instance to a
given capture path configuration (including device, gain, and pre processing) according
to product-specific rules. The following sources are exposed to developers:</p>

<ul>
<li><code>android.media.MediaRecorder.AudioSource.CAMCORDER</code></li>
<li><code>android.media.MediaRecorder.AudioSource.VOICE_COMMUNICATION</code></li>
<li><code>android.media.MediaRecorder.AudioSource.VOICE_CALL</code></li>
<li><code>android.media.MediaRecorder.AudioSource.VOICE_DOWNLINK</code></li>
<li><code>android.media.MediaRecorder.AudioSource.VOICE_UPLINK</code></li>
<li><code>android.media.MediaRecorder.AudioSource.VOICE_RECOGNITION</code></li>
<li><code>android.media.MediaRecorder.AudioSource.MIC</code></li>
<li><code>android.media.MediaRecorder.AudioSource.DEFAULT</code></li>
</ul>

<p>The default preprocessing effects applied for each <code>AudioSource</code> instance
are specified in the <code>/vendor/etc/audio_effects.xml</code> file. To
specify your own default effects for every <code>AudioSource</code> instance, create a
<code>/vendor/etc/audio_effects.xml</code> file and specify the
preprocessing effects to turn on. For an example, see the implementation for
the Nexus 10 in <code>device/samsung/manta/audio_effects.xml</code>.
<code>AudioEffect</code> instances acquire and release a session when created and destroyed,
enabling the effects (such as the Loudness Enhancer) to persist throughout the
session.</p>

<aside class="warning"><strong>Warning:</strong> For the
<code>VOICE_RECOGNITION</code> use case, don't enable the noise suppression
preprocessing effect. It shouldn't be turned on by default when recording from
this audio source, and you shouldn't enable it in your own <code>audio_effects.xml</code>
file. Turning on the effect by default causes the device to fail the
<a href="/compatibility/index.html"> compatibility requirement</a>
regardless of whether this was on by default due to the configuration file, or the
audio HAL implementation's default behavior.</aside>

<p>The following example enables preprocessing for the VoIP
<code>AudioSource</code> and Camcorder <code>AudioSource</code> instances. By declaring
the <code>AudioSource</code> configuration in this manner, the framework
automatically requests the use of those effects from the HAL.</p>

<pre class="prettyprint">
&lt;preprocess&gt;
        &lt;stream type="voice_communication"&gt;
            &lt;apply effect="aec"/&gt;
            &lt;apply effect="ns"/&gt;
        &lt;/stream&gt;
        &lt;stream type="camcorder"&gt;
            &lt;apply effect="agc"/&gt;
        &lt;/stream>
    &lt;/preprocess&gt;
</pre>

<h2 id="tuning">Source tuning</h2>

<p><code>AudioSource</code> tuning doesn't have explicit requirements on audio
gain or audio processing with the exception of voice recognition
(<code>VOICE_RECOGNITION</code>). Requirements for voice recognition include:</p>

<ul>
<li>Flat frequency response (+/- 3&nbsp;dB) from 100&nbsp;Hz to 4&nbsp;kHz</li>
<li>Close-talk config: 90&nbsp;dB SPL reads RMS of 2500 (16&nbsp;bit samples)</li>
<li>Level tracks linearly from -18&nbsp;dB to +12&nbsp;dB relative to 90&nbsp;dB SPL</li>
<li>THD &lt; 1% (90&nbsp;dB SPL in 100 to 4000&nbsp;Hz range)</li>
<li>Near-ultrasound requirements (for testing, see
<a href="/compatibility/cts/near-ultrasound.html">Near Ultrasound
Tests</a>):
<ul>
<li>Support for <code>SUPPORT_PROPERTY_MIC_NEAR_ULTRASOUND</code> as defined in section 7.8.3
of the CDD.</li>
<li>Support for one or both of 44100 or 48000 sampling rates with no band-pass or
antialiasing filters.</li>
</ul></li>
<li>Effects/preprocessing disabled by default</li>
</ul>

<p>Examples of tuning different effects for different sources are:</p>

<ul>
<li>Noise Suppressor
<ul>
<li>Tuned for wind noise suppressor for <code>CAMCORDER</code></li>
<li>Tuned for stationary noise suppressor for <code>VOICE_COMMUNICATION</code></li>
</ul>
</li>
<li>Automatic Gain Control
<ul>
<li>Tuned for close-talk for <code>VOICE_COMMUNICATION</code> and main phone
mic</li>
<li>Tuned for far-talk for <code>CAMCORDER</code></li>
</ul>
</li>
</ul>

<h2 id="resources">Resources</h2>

<p>For more information, refer to the following resources:</p>

<ul>
<li>Android documentation for
<a href="http://developer.android.com/reference/android/media/audiofx/package-summary.html">audiofx
package</a></li>

<li>Android documentation for
<a href="http://developer.android.com/reference/android/media/audiofx/NoiseSuppressor.html">Noise
Suppression audio effect</a></li>

<li><code>/device/google/crosshatch/audio_effects.xml</code> file for the Pixel 3</li>
</ul>

  </body>
</html>
