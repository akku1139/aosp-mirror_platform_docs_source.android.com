<html devsite>
  <head>
    <title>Kernel Configuration</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  {% include "_versions.html" %}
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->


<p>
  Use the following configuration settings as a base for an Android kernel
  configuration. Settings are organized into <code>.cfg</code> files for <code>android-base</code>,
  <code>android-base-<var>ARCH</var></code>, and
  <code>android-recommended</code>:
</p>

<ul>
  <li><code>android-base</code> options enable core Android features and
  should be configured as specified by all devices.</li>
  <li><code>android-base-<var>ARCH</var></code> options enable core
  Android features and should be configured as specified by all devices of
  architecture <var>ARCH</var>. Not all architectures have a corresponding file
  of architecture-specific required options. If your architecture doesn't have
  a file, it doesn't have additional architecture-specific kernel configuration
  requirements for Android.</li>
  <li><code>android-recommended</code>. These options enable advanced Android
  features and are optional for devices.</li>
</ul>

<p>
  These configuration files are located in the
  <code><a href="https://android.googlesource.com/kernel/configs/" class="external">kernel/configs</a></code>
  repo. Use the set of configuration files that corresponds to the version of
  the kernel you are using.
</p>

<p>
  For details on controls already undertaken to strengthen the kernel on your
  devices, see <a href="/security/overview/kernel-security.html">System and
  kernel security</a>. For details on required settings, see the
  <a href="/compatibility/cdd.html">Android Compatibility Definition Document
  (CDD)</a>.
</p>

<h2 id="generating">Generating kernel config</h2>

<p>
  For devices that have a minimalist <code>defconfig</code> format, use the
  <code>merge_config.sh</code> script in the kernel tree to enable options:
</p>

<pre class="devsite-click-to-copy">
ARCH=<var>ARCH</var> scripts/kconfig/merge_config.sh &lt;...&gt;/device_defconfig &lt;...&gt;/android-base.cfg &lt;...&gt;/android-base-<var>ARCH</var>.cfg &lt;...&gt;/android-recommended.cfg
</pre>

<p>
  This generates a <code>.config</code> file that you can use to save a new
  <code>defconfig</code> file or compile a new kernel with Android features
  enabled.
</p>

<h2 id="additional-kernel-reqs">Additional kernel config requirements</h2>

<p>
  In some cases, the platform maintainer can choose from multiple kernel
  features to satisfy an Android dependency. Such dependencies can't
  expressed in the kernel config fragment files (described above) because the
  format for those files doesn't support logical expressions. In Android 9 and
  higher, <a href="/compatibility/cts/">Compatibility Test Suite (CTS)</a> and
  <a href="/compatibility/vts/">Vendor Test Suite (VTS)</a> verify that the
  following requirements are satisfied:
</p>

<ul>
  <li><code>CONFIG_OF=y</code> or <code>CONFIG_ACPI=y</code></li>
  <li>4.4 and 4.9 kernels have <code>CONFIG_ANDROID_LOW_MEMORY_KILLER=y</code>
  OR have both <code>CONFIG_MEMCG=y</code> and <code>CONFIG_MEMCG_SWAP=y</code>
  </li>
  <li><code>CONFIG_DEBUG_RODATA=y</code> or
  <code>CONFIG_STRICT_KERNEL_RWX=y</code></li>
  <li><code>CONFIG_DEBUG_SET_MODULE_RONX=y</code> or
  <code>CONFIG_STRICT_MODULE_RWX=y</code></li>
  <li>For ARM64 only: <code>CONFIG_ARM64_SW_TTBR0_PAN=y</code> or
  <code>CONFIG_ARM64_PAN=y</code></li>
</ul>

<p>
  In addition, the <code>CONFIG_INET_UDP_DIAG</code> option must be set to
  <code>y</code> for 4.9 kernels in Android 9 and higher.
</p>

<h2 id="usb">Enabling USB host mode options</h2>

<p>
  For USB host mode audio, enable the following options:
</p>

<pre class="devsite-click-to-copy">
CONFIG_SND_USB=y
CONFIG_SND_USB_AUDIO=y
# CONFIG_USB_AUDIO is for a peripheral mode (gadget) driver
</pre>

<p>
  For USB host mode MIDI, enable the following option:
</p>

<pre class="devsite-click-to-copy">CONFIG_SND_USB_MIDI=y</pre>

<h2 id="Seccomp-BPF-TSYNC">Seccomp BPF with TSYNC</h2>

<p>
  Secure Computing Berkeley Packet Filter (Seccomp BPF) is a kernel security
  technology that enables the creation of sandboxes that define the context in
  which a process may make system calls. The thread synchronization (TSYNC)
  feature enables the use of Seccomp BPF from multithreaded programs. This
  ability is limited to architectures that have Seccomp support upstream (ARM,
  ARM64, x86, and x86_64).
</p>

<h2 id="llkd">Android Live-Lock Daemon</h2>

<p>
  Android {{ androidQVersionNumber }} includes the Android Live-Lock Daemon
  (llkd), which is designed to catch and mitigate kernel deadlocks. For details
  on using llkd, refer to the
  <a href="https://android.googlesource.com/platform/system/core/+/HEAD/llkd/README.md"
  class="external">README.md</a>.
</p>

<h2 id="vdso32-on-arm64">Using vDSO32 on ARM64</h2>

<p>
  Virtual dynamic shared object (vDSO) is an alternative to system calls that,
  when used and configured correctly, can reduce cycle costs. Android
  {{ androidQVersionNumber }} adds support for vDSO32 on 64-bit kernels (Android
  already supports vDSO64 on 64-bit kernels and vDSO32 on 32-bit kernels). Using
  vDSO32 (<code>CONFIG_VDSO_COMPAT</code>) on ARM64 architecture provides a
  0.4 percent increase in battery life and other performance improvements.
</p>

<p>
  The Linux community is actively working on
  <a href="https://lkml.org/lkml/2019/6/21/247" class="external">unifying vDSOs
  across architectures</a>. You can set up vDSO in your Linux kernel by enabling
  vDSO32 with <code>CONFIG_COMPAT</code> and
  <code>CONFIG_CROSS_COMPILE_COMPAT_VDSO</code> with the arm32 compiler triplet.
  The Android Kernel team has backported older versions of the vDSO patch series
  into Pixel devices, so you can find examples in Pixel kernel builds
  (<code>LINUX_FCC_CROSS_COMPILE_ARM32_PREBUILTS_BIN</code> path,
  <code>CROSS_COMPILE_ARM32</code> reference, and
  <code>CONFIG_CROSS_COMPILE_ARM32</code> config).
</p>

  </body>
</html>
