<html devsite>
  <head>
    <title>Adding ConfigStore Classes and Items</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  {% include "_versions.html" %}
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<aside class="warning">
  <strong>Warning:</strong> Android {{ androidQVersionNumber }} deprecates the
  ConfigStore HAL and replaces the HAL with system properties. For details,
  refer to <a href="/devices/architecture/configuration">Configuring</a>.
</aside>

<p>You can add new ConfigStore items (that is, interface methods) for an
existing interface class. If the interface class isn't defined, you must add a
new class before you can add a ConfigStore item for that class. This section
uses the example of a <code>disableInitBlank</code> configuration item for
<code>healthd</code> being added to the <code>IChargerConfigs</code> interface
class.</p>

<aside class="note"><strong>Note:</strong> Before continuing, ensure that you're
familiar with <a href="/devices/architecture/hidl/index.html">general HIDL
concepts</a>, <a href="/devices/architecture/hidl-cpp/index.html">HIDL C++
development workflow</a>,
<a href="/devices/architecture/hidl/code-style.html">HIDL Code Style</a>, and
<a href="/devices/architecture/configstore/index.html"> ConfigStore design</a>.
</aside>

<h2 id="add-class">Adding interface classes</h2>
<p>If no interface class is defined for the interface method that you want to
add, you must add the interface class before you can add the associated
ConfigStore items.</p>

<ol>
<li>Create a HAL interface file. The ConfigStore version is 1.0, so define
ConfigStore interfaces in <code>hardware/interfaces/configstore/1.0</code>. For
example, in
<code>hardware/interfaces/configstore/1.0/IChargerConfigs.hal</code>:

<pre class="devsite-click-to-copy">
package android.hardware.configstore@1.0;

interface IChargerConfigs {
    // TO-BE-FILLED-BELOW
};
</pre></li>

<li>Update <code>Android.bp</code> and <code>Android.mk</code> for the
ConfigStore shared library and header files to include the new interface HAL.
For example:

<pre class="devsite-click-to-copy">
<code class=devsite-terminal>hidl-gen -o hardware/interfaces/configstore/1.0/default -Lmakefile -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport android.hardware.configstore@1.0::IChargerConfigs</code>
<code class=devsite-terminal>hidl-gen -o hardware/interfaces/configstore/1.0/default -Landroidbp -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport android.hardware.configstore@1.0::IChargerConfigs</code>
</pre>
These commands update <code>Android.bp</code> and <code>Android.mk</code> in
<code>hardware/interfaces/configstore/1.0</code>.</li>

<li>Generate the C++ stub for implementing the server code. For example:

<pre class="devsite-terminal devsite-click-to-copy">
hidl-gen -o hardware/interfaces/configstore/1.0/default -Lc++-impl -randroid.hardware:hardware/interfaces -randroid.hidl:system/libhidl/transport android.hardware.configstore@1.0::IChargerConfigs
</pre>
This command creates two files, <code>ChargerConfigs.h</code> and
<code>ChargerConfigs.cpp</code>, in
<code>hardware/interfaces/configstore/1.0/default</code>.</li>

<li>Open the <code>.h</code> and <code>.cpp</code> implementation files and
remove code related to the function <code>HIDL_FETCH_<var>name</var></code> (for
example, <code>HIDL_FETCH_IChargerConfigs</code>). This function is needed for
HIDL passthrough mode, which isn't used by ConfigStore.</li>

<li>Register the implementation to the ConfigStore service. For example, in
<code>hardware/interfaces/configstore/1.0/default/service.cpp</code>:

<pre class="devsite-click-to-copy">
#include &lt;android/hardware/configstore/1.0/IChargerConfigs.h&gt;
#include "ChargerConfigs.h"

using android::hardware::configstore::V1_0::IChargerConfigs;
using android::hardware::configstore::V1_0::implementation::ChargerConfigs;

int main() {
    ... // other code
    sp&lt;IChargerConfigs&gt; chargerConfigs = new ChargerConfigs;
    status = chargerConfigs-&gt;registerAsService();
    LOG_ALWAYS_FATAL_IF(status != OK, "Could not register IChargerConfigs");
    ... // other code
}
</pre></li>

<li>Modify the <code>Android.mk</code> file to add the implementation file
(<code><var>modulename</var>Configs.cpp</code>) to <code>LOCAL_SRC_FILES</code>
and to map build flags into macro definitions. For example, in
<code>hardware/interfaces/configstore/1.0/default/Android.mk</code>:

<pre class="devsite-click-to-copy">
LOCAL_SRC_FILES += ChargerConfigs.cpp

ifeq ($(strip $(BOARD_CHARGER_DISABLE_INIT_BLANK)),true)
LOCAL_CFLAGS += -DCHARGER_DISABLE_INIT_BLANK
endif
</pre></li>

<li>(Optional) Add a manifest entry. If it doesn't exist, default to the
"default" instance name of ConfigStore. For example, in
<code>device/google/marlin/manifest.xml</code>:

<pre class="devsite-click-to-copy">
    &lt;hal format="hidl"&gt;
        &lt;name&gt;android.hardware.configstore&lt;/name&gt;
        ...
        &lt;interface&gt;
            &lt;name&gt;IChargerConfigs&lt;/name&gt;
            &lt;instance&gt;default&lt;/instance&gt;
        &lt;/interface&gt;
    &lt;/hal&gt;
</pre></li>

<li>Add the sepolicy rule if needed (that is, if the client doesn't have
permissions for making hwbinder calls to <code>hal_configstore</code>). For
example, in <code>system/sepolicy/private/healthd.te</code>:

<pre class="devsite-click-to-copy">
... // other rules
binder_call(healthd, hal_configstore)
</pre></li>
</ol>


<h2 id="add-item">Adding new ConfigStore items</h2>
<p>To add a new ConfigStore item:</p>
<ol>
<li>Open the HAL file and add the required interface method for the item. (The
<code>.hal</code> files for ConfigStore reside in
<code>hardware/interfaces/configstore/1.0</code>.) For example, in
<code>hardware/interfaces/configstore/1.0/IChargerConfigs.hal</code>:

<pre class="devsite-click-to-copy">
package android.hardware.configstore@1.0;

interface IChargerConfigs {
    ... // Other interfaces
    disableInitBlank() generates(OptionalBool value);
};
</pre></li>

<li>Implement the method in the corresponding interface HAL implementation files
(<code>.h</code> and <code>.cpp</code>). Place the default implementations in
<code>hardware/interfaces/configstore/1.0/default</code>.

<aside class="note"><strong>Note:</strong> Running <code>hidl-gen</code> with
<code>-Lc++-impl</code> generates skeleton code for the newly added interface
method. However, it also overwrites implementations for all existing
interface methods, so use the <code>-o</code> option appropriately.</aside>

For example, in
<code>hardware/interfaces/configstore/1.0/default/ChargerConfigs.h</code>:

<pre class="devsite-click-to-copy">
struct ChargerConfigs : public IChargerConfigs {
    ... // Other interfaces
    Return&lt;void&gt; disableInitBlank(disableInitBlank_cb _hidl_cb) override;
};
</pre>

And in
<code>hardware/interfaces/configstore/1.0/default/ChargerConfigs.cpp</code>:

<pre class="devsite-click-to-copy">
Return&lt;void&gt; ChargerConfigs::disableInitBlank(disableInitBlank_cb _hidl_cb) {
    bool value = false;
#ifdef CHARGER_DISABLE_INIT_BLANK
    value = true;
#endif
    _hidl_cb({true, value});
    return Void();
}
</pre></li>
</ol>

<h2 id="using">Using ConfigStore items</h2>
<p>To use a ConfigStore item:</p>

<ol>
<li>Include the required header files. For example, in
<code>system/core/healthd/healthd.cpp</code>:

<pre class="devsite-click-to-copy">
#include &lt;android/hardware/configstore/1.0/IChargerConfigs.h&gt;
#include &lt;configstore/Utils.h&gt;
</pre></li>

<li>Access the ConfigStore item using the appropriate template function in
<code>android.hardware.configstore-utils</code>. For example, in
<code>system/core/healthd/healthd.cpp</code>:

<pre class="devsite-click-to-copy">
using namespace android::hardware::configstore;
using namespace android::hardware::configstore::V1_0;

static int64_t disableInitBlank = getBool&lt;
        IChargerConfigs,
        &amp;IChargerConfigs::disableInitBlank&gt;(false);
</pre>
In this example, the ConfigStore item <code>disableInitBlank</code> is retrieved
and stored to a variable (useful when the variable needs to be accessed multiple
times). The value retrieved from the ConfigStore is cached inside the
instantiated template function so that it can be retrieved quickly from the
cached value without contacting the ConfigStore service for later calls to the
instantiated template function.
</li>

<li>Add the dependency on ConfigStore and the <code>configstore-utils</code>
library in <code>Android.mk</code> or <code>Android.bp</code>. For example, in
<code>system/core/healthd/Android.mk</code>:

<pre class="devsite-click-to-copy">
LOCAL_SHARED_LIBRARIES := \
    android.hardware.configstore@1.0 \
    android.hardware.configstore-utils \
    ... (other libraries) \
</pre></li>
</ol>

  </body>
</html>
