<html devsite>
  <head>
    <title>Execute-only Memory (XOM) for AArch64 Binaries</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
{% include "_versions.html" %}
  <body>
  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>Executable code sections for AArch64 system binaries are by default marked
execute-only (non-readable) as a hardening mitigation against just-in-time code
reuse attacks. Code that mixes data and code together and code that purposefully
inspects these sections (without first remapping the memory segments as readable)
no longer function. Apps with a target SDK of {{ androidQVersionNumber }}
(API level 29 or higher) are impacted if the app attempts to read code sections of
execute-only memory (XOM) enabled system libraries in memory without first
marking the section as readable.</p>

<p>To fully benefit from this mitigation, both hardware and kernel support are
required. Without this support, the mitigation might only be partially enforced. The
<a
href="https://source.android.com/devices/architecture/kernel/android-common">
Android 4.9 common kernel</a> contains the appropriate patches to provide full
support for this on ARMv8.2 devices. </p>

<h2 id="implementation">Implementation</h2>
<p>AArch64 binaries generated by the compiler assume that code and data aren't
intermixed. Enabling this feature doesn't negatively affect the performance of
the device.</p>

<p>For code that has to perform intentional memory introspection on its
executable segments, it's advisable to call <code>mprotect</code> on the
segments of code requiring inspection to allow them to be readable, then
remove the readability when the inspection is complete.<br>
This implementation causes reads into memory segments marked as
execute-only to result in a segmentation fault (<code>SEGFAULT</code>).
This might occur as a result of a bug, vulnerability, data mixed with
code (literal pooling), or intentional memory introspection.</p>

<h3 id="device-support">Device support and impact</h3>
<p>Devices with earlier hardware or earlier kernels (lower than 4.9) without the
required patches might not fully support or benefit from this feature. Devices
without kernel support may not enforce user accesses of execute-only memory,
however kernel code which explicitly checks whether a page is readable may still
enforce this property, such as <code>process_vm_readv()</code>.</p>

<p>The kernel flag <code>CONFIG_ARM64_UAO</code> must be set in the kernel to
ensure that the kernel respects userland pages marked execute-only. Earlier ARMv8
devices, or ARMv8.2 devices with User Access Override (UAO) disabled, may not
fully benefit from this and may still be able to read execute-only pages using
syscalls.</p>

<aside class="note"><b>Note:</b> Calls to <code>ptrace</code> and ptrace
debugging aren't affected by this change.</aside>

<h3 id="refactoring">Refactoring existing code</h3>
<p>Code that has been ported from AArch32 might contain intermixed data and
code, causing issues to arise. In many cases, fixing these issues is as simple
as moving the constants to a <code>.data</code> section in the assembly file.
</p>

<p>Handwritten assembly may need to be refactored to separate locally pooled
constants.</p>

<p>Examples:</p>
<ul>
  <li><a
href="https://android-review.googlesource.com/c/platform/external/libjpeg-turbo/+/867910">
    <code>libjpeg-turbo</code></a></li>
  <li><a
href="https://android-review.googlesource.com/c/platform/frameworks/rs/+/876172">
    <code>libRSCpuRef</code></a></li>
</ul>

<p>Binaries generated by the Clang compiler should have no issues with data
being intermixed in code. If GNU compiler collection (GCC) generated code is
included (from a static library), inspect the output binary to
ensure that constants have not been pooled into code sections.</p>

<p>If code introspection is necessary on executable code sections,
first call <code>mprotect</code> to mark the code readable. Then after the operation
is complete, call <code>mprotect</code> again to mark it unreadable.</p>

<h3 id="enabling">Enabling</h3>
<p>Execute-only is enabled by default for all 64-bit binaries in the build
system. </p>

<h3 id="disabling">Disabling</h3>
<p>You can disable execute-only at a module level, by an entire subdirectory tree, or
globally for an entire build.</p>

<p>XOM can be disabled for individual modules that can't be refactored, or need to read their
executable code, by setting the <code>LOCAL_XOM</code>
and <code>xom</code> variables to <code>false</code>.</p>

<pre class="prettyprint">
// Android.mk
LOCAL_XOM := false

// Android.bp
cc_binary { // or other module types
   ...
   xom: false,
}
</pre>

<p>If execute-only memory is disabled in a static library, the build system applies
this to all dependent modules of that static library. You can override
this by using <code>xom: true,</code>.</p>

<aside class="caution"><b>Caution:</b> Don't override the build system defaults
if the execute-only incompatible code is being used in the dependent module.
</aside>

<p>To disable execute-only memory in a particular subdirectory (for example,
foo/bar/), pass the value to <code>XOM_EXCLUDE_PATHS</code>.</p>

<pre class="prettyprint">
make -j XOM_EXCLUDE_PATHS=foo/bar
</pre>

<p>Alternatively, you can set the <code>PRODUCT_XOM_EXCLUDE_PATHS</code>
variable in your product configuration.</p>

<p>You can disable execute-only binaries globally by passing
<code>ENABLE_XOM=false</code> to your <code>make</code> command.</p>

<pre class="prettyprint">
make -j ENABLE_XOM=false
</pre>

<h3 id="validation">Validation</h3>
<p>There are no CTS or verification tests available for execute-only
memory. You can manually verify binaries using <code>readelf</code> and checking
the segment flags.</p>

</body>
</html>
