<html devsite>
  <head>
    <title>Privileged Permission Whitelisting</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
{% include "_versions.html" %}
  <body>
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>Privileged apps are system apps that are located in a
<code>priv-app</code> directory on one of the system image partitions. The
partitions used for Android releases are</p>
<ul>
<li>Android 8.1 and lower - <code>/system</code></li>
<li>Android 9 and higher - <code>/system, /product, /vendor</code></li>
</ul>

<p>Throughout this page, <code>/etc/permissions/priv-app</code> resolves to
<code><var>partition</var>/etc/permissions/priv-app</code>.</p>
<p>Historically, device manufacturers had little control over which
<strong>signature|privileged</strong> permissions could be granted to
privileged apps. Starting in Android 8.0, manufacturers must explicitly grant
privileged permissions in the system configuration XML files in the
<code>/etc/permissions</code> directory. As of Android 9, implementors must
explicitly grant or deny all privileged permissions or the device won’t
boot.</p>

<p>The <code>privapp-permissions.xml</code> file can only grant or deny
permissions for privileged apps on the same partition. For example, if
an app on the <code>/vendor</code> partition requests privileged permissions,
the request can only be granted or denied by a
<code>privapp-permissions.xml</code> file that’s also on
<code>/vendor</code>.</p>

<aside class="note">
  <strong>Note:</strong> Only permissions defined by the core platform
  (the "android" package) must be whitelisted. Privileged
  permissions defined by device manufacturers will still be
  automatically granted. Only list apps in the
<code>privapp-permissions.xml</code> file that actually exist on the partition.
If an application isn’t on the partition, the entry is ignored.
</aside>

<h2 id="adding-whitelists">Adding whitelists</h2>
<p>
  Permission whitelists for apps can be listed in a single XML or in multiple
  XML files located in the <code>frameworks/base/etc/permissions</code>
  directory as follows:
</p>

<ul>
  <li><code>/etc/permissions/privapp-permissions-<var>OEM_NAME</var>.xml</code>
  <li><code>/etc/permissions/privapp-permissions-<var>DEVICE_NAME</var>.xml</code>
</ul>

<p>There is no strict rule for organizing content. Device implementers can
  determine content structure as long as all apps from
  <code>/system/priv-app</code> are whitelisted. For example, Google has a
  single whitelist for all privileged apps developed by Google, and
  recommends the following organization:
</p>

<ul>
  <li>Permissions for apps that are already included in the Android Open Source
    Project (AOSP) tree are listed in
  <code>/etc/permissions/privapp-permissions-platform.xml</code>.</li>
  <li>Permissions for Google apps are listed in
  <code>/etc/permissions/privapp-permissions-google.xml</code>.</li>
  <li>For other apps, use files of the form:
  <code>/etc/permissions/privapp-permissions-<var>DEVICE_NAME</var>.xml</code>.
  </li>
</ul>

<h3 id="generating-whitelists">Generating whitelists</h3>

<p>
  To automatically generate a whitelist for all apps available on the
  system image, use the AOSP command line tool at
  <code>development/tools/privapp_permissions/privapp_permissions.py</code>. To
  generate an initial version of device-specific
  <code>privapp-permissions.xml</code>:
</p>

<ol>
  <li>Build a system image:
  <pre class="devsite-click-to-copy">
    <code class="devsite-terminal">. build/envsetup.sh</code>
    <code class="devsite-terminal">lunch <var>PRODUCT_NAME</var></code>
    <code class="devsite-terminal">make -j</code></pre>
    </li>
  <li>Run the <code>privapp_permissions.py</code> script to generate a
    <code>privapp-permissions.xml</code>file that lists all
    signature|privileged permissions required to be whitelisted:
    <pre class="devsite-terminal devsite-click-to-copy">development/tools/privapp_permissions/privapp_permissions.py</pre>
    This tool prints XML content that can be used either as a single file, or split into
    multiple files in the <code>/etc/permissions</code> directory path.
    If the device already includes whitelists in the
    <code>/etc/permissions</code> directories, the tool only prints the differences
    only (such as the missing signature|privileged permissions you need to add to the
    whitelist). This is also useful for audit purposes: When a new version of
    the app is added, the tool detects the additional permissions needed.
  </li>
  <li>Copy the generated files to the appropriate <code>/etc/permissions</code> directory,
    where the system reads the files during boot.</li>
</ol>

<h3 id="customizing-whitelists">Customizing whitelists</h3>

<p>
  AOSP includes a whitelist implementation that can be customized as needed.
  Permissions for apps included in AOSP are already whitelisted in
  <code>/etc/permissions/privapp-permissions-platform.xml</code>.
</p>

<p>
  By default, the <code>privapp_permissions.py</code> script generates output
  that automatically grants any permission requested by a privileged
  application. If there are permissions that should be denied, edit the XML to
  use a "deny-permission" tag instead of a "permission" tag. Example:
</p>

    <pre class="prettyprint">&lt;!--
    This XML file declares which signature|privileged permissions should be
    granted to privileged apps that come with the platform
    -->
    &lt;permissions>
&lt;privapp-permissions package="com.android.backupconfirm">
    &lt;permission name="android.permission.BACKUP"/>
    &lt;permission name="android.permission.CRYPT_KEEPER"/>
&lt;/privapp-permissions>
&lt;privapp-permissions package="com.android.cellbroadcastreceiver">
    &lt;!-- don't allow application to interact across users -->
    &lt;deny-permission name="android.permission.INTERACT_ACROSS_USERS"/>
    &lt;permission name="android.permission.MANAGE_USERS"/>
    &lt;permission name="android.permission.MODIFY_PHONE_STATE"/>
    &lt;permission name="android.permission.READ_PRIVILEGED_PHONE_STATE"/>
    &lt;permission name="android.permission.RECEIVE_EMERGENCY_BROADCAST"/>
&lt;/privapp-permissions>
    ...</pre>

<h3 id="finding-missing-permissions">Finding missing permissions</h3>

<p>
  To find missing permisisons when bringing up a new device, enable
  transitional log mode:
</p>

<pre class="devsite-click-to-copy">ro.control_privapp_permissions=log</pre>

<p>
  Violations are reported in the log file, but nonprivileged permissions are still granted.
  This keeps the device in a working state while providing the list of
  violations. This is the error message format:
</p>

<pre class="devsite-click-to-copy">
PackageManager: Privileged permission {PERMISSION_NAME} for package {PACKAGE_NAME} - not in privapp-permissions whitelist
</pre>

<p>
  All violations must be addressed by adding the missing permissions to the
  appropriate whitelists.
</p>
    <ul>
      <li>On Android 8.0 and lower, the affected apps aren’t granted the missing
        permissions even if they are in the <code>priv-app</code> path.</li>
      <li>On Android 9 and higher, violations (of <em>privileged</em> permissions)
        mean the <strong>device doesn’t boot</strong>. You must <em>explicitly</em>
        either allow or deny <em>all privileged</em> permissions</li>
    </ul>


<h2 id="enforcing-whitelists">Enforcing whitelists</h2>

<p>
  After whitelists are in place, enable runtime enforcement by setting the build
  property <code>ro.control_privapp_permissions=enforce</code>.
</p>

<aside class="note"><strong>Note:</strong> Whitelisting is required only for
  permissions declared by applications with package="android". The
  <code>ro.control_privapp_permissions</code> property state must adhere to
  <a href="/compatibility/android-cdd#9_1_permissions">CDD section 9.1
  requirements</a>.</aside>

  </body>
</html>
