Project: /_project.yaml
Book: /_book.yaml

{% include "_versions.html" %}

<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

# AHardwareBuffer

AHardwareBuffer is a type of shared memory that wraps a
[gralloc buffer](/devices/graphics/arch-bq-gralloc). In Android
{{ androidQVersionNumber }}, the Neural Networks API (NNAPI) supports using
[AHardwareBuffer](https://developer.android.com/ndk/reference/group/a-hardware-buffer){:.external},
allowing the driver to perform executions without copying data, which improves
performance and power consumption for apps. For example, a camera HAL
stack can pass AHardwareBuffer objects to the NNAPI for machine learning
workloads using AHardwareBuffer handles generated by camera NDK and media NDK
APIs. For more information, see
[`ANeuralNetworksMemory_createFromAHardwareBuffer`](https://developer.android.com/ndk/reference/group/neural-networks#aneuralnetworksmemory_createfromahardwarebuffer){:.external}.

AHardwareBuffer objects used in NNAPI are passed to the driver through a
`hidl_memory` struct named either `hardware_buffer` or `hardware_buffer_blob`.
The `hidl_memory` struct `hardware_buffer_blob` only represents AHardwareBuffer
objects with the `AHARDWAREBUFFER_FORMAT_BLOB` format.

The information required by the framework is encoded in the `hidl_handle` field
of the `hidl_memory` struct. The `hidl_handle` field wraps `native_handle`,
which encodes all of the required metadata about AHardwareBuffer or Gralloc
buffer.

The driver must properly decode the provided `hidl_handle` field and access the
memory described by `hidl_handle`. When the `getSupportedOperations_1_2`,
`getSupportedOperations_1_1`, or `getSupportedOperations` method is
called, the driver should detect whether it can decode the provided
`hidl_handle` and access the memory described by `hidl_handle`. The model
preparation must fail if the `hidl_handle` field used for a constant operand
isn't supported. The execution must fail if the `hidl_handle` field used for an
input or output operand of the execution isn't supported. It's recommended
for the driver to return a `GENERAL_FAILURE` error code if the model preparation
or execution fails.
