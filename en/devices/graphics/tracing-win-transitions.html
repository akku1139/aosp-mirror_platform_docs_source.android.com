<html devsite>
  <head>
    <title>Tracing Window Transitions</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>WinScope provides the infrastructure and tools
to record and analyze WindowManager and SurfaceFlinger states during and after
window transitions. WinScope records all pertinent system service states to a
trace file, which you can use to replay and step through the transitions.</p>

<h2 id="capture_trace">Capturing traces</h2>

<p>Capture traces through <strong>Quick Settings</strong> or
<code>adb</code> on devices running userdebug or eng builds.</p>

<h3 id="quick_settings">Quick settings</h3>

<p>To capture traces from <strong>Quick Settings</strong>:</p>

<ol>
  <li><a href="https://developer.android.com/studio/debug/dev-options#enable"
           class="external">Enable developer options</a>.</li>
  <li>Go to <strong>Developer options</strong> &gt; <strong>Quick settings
      developer tiles</strong>.</li>
  <li>Enable <strong>WinScope Trace</strong>.</li>
  <li>Open <strong>Quick Settings</strong>.</li>
  <li>Tap <strong>Winscope Trace</strong> to enable tracing.</li>
  <li>Run window transitions on the device.</li>
  <li>After you are finished, open <strong>Quick Settings</strong> and
tap <strong>Winscope Trace</strong> to disable tracing.</li>
</ol>

<p>Traces are written to <code>/data/misc/wmtrace/wm_trace.pb</code> and
<code>/data/misc/wmtrace/layers_trace.pb</code>. Traces are also included in
bug reports.</p>

<h3 id="adb"><code>adb</code></h3>

<p>When capturing traces through <code>adb</code>, capture
WindowManager and SurfaceFlinger traces separately.</p>

<h4 id="wm-traces">WindowManager traces</h4>

<p>To capture WindowManager traces:</p>

<ol>
  <li>Enable trace:
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing start</pre>
  </li>
  <li>Disable trace: <pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing stop</pre>
    </li>
    <li>Take the trace file:
     <pre class="devsite-terminal devsite-click-to-copy">
adb pull /data/misc/wmtrace/wm_trace.pb wm_trace.pb</pre>
  </li>
</ol>

<p>You can optionally change the default log configuration of various settings
for WindowManager traces:</p>

<ul>
  <li>Set the log frequency (for the transaction or frame):
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing [<var>frame</var>&hairsp;|&hairsp;<var>transaction</var>]</pre></li>
  <li>Configure the verbose level for log entries:
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing level [<var>all</var>&hairsp;|&hairsp;<var>trim</var>&hairsp;|&hairsp;<var>critical</var>]</pre></li>
  <li>Set the maximum buffer size (in KB):
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing size <var>size-value</var></pre></li>
  <li>Dump the buffer status, log level, remaining capacity, and number of
    elements:
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing status</pre></li>
</ul>

<h4 id="sf-traces">SurfaceFlinger traces</h4>

<p>To capture SurfaceFlinger traces:</p>

<ol>
  <li>Enable trace:
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1025 i32 1</pre>
  </li>
  <li>Disable trace:
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1025 i32 0</pre>
  </li>
  <li>Take the trace file:
    <pre class="devsite-terminal devsite-click-to-copy">
adb pull /data/misc/wmtrace/layers_trace.pb layers_trace.pb</pre>
  </li>
</ol>

<p>You can optionally change the default log configuration of various settings
for SurfaceFlinger traces:</p>

<ul>
  <li>Set the maximum buffer size (in KB):
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1029 i32 <var>size-value</var></pre></li>
  <li>Configure the verbose level for log entries:
    <pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1033 i32 <var>flags</var></pre></li>
</ul>

<h3 id="capture_trace_gen_state">Generating state dumps</h3>

<p>WinScope reads a snapshot of WindowManager and SurfaceFlinger states
from bug reports. The bug reports store the states as separate proto files
inside the <code>proto</code> folder. To generate the state dumps using
<code>adb</code>, run the following commands.</p>

<p><strong>WindowManager</strong><p>

<pre class="devsite-terminal devsite-click-to-copy">
adb exec-out dumpsys window --proto > window_dump.pb</pre>

<p><strong>SurfaceFlinger</strong><p>

<pre class="devsite-terminal devsite-click-to-copy">
adb exec-out dumpsys SurfaceFlinger --proto > sf_dump.pb</pre>

<h2 id="analyze_traces">Analyzing traces</h2>

<p>To analyze a trace file, use the WinScope web app. Build the app can from
the source or open it from the prebuilt directory.</p>

<ol>
  <li>Download prebuilt artifacts from the Android source repository:
    <pre class="devsite-terminal devsite-click-to-copy">
curl 'https://android.googlesource.com/platform/prebuilts/misc/+/master/common/winscope/winscope.html?format=TEXT' | base64 -d > winscope.html</pre></li>
  <li>Open the downloaded artifacts in a web browser.</li>
  <li>After WinScope opens, select <strong>OPEN FILE</strong> to load a trace
    file.</li>
</ol>

<h3 id="using_winscope">Using WinScope</h3>

<p>After opening a trace file in WinScope, you can analyze the trace in several
ways.</p>

<img src="images/winscope_screenshot.png" alt="WinScope Screenshot">
<figcaption><strong>Figure 1.</strong> Analyzing a trace in WinScope</figcaption>

<ul>
  <li><strong>Timeline</strong> &mdash; Shows the sequence of events in the
    trace. Use the arrow keys or click each entry to
    navigate through the timeline.</li>
  <li><strong>Screen</strong> &mdash; Provides a visual representation of every
    visible window on the screen. Click a window to select the source window in
    the hierarchy.</li>
  <li><strong>Hierarchy</strong> &mdash; Represents each window known to the
    system. Some windows don't contain buffers, but exist to set policies on
    the window's children. Visible windows are marked with the <code>V</code> icon.</li>
  <li><strong>Properties</strong> &mdash; Shows state information for the
    selected entry in the hierarchy.</li>
</ul>

 </body>
</html>
