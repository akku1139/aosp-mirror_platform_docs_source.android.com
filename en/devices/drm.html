<html devsite>
  <head>
    <title>DRM</title>
    <meta name="project_path" value="/_project.yaml" />
    <meta name="book_path" value="/_book.yaml" />
  </head>
  <body>
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<img style="float: right; margin: 0 15px 15px 15px;" src="images/ape_fwk_hal_drm.png"
     alt="Android DRM HAL icon"/>

<p>This document provides an overview of the Android digital rights management (DRM) framework and
introduces the interfaces that a DRM plugin must implement. This document doesn't
describe robustness rules or compliance rules that may be defined by a DRM
scheme.</p>

<h2 id="framework">Framework</h2>

<p>The Android platform provides an extensible DRM framework that lets
apps manage rights-protected content according to the license
constraints associated with the content. The DRM framework supports many DRM
schemes; which DRM schemes a device supports is up to the device manufacturer.
The DRM framework provides a unified interface for application developers and
hides the complexity of DRM operations. The DRM framework provides a consistent
operation mode for protected and nonprotected content. DRM schemes can define
complex usage models by license metadata. The DRM framework provides the
association between DRM content and license, and handles the rights management.
This enables the media player to be abstracted from DRM-protected or
nonprotected content. See <a
  href="https://developer.android.com/reference/android/media/MediaDrm.html"
class="external">MediaDrm</a>
for the class to obtain keys for decrypting protected media streams.</p>

 <img src="/devices/images/ape_fwk_drm.png" alt="Android DRM HAL" />

<figcaption><strong>Figure 1.</strong> DRM hardware abstraction
Layer</figcaption>

<p>
The availability of rich digital content is important to users on mobile devices. To
make their content widely available, Android developers and digital content
publishers need a consistent DRM implementation supported across the Android
ecosystem. To make that digital content available on Android devices and to
ensure that there's at least one consistent DRM available across all devices, Google provides
DRM without license fees on compatible Android devices. The DRM plugin is
integrated with the Android DRM framework and can use hardware-backed protection
to secure premium content and user credentials.
</p>

<p>
The content protection provided by the DRM plugin depends on the security and
content protection capabilities of the underlying hardware platform. The
hardware capabilities of the device should include hardware secure boot to
establish a chain of trust of security and protection of cryptographic keys.
Content protection capabilities of the device should include protection of
decrypted frames in the device and content protection through a trusted output
protection mechanism. Not all hardware platforms support all of the above
security and content protection features. Security is never implemented in a
single place in the stack, but instead relies on the integration of hardware,
software, and services. The combination of hardware security functions, a
trusted boot mechanism, and an isolated secure OS for handling security
functions is critical to providing a secure device.</p>


<h2 id="architecture">Architecture</h2>
<p>The DRM framework is designed to be implementation agnostic and
abstracts the details of the specific DRM scheme implementation in a
scheme-specific DRM plugin. The DRM framework includes simple APIs to handle
complex DRM operations, acquire licenses, provision the device,
associate DRM content and its license, and finally decrypt DRM content.</p>

<p>The Android DRM framework is implemented in two architectural layers:</p>
<ul>
<li>A DRM framework API, which is exposed to apps through the Android
  application framework.</li>
<li>A native code DRM framework, which exposes an interface for DRM plugins (agents)
  to handle rights management and decryption for various DRM schemes.</li>
</ul>

<img src="images/ape_fwk_drm_2.png" alt="Android DRM Framework" />

<figcaption><strong>Figure 2.</strong> DRM framework</figcaption>

<p>See <a href=
"https://developer.android.com/reference/android/media/MediaDrm.html" class="external">Android
Media DRM</a> and
<a href="https://developer.android.com/reference/android/media/MediaCrypto.html" class="external">
Android Media Crypto</a> for more details.</p>

<h2 id="drm-plugins">DRM Plugins</h2>
<p>At system startup, the DRM framework scans for HAL instances/services (described in <code>.rc
</code> files)
and plugins are discovered through the HIDL registry. Media DRM Server
(<code>mediadrmserver</code>) creates both <code>CryptoHal</code> and <code>DrmHal</code> objects.
<code>CryptoHal</code> and <code>DrmHal</code> then call the plugins with vendor-
specific implementations.
</p>

<p>plugins should implement binderized HALs. Binderized HALs use the
<a href="/devices/architecture/hidl">HAL interface definition language (HIDL)</a>,
which allows the framework to be replaced without having to rebuild HALs.</p>

<p>plugins are built by vendors or SOC makers and put in a <code>/vendor</code> partition on
the device. All devices launching with Android 8.0 or higher must support binderized HALs written
in the HIDL language.</p>

<h2 id="implementation">Implementation</h2>

<p>To implement new DRM frameworks APIs by a plugin:</p>
<ol>
  <li>Add plugin service to the deviceâ€™s build files.</li>
  <li>Update the device manifest.</li>
  <li>Add SELinux permissions.</li>
  <li>Create a <code>.rc</code> file under <code>/vendor</code>.</li>
  <li>Implement the plugin.</li>
</ol>

<p>New APIs are defined in <code>iDrmPlugin.hal</code> and <code>iCryptoPlugin.hal</code>.</p>
<pre class="devsite-click-to-copy">
<var>PLATFORM_ROOT</var>/hardware/interfaces/drm/<var>VERSION</var>/
</pre>

<h3 id="add-plugin">Addding plugin service to device build files</h3>
    <p>For example, to add interface 1.2 support,
    the <code><var>VENDOR DEVICE</var>/device.mk</code> file must include the
      <code>android.hardware.drm@1.2-service.*</code> packages:</p>

<pre class="devsite-click-to-copy">
<xmp>
  PRODUCT_PACKAGES += \
    android.hardware.drm@1.0-impl \
    android.hardware.drm@1.0-service \
    android.hardware.drm@1.2-service.clearkey \
    android.hardware.drm@1.2-service.widevine
</xmp>
</pre>

<h3 id="update-manifest">Updating the device manifest</h3>
<p>The <code>vendor manifest.xml</code> file for the device must include the following entries:</p>

<pre class="devsite-click-to-copy">
<xmp>
  <hal format="hidl">
    <name>android.hardware.drm</name>
      <transport>hwbinder</transport>
      <version>1.0</version>
      <interface>
        <name>ICryptoFactory</name>
        <instance>default</instance>
      </interface>
      <interface>
        <name>IDrmFactory</name>
        <instance>default</instance>
      </interface>
      <fqname>@1.2::ICryptoFactory/clearkey</fqname>
      <fqname>@1.2::IDrmFactory/clearkey</fqname>
      <fqname>@1.2::ICryptoFactory/widevine</fqname>
      <fqname>@1.2::IDrmFactory/widevine</fqname>
  </hal>
</xmp>
</pre>

<h3 id="add-selinux">Adding SELinux permissions</h3>
<ol>
<li>Add to <code><var>VENDOR DEVICE</var>/sepolicy/vendor/file.te</code><br>
    <pre class="prettyprint">type mediadrm_vendor_data_file, file_type, data_file_type;</pre>
  </li>
  <li>Add to <code><var>VENDOR DEVICE</var>/sepolicy/vendor/file_contexts</code><br>
    <pre class="prettyprint">/vendor/bin/hw/android\.hardware\.drm@1\.2-service\.clearkey
      u:object_r:hal_drm_clearkey_exec:s0<br>
    /data/vendor/mediadrm(/.*)? u:object_r:mediadrm_vendor_data_file:s0
    </pre>
  </li>
  <li>Add to <code>device/sepolicy/vendor/hal_drm_clearkey.te</code><br>
    <pre class="prettyprint">allow hal_drm_clearkey mediadrm_vendor_data_file:dir create_dir_perms;
    allow hal_drm_clearkey mediadrm_vendor_data_file:file create_file_perms;
    </pre>
  </li>
</ol>

<h3 id="create-rc">Creating an .rc file under /vendor</h3>
<p>The <code>.rc</code> file specifies the actions to be taken when a service is launched.</p>
<p>See
  <a href="https://android.googlesource.com/platform/system/core/+/master/init/README.md"
        class="external">Android Init Language</a> for details.
</p>

<h3 id="implement-plugin">Implementing the plugin</h3>
<ol>
<li>Implement the <code>main()</code> entry point in <code>service.cpp</code> of the plugin
service.</li>
<li>Implement <code>CryptoFactory</code> and <code>DrmFactory</code>.</li>
  <li>Implement the new APIs in the plugin.</li>
</ol>

<h2 id="drm-plugin-details">DRM plugin details</h2>
<p>DRM plugin vendors implement <code>DrmFactory</code>, <code>CryptoFactory</code>, and
DRM plugin.</p>

<h3 id="drmFactory">DrmFactory</h3>
<p>The <code>DrmHal</code> class searches for registered DRM plugin services and constructs
corresponding plugins that support a given crypto scheme through the <code>DrmFactory</code>
class.</p>

<pre class="devsite-click-to-copy prettyprint">
Return&lt;bool&gt; isCryptoSchemeSupported(const hidl_array&lt;uint8_t, 16&gt;uuid);
</pre>
<p>Determines if the plugin factory is able to construct DRM plugins that support a
  given crypto scheme, which is specified by a UUID.</p>

<pre class="devsite-click-to-copy prettyprint">
Return&lt;bool&gt; isContentTypeSupported(const hidl_string &amp;mimeType);
</pre>
<p>Determines if the plugin factory is able to construct DRM plugins that support a
given media container format specified by <code>mimeType</code>.</p>

<pre class="devsite-click-to-copy prettyprint">
Return&lt;void&gt; createPlugin(const hidl_array&lt;uint8_t, 16&gt;uuid,
        const hidl_string&amp; appPackageName, createPlugin_cb _hidl_cb);
</pre>
<p>Construct a DRM plugin for the crypto scheme specified by UUID.</p>

<h3 id="cryptoFactory">CryptoFactory</h3>
<p>The <code>CryptoHal</code> class searches for registered DRM plugin services and constructs
corresponding plugins that support a given crypto scheme through the <code>CryptoFactory</code>
class.</p>

<pre class="devsite-click-to-copy prettyprint">
Return&lt;bool&gt; isCryptoSchemeSupported(const hidl_array&lt;uint8_t, 16&gt;uuid);
</pre>
<p>Determines if the crypto factory is able to construct crypto plugins that support a
  given crypto scheme, which is specified by a UUID.</p>

<pre class="devsite-click-to-copy prettyprint">
Return&lt;void&gt; createPlugin(const hidl_array&lt;uint8_t, 16&gt;uuid,
        const hidl_vec&lt;uint8_t&gt;initData, createPlugin_cb _hidl_cb)
</pre>
<p>Determines if the plugin factory is able to construct crypto plugins that support a
  given crypto scheme, which is specified by a UUID.</p>

<h3 id="drm-plugin">DRM plugin</h3>
The APIs are defined in <code>hardware/interfaces/drm/<var>VERSION</var>
/IDrmPlugin.hal</code>. The corresponding <code>IDrmPlugin.h</code> file can be found in
out/Soong after the build.

  </body>
</html>

