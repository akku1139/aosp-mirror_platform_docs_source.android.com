<html devsite>
<head>
  <title>Building Kernels</title>
  <meta name="project_path" value="/_project.yaml" />
  <meta name="book_path" value="/_book.yaml" />
</head>
<body>
<!--
    Copyright 2017 The Android Open Source Project

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<p>This page details the process of building custom
   <a href="/devices/architecture/kernel/">kernels</a> for Android devices. The
   following instructions guide you through the process of selecting the right
   sources, building the kernel, and embedding the results into a system image
   built from the Android Open Source Project (AOSP).</p>

<p>More recent kernel sources can be acquired using
   <a href="/setup/develop/repo#init">Repo</a> and be built without further
   configuration by running <code>build/build.sh</code> from the root of your
   source checkout.</p>

<aside class="note"><strong>Note:</strong>The root of the kernel source checkout contains
<code>build/build.sh</code>. The Android tree contains only prebuilt kernel
binaries. The kernel trees contain the kernel sources and all tools to build
the kernels, including this script.</aside>

<p>For older kernels or kernels not listed below, refer to the instructions on
   how to build
   <a href="/setup/build/building-kernels-deprecated">legacy kernels</a>.</p>

<h2 id="downloading">Downloading sources and build tools</h2>

<p>For recent kernels, use <a href="/setup/develop/repo#init"><code>repo</code></a>
  to download the sources, toolchain, and build scripts.
   Some kernels (for example, the Pixel 3 kernels) require sources from multiple git
   repositories, while others (for example, the common kernels) require only a single
   source. Using the <code>repo</code> approach ensures a correct source
   directory setup.</p>

<p>Download the sources for the appropriate branch:</p>

<pre class="devsite-terminal devsite-click-to-copy">repo init -u https://android.googlesource.com/kernel/manifest -b <var>BRANCH</var></pre>
<pre class="devsite-terminal devsite-click-to-copy">repo sync</pre>

<p>The following table lists the <var>BRANCH</var> names for kernels available
   through this method.</p>
   <table>
       <tr>
            <th>Device</th>
            <th>Binary path in AOSP tree</th>
            <th>Repo branches</th>
       </tr>
       <tr>
            <td>Pixel 3a (sargo)<br/>Pixel 3a XL (bonito)</td>
            <td>device/google/bonito-kernel</td>
            <td>android-msm-bonito-4.9-pie-b4s4</td>
       </tr>
      <tr>
            <td>Pixel 3 (blueline)<br/>Pixel 3 XL (crosshatch)</td>
            <td>device/google/crosshatch-kernel</td>
            <td>android-msm-crosshatch-4.9-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel 2 (walleye)<br/>Pixel 2 XL (taimen)</td>
            <td>device/google/wahoo-kernel</td>
            <td>android-msm-wahoo-4.4-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel (sailfish)<br/>Pixel XL (marlin)</td>
            <td>device/google/marlin-kernel</td>
            <td>android-msm-marlin-3.18-pie-qpr2</td>
       </tr>
       <tr>
            <td>Hikey / Hikey960</td>
            <td>device/linaro/hikey-kernel</td>
            <td>hikey-linaro-android-4.4<br/>
                hikey-linaro-android-4.9<br/>
                hikey-linaro-android-4.14<br/>
                hikey-linaro-android-4.19
            </td>
       </tr>
       <tr>
            <td>Beagle x15</td>
            <td>device/ti/beagle_x15-kernel</td>
            <td>omap-beagle-x15-android-4.14<br/>
                omap-beagle-x15-android-4.19
            </td>
       </tr>
       <tr>
            <td>Beagle x15</td>
            <td>device/ti/beagle_x15-kernel</td>
            <td>omap-beagle-x15-android-4.14<br/>
                omap-beagle-x15-android-4.19
            </td>
       </tr>
       <tr>
            <td>Android Common Kernel</td>
            <td>N/A</td>
            <td>common-android-4.4<br/>
                common-android-4.9<br/>
                common-android-4.14<br/>
                common-android-4.19<br/>
                common-android-mainline
            </td>
       </tr>
   </table>

<aside class="note"><b>Note:</b>
    You can switch among different branches within one Repo checkout. The
    common kernel manifests (and most others) define the kernel git repository
    to be cloned fully (not shallow), which enables fast switching among them.
    Switching to a different branch is similar to initializing a branch; the
    <code>-u</code> parameter is optional. For example, to switch to
    <code>common-android-mainline</code> from your existing Repo checkout,
    run:</br>
    <code>$ repo init -b common-android-mainline &amp;&amp; repo sync</code>.
</aside>

<h2 id="building">Building the kernel</h2>

<p>Then build the kernel with:</p>

<pre class="devsite-terminal devsite-click-to-copy">build/build.sh</pre>

<aside class="note"><strong>Note:</strong> Common kernels are generic, customizable kernels
                and therefore don't define a default configuration. See
                <a href="#customize-build">Customize the kernel build</a>
                to find out how to specify the build configuration for
                common kernels.</aside>

<p>The kernel binary, modules, and corresponding image are located in the
   <code>out/<var>BRANCH</var>/dist</code> directory.</p>

<h2 id="running">Running the kernel</h2>

<p>There are multiple ways to run a custom-built kernel. The following are
   known ways suitable for various development scenarios.</p>

<h3 id="embedding-into-Android">Embedding into the Android image build</h3>

<p>Copy <code>Image.lz4-dtb</code> to the respective kernel binary location
   within the AOSP tree and rebuild the boot image.</p>

<p>Alternatively, define the <code>TARGET_PREBUILT_KERNEL</code>
   variable while using <code>make bootimage</code> (or any other
   <code>make</code> command line that builds a boot image). This variable is
   supported by all devices as it's set up via
   <code>device/common/populate-new-device.sh</code>. For example:</p>

<pre class="devsite-terminal devsite-click-to-copy">
export TARGET_PREBUILT_KERNEL=<var>DIST_DIR</var>/Image.lz4-dtb
</pre>

<h3 id="flashing-fastboot">Flashing and booting kernels with fastboot</h3>
<p>Most recent devices have a bootloader extension to streamline the process of
   generating and booting a boot image.</p>

<p>To boot the kernel without flashing:</p>

<pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb reboot bootloader</code>
<code class="devsite-terminal">fastboot boot Image.lz4-dtb</code>
</pre>

<p>Using this method, the kernel isn't actually flashed, and won't persist
across a reboot.</p>

<aside class="note"><strong>Note:</strong> Kernel names differ by device. To locate
the correct filename for your kernel, refer to
<code>device/<var>VENDOR</var>/<var>NAME</var>-kernel</code> in the AOSP tree.</aside>

<h2 id="customize-build">Customizing the kernel build</h2>

<p>The build process and outcome can be influenced by environment variables.
   Most of them are optional and each kernel branch should come with a proper
   default configuration. The most frequently used ones are listed here. For a
  complete (and up-to-date) list, refer to <code>build/build.sh</code>.</p>

   <table>
       <tr>
            <th>Environment variable</th>
            <th>Description</th>
            <th>Example</th>
       </tr>
       <tr>
            <td><code>BUILD_CONFIG</code></td>
            <td>Build config file to initialize the build environment from.
                The location is to be defined relative to the Repo root
                directory. Defaults to <code>build.config</code>.</br>
                <b>Mandatory for common kernels.</b>
            </td>
            <td><code>BUILD_CONFIG=common/build.config.cuttlefish.x86_64</code></td>
       </tr>
       <tr>
            <td><code>OUT_DIR</code></td>
            <td>Base output directory for the kernel build.</td>
            <td><code>OUT_DIR=/path/to/my/out</code></td>
       </tr>
       <tr>
            <td><code>DIST_DIR</code></td>
            <td>Base output directory for the kernel distribution.</td>
            <td><code>OUT_DIR=/path/to/my/dist</code></td>
       </tr>
       <tr>
            <td><code>CC</code></td>
            <td>Override compiler to be used. Falls back to the default
                compiler defined by <code>build.config</code>.</td>
            <td><code>CC=clang</code></td>
       </tr>
       <tr>
            <td><code>SKIP_MRPROPER</code></td>
            <td>Skip <code>make mrproper</code></td>
            <td><code>SKIP_MRPROPER=1</code></td>
       </tr>
       <tr>
            <td><code>SKIP_DEFCONFIG</code></td>
            <td>Skip <code>make defconfig</code></td>
            <td><code>SKIP_DEFCONFIG=1</code></td>
       </tr>
   </table>
</p>

<h2 id="customize-config">Custom kernel config for local builds</h2>

<p>If you need to switch a kernel configuration option regularly, for example,
   when working on a feature, or if you need an option to be set for development
   purposes, you can achieve that flexibility by maintaining a local
   modification or copy of the build config.</p>
<p>Set the variable <var>POST_DEFCONFIG_CMDS</var> to a statement that is
   evaluated right after the usual <code>make defconfig</code> step is
   done. As the <code>build.config</code> files are sourced into the build
   environment, functions defined in <code>build.config</code> can be called
   as part of the post-defconfig commands.</p>
<p>A common example is disabling link time optimization (LTO) for crosshatch
   kernels during development. While LTO is beneficial for released kernels,
   the overhead at build time can be significant. The following snippet added
   to the local <code>build.config</code> disables LTO persistently when
   using <code>build/build.sh</code>.</p>
<pre class="devsite-click-to-copy">
<code>POST_DEFCONFIG_CMDS="check_defconfig && update_debug_config"
function update_debug_config() {
    ${KERNEL_DIR}/scripts/config --file ${OUT_DIR}/.config \
         -d LTO \
         -d LTO_CLANG \
         -d CFI \
         -d CFI_PERMISSIVE \
         -d CFI_CLANG
    (cd ${OUT_DIR} && \
     make O=${OUT_DIR} $archsubarch CC=${CC} CROSS_COMPILE=${CROSS_COMPILE} olddefconfig)
}</code>
</pre>


<h2 id="id-version">Identifying kernel versions</h2>
<p>There are two ways to identify the correct version to build.<p>

<h3 id="id-version-from-aosp">Kernel version from AOSP tree</h3>
<p>The AOSP tree contains prebuilt kernel versions. Most of the time the git
   log reveals the correct version as part of the commit message:</p>
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">cd $AOSP/device/<var>VENDOR</var>/<var>NAME</var></code>
<code class="devsite-terminal">git log --max-count=1</code>
</pre>

<h3 id="id-version-from-system-image">Kernel version from system image</h3>

<p>To determine the kernel version used in a system image, run the following
   command against the kernel file:
<pre class="devsite-terminal devsite-click-to-copy">
file kernel
</pre></p>

<p>For <code>Image.lz4-dtb</code> files, run:</p>
<pre class="devsite-terminal devsite-click-to-copy">
grep -a 'Linux version' Image.lz4-dtb
</pre>


</body>
</html>
