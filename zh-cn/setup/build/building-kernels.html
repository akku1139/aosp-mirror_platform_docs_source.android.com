<html devsite><head>
  <title>编译内核</title>
  <meta name="project_path" value="/_project.yaml"/>
  <meta name="book_path" value="/_book.yaml"/>
</head>
<body>

<!--
    Copyright 2017 The Android Open Source Project

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<p>本文详细介绍了为 Android 设备编译自定义<a href="/devices/architecture/kernel/">内核</a>的流程。以下说明会逐步指导您如何选择正确的源代码，编译内核，以及将结果嵌入到根据 Android 开源项目 (AOSP) 编译的系统映像中。</p>

<p>您可以使用 <a href="/setup/develop/repo#init">repo</a> 获取最新的内核源代码，并通过运行从源代码检出的根目录中的 <code>build/build.sh</code> 来编译这些内核源代码，而无需更多配置。</p>

<p class="note">内核源代码检出的根目录包含 <code>build/build.sh</code>。Android 树仅包含预编译的内核二进制文件。内核树包含内核源代码和用于编译内核的所有工具，包括此脚本。</p>

<p>对于较旧的内核或下文未列出的内核，请参阅有关如何编译<a href="/setup/build/building-kernels-deprecated">旧版内核</a>的说明。</p>

<h2 id="downloading">下载源代码和编译工具</h2>

<p>对于最新的内核，您可以使用 <a href="/setup/develop/repo#init"><code>repo</code></a> 下载源代码、工具链和编译脚本。一些内核（例如 Pixel 3 内核）需要从多个 Git 代码库获取源代码，而其他内核（如通用内核）只需从一个 Git 代码库获取源代码。使用 <code>repo</code> 方法可确保源目录设置正确。</p>

<p>下载相应分支的源代码：

</p><pre class="devsite-terminal devsite-click-to-copy">repo init -u https://android.googlesource.com/kernel/manifest -b <var>BRANCH</var></pre>
<pre class="devsite-terminal devsite-click-to-copy">repo sync</pre>

<var></var>下表列出了可通过此方法获取的内核的 BRANCH 名称：
   <table>
       <tbody><tr>
            <th>设备</th>
            <th>AOSP 树中的二进制文件路径</th>
            <th>Repo 分支</th>
       </tr>
       <tr>
            <td>Pixel 3a (sargo)</td>
            <td rowspan="2">device/google/bonito-kernel</td>
            <td rowspan="2">android-msm-bonito-4.9-pie-b4s4</td>
       </tr>
       <tr>
            <td>Pixel 3a XL (bonito)</td>
       </tr>
       <tr>
            <td>Pixel 3 (blueline)</td>
            <td rowspan="2">device/google/crosshatch-kernel</td>
            <td rowspan="2">android-msm-crosshatch-4.9-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel 3 XL (crosshatch)</td>
       </tr>
       <tr>
            <td>Pixel 2 (walleye)</td>
            <td rowspan="2">device/google/wahoo-kernel</td>
            <td rowspan="2">android-msm-wahoo-4.4-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel 2 XL (taimen)</td>
       </tr>
       <tr>
            <td>Pixel (sailfish)</td>
            <td rowspan="2">device/google/marlin-kernel</td>
            <td rowspan="2">android-msm-marlin-3.18-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel XL (marlin)</td>
       </tr>
       <tr>
            <td>Hikey/Hikey960</td>
            <td>device/linaro/hikey-kernel</td>
            <td>hikey-linaro-android-4.4<br />
                hikey-linaro-android-4.9<br />
                hikey-linaro-android-4.14<br />
                hikey-linaro-android-4.19
            </td>
       </tr>
       <tr>
            <td>Beagle x15</td>
            <td>device/ti/beagle_x15-kernel</td>
            <td>omap-beagle-x15-android-4.14<br />
                omap-beagle-x15-android-4.19
            </td>
       </tr>
       <tr>
            <td>Beagle x15</td>
            <td>device/ti/beagle_x15-kernel</td>
            <td>omap-beagle-x15-android-4.14<br />
                omap-beagle-x15-android-4.19
            </td>
       </tr>
       <tr>
            <td>Android 通用内核</td>
            <td>无</td>
            <td>common-android-4.4<br />
                common-android-4.9<br />
                common-android-4.14<br />
                common-android-4.19<br />
                common-android-mainline
            </td>
       </tr>
   </tbody></table>
<p></p>

<h2 id="building">编译内核</h2>

<p>然后，使用以下命令编译内核：

</p><pre class="devsite-terminal devsite-click-to-copy">build/build.sh</pre>
<p></p>

<p class="note"><b>注意</b>：通用内核是通用的可自定义内核，因此不会定义默认配置。如需了解如何为通用内核指定 <code>BUILD_CONFIG</code>，请参阅<a href="#customize-build">“自定义编译”部分</a>。<i></i></p>

<p>内核二进制文件、模块和相应的映像位于 <code>out/<var>BRANCH</var>/dist</code> 目录下。</p>

<h2 id="running">运行内核</h2>

<p>您可以通过多种方式运行自定义编译的内核。下面介绍了几种适合各种开发场景的已知方法：</p>

<h3>嵌入到 Android 映像编译中</h3>

<p>将 <code>Image.lz4-dtb</code> 复制到 AOSP 树中相应的内核二进制文件位置，然后重新编译启动映像。</p>

<p>或者，您也可以在使用 <code>make bootimage</code>（或用于编译启动映像的任何其他 <code>make</code> 命令行）时定义 <code>TARGET_PREBUILT_KERNEL</code> 变量。所有设备均支持该变量，因为它是通过 <code>device/common/populate-new-device.sh</code> 进行设置的。例如：</p>

<pre class="devsite-terminal devsite-click-to-copy">
export TARGET_PREBUILT_KERNEL=<var>DIST_DIR</var>/Image.lz4-dtb
</pre>

<h3>使用 fastboot 刷新和启动内核</h3>
<p>最新的设备具有引导加载程序扩展，可以简化生成和启动引导映像的过程。要启动内核而不刷新，请运行以下命令：

</p><pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb reboot bootloader</code>
<code class="devsite-terminal">fastboot boot Image.lz4-dtb</code>
</pre>

使用此方法时，内核实际上并未刷新，因此不会在重新启动时保留。
<p></p>

<p class="note"><strong>注意</strong>：内核名称因设备而异。要找到内核的正确文件名，请参阅 AOSP 树中的 <code>device/<var>VENDOR</var>/<var>NAME</var>-kernel</code>。</p>

<h2 id="customize-build">自定义内核编译</h2>

<p>编译流程和结果可能会受环境变量的影响。它们中的大多数是可选的，并且每个内核分支都应该具有适当的默认配置。此处列出了最常用的变量。如需完整（且最新）的列表，请参阅 <code>build/build.sh</code>。
   </p><table>
       <tbody><tr>
            <th>环境变量</th>
            <th>说明</th>
            <th>示例</th>
       </tr>
       <tr>
            <td><code>BUILD_CONFIG</code></td>
            <td>要从中初始化编译环境的编译配置文件。系统会相对于 repo 根目录定义具体位置。默认为“build.config”。<br />
                <b>必须为通用内核指定此变量！</b>
            </td>
            <td><code>BUILD_CONFIG=common/build.config.cuttlefish.x86_64</code></td>
       </tr>
       <tr>
            <td><code>OUT_DIR</code></td>
            <td>内核编译的基本输出目录。</td>
            <td><code>OUT_DIR=/path/to/my/out</code></td>
       </tr>
       <tr>
            <td><code>DIST_DIR</code></td>
            <td>内核分发的基本输出目录。</td>
            <td><code>OUT_DIR=/path/to/my/dist</code></td>
       </tr>
       <tr>
            <td><code>CC</code></td>
            <td>替换要使用的编译器。回退至 build.config 定义的默认编译器。</td>
            <td><code>CC=clang</code></td>
       </tr>
       <tr>
            <td><code>SKIP_MRPROPER</code></td>
            <td>跳过 <code>make mrproper</code></td>
            <td><code>SKIP_MRPROPER=1</code></td>
       </tr>
       <tr>
            <td><code>SKIP_DEFCONFIG</code></td>
            <td>跳过 <code>make defconfig</code></td>
            <td><code>SKIP_DEFCONFIG=1</code></td>
       </tr>
   </tbody></table>

<h2 id="customize-config">本地编译的自定义内核配置</h2>

<p>如果您需要定期切换内核配置选项（例如，在开发某项功能时），或者需要设置一个用于开发用途的选项，可以通过维护编译配置的本地修改或副本来实现这种灵活性。</p>
<p>将 POST_DEFCONFIG_CMDS 变量设为一个在常规 <code>make defconfig</code> 步骤完成后立即接受评估的语句。<var></var>由于 <code>build.config</code> 文件源于编译环境，因此 <code>build.config</code> 中定义的函数可以作为 post-defconfig 命令的一部分进行调用。</p>
<p>一个常见示例是在开发期间针对 crosshatch 内核停用 LTO（链接时优化）。虽然 LTO 对已发布的内核有益，但编译时产生的开销可能巨大。添加到本地 <code>build.config</code> 的以下代码段将在使用 <code>build/build.sh</code> 时永久停用 LTO。
</p><pre class="devsite-click-to-copy">
<code>POST_DEFCONFIG_CMDS="check_defconfig &amp;&amp; update_debug_config"
function update_debug_config() {
    ${KERNEL_DIR}/scripts/config --file ${OUT_DIR}/.config \
         -d LTO \
         -d LTO_CLANG \
         -d CFI \
         -d CFI_PERMISSIVE \
         -d CFI_CLANG
    (cd ${OUT_DIR} &amp;&amp; \
     make O=${OUT_DIR} $archsubarch CROSS_COMPILE=${CROSS_COMPILE} olddefconfig)
}</code>

</pre><p>

</p><h2 id="id-version">确定内核版本</h2>
<p>您可以通过多种方式确定要编译的正确版本。</p><p>

</p><h3 id="id-version-from-aosp">AOSP 树中的内核版本</h3>
<p>AOSP 树包含预编译的内核版本。大多数情况下，git 日志会在提交消息中显示正确的版本：
</p><pre class="devsite-click-to-copy">
<code class="devsite-terminal">cd $AOSP/device/<var>VENDOR</var>/<var>NAME</var></code>
<code class="devsite-terminal">git log --max-count=1</code>
</pre><p></p>

<h3 id="id-version-from-system-image">系统映像中的内核版本</h3>

<p>要确定系统映像中使用的内核版本，请对内核文件运行以下命令：
</p><pre class="devsite-terminal devsite-click-to-copy">
file kernel
</pre><p></p>

<p>对于 <code>Image.lz4-dtb</code> 文件，请运行以下命令：</p>
<pre class="devsite-terminal devsite-click-to-copy">
grep -a 'Linux version' Image.lz4-dtb
</pre>

</body></html>