<html devsite><head>
    <title>搭建编译环境</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>
本部分介绍了如何设置本地工作环境来编译 Android 源文件。您必须使用 Linux 或 macOS；目前不支持在 Windows 环境下编译。
</p>
<p>
如需简要了解代码审核和代码更新的整个过程，请参阅<a href="/setup/contribute/life-of-a-patch">补丁程序的生命周期</a>。
</p>
<aside class="note"><strong>注意</strong>：本网站中所有命令的前面都带有美元符号 ($)，以便与输出或文件条目区分开来。您可以使用每个命令框右上角的“点击复制”功能来复制所有行（不包括美元符号），也可以三击每行来分别复制各行（不包括美元符号）。<em></em>
</aside>

<h2 id="choosing-a-branch">选择分支</h2>
<p>
针对编译环境的某些要求是由您打算编译的源代码的版本决定的。如需查看可用分支的完整列表，请参阅<a href="/setup/start/build-numbers">细分版本号</a>。您还可以选择下载并编译最新的源代码（称为 <code>master</code>）。如果您选择这么做，请在初始化代码库时直接忽略分支规范。
</p>
<p>
选择分支后，请按照下面的相应说明来设置编译环境。
</p>

<h2 id="setting-up-a-linux-build-environment">设置 Linux 编译环境</h2>
<p>
以下说明适用于所有分支（包括 <code>master</code>）。
</p>
<p>我们会定期在最近推出的一些 Ubuntu LTS (14.04) 和 Debian 测试版本中对 Android 编译系统进行内部测试。其他大多数分发版本都应该具有所需的编译工具。
</p>
<p>
如果是 Gingerbread (2.3.x) 及更高版本（包括 <code>master</code> 分支），需要使用 64 位环境。如果是较低的版本，则可以在 32 位系统中编译。
</p>
<aside class="note"><strong>注意</strong>：如需查看完整的硬件和软件要求列表，请参阅<a href="/setup/build/requirements">要求</a>。然后，请按照下方适用于 Ubuntu 和 macOS 的详细说明进行操作。
</aside>

<h3 id="installing-required-packages-ubuntu-1404">安装所需的软件包 (Ubuntu 14.04)</h3>
<p>
您需要 64 位版本的 Ubuntu（建议使用 Ubuntu 14.04）。
</p>
<pre class="devsite-terminal devsite-click-to-copy">
sudo apt-get install git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc unzip
</pre>
<aside class="note"><strong>注意</strong>：要使用 SELinux 工具进行政策分析，您还需要安装 <code>python-networkx</code> 软件包。
</aside>
<aside class="note"><strong>注意</strong>：如果您使用的是 LDAP 并且希望运行 ART 主机测试，还需要安装 <code>libnss-sss:i386</code> 软件包。
</aside>

<h3 id="installing-required-packages-ubuntu-1204">安装所需的软件包 (Ubuntu 12.04)</h3>
<p>
您可以使用 Ubuntu 12.04 来编译较低版本的 Android。<code>master</code> 或最近推出的一些版本不支持 Ubuntu 12.04。
</p>
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">sudo apt-get install git gnupg flex bison gperf build-essential zip curl libc6-dev libncurses5-dev:i386 x11proto-core-dev libx11-dev:i386 libreadline6-dev:i386 libgl1-mesa-glx:i386 libgl1-mesa-dev g++-multilib mingw32 tofrodos python-markdown libxml2-utils xsltproc zlib1g-dev:i386</code>
<code class="devsite-terminal">sudo ln -s /usr/lib/i386-linux-gnu/mesa/libGL.so.1 /usr/lib/i386-linux-gnu/libGL.so</code>
</pre>

<h3 id="installing-required-packages-ubuntu-1004-1110">安装所需的软件包 (Ubuntu 10.04-11.10)</h3>
<p>
不再支持在 Ubuntu 10.04-11.10 中进行编译，但它们仍可用来编译较低版本的 AOSP。
</p>
<pre class="devsite-terminal devsite-click-to-copy">
sudo apt-get install git gnupg flex bison gperf build-essential zip curl zlib1g-dev libc6-dev lib32ncurses5-dev ia32-libs x11proto-core-dev libx11-dev lib32readline5-dev lib32z-dev libgl1-mesa-dev g++-multilib mingw32 tofrodos python-markdown libxml2-utils xsltproc
</pre>
<p>
在 Ubuntu 10.10 中，请运行以下命令：
</p>
<pre class="devsite-terminal devsite-click-to-copy">
sudo ln -s /usr/lib32/mesa/libGL.so.1 /usr/lib32/mesa/libGL.so
</pre>
<p>
在 Ubuntu 11.10 中，请运行以下命令：
</p>
<pre class="devsite-terminal devsite-click-to-copy">
sudo apt-get install libx11-dev:i386
</pre>

<h3 id="configuring-usb-access">配置 USB 使用权限</h3>
<p>
按照说明<a href="https://developer.android.com/studio/run/device.html#setting-up" class="external">设置用于开发的设备</a>，以安装适用于所有 Android 设备且由社区维护的默认 <code>udev</code> 规则集。
</p>

<h3 id="using-a-separate-output-directory">使用单独的输出目录</h3>
<p>
默认情况下，每次编译的输出都会存储在相应源代码树的 <code>out/</code> 子目录下。
</p>
<p>
在一些拥有多个存储设备的计算机上，如果将源文件和输出存储在单独的存储卷中，编译速度会更快。若要进一步提高编译速度，可以将输出存储在已针对速度（而非崩溃稳定性）进行优化的文件系统中，这是因为在文件系统损坏时可以重新生成所有文件。
</p>
<p>
要进行这项设置，请导出 <code>OUT_DIR_COMMON_BASE</code> 变量，使其指向将存储输出目录的位置。
</p>
<pre class="devsite-terminal devsite-click-to-copy">
export OUT_DIR_COMMON_BASE=&lt;path-to-your-out-directory&gt;
</pre>
<p>
对于每个单独的源代码树，其输出目录都将以其存放目录命名。例如，如果您有源代码树 <code>/source/master1</code> 和 <code>/source/master2</code>，且 <code>OUT_DIR_COMMON_BASE</code> 设置为 <code>/output</code>，则输出目录为 <code>/output/master1</code> 和 <code>/output/master2</code>。
</p>
<p>
避免将多个源代码树存储在具有相同名称的目录下，否则会导致输出目录共享终止，并且会出现不可预知的结果。仅 Jelly Bean (4.1) 及更高版本（包括 <code>master</code> 分支）支持这种做法。
</p>
<h2 id="setting-up-a-mac-os-x-build-environment">设置 macOS 编译环境</h2>
<p>
在默认安装过程中，macOS 会在一个保留大小写但不区分大小写的文件系统中运行。Git 不支持这种类型的文件系统，而且此类文件系统会导致某些 Git 命令（如 <code>git status</code>）的行为出现异常。因此，我们建议您始终在区分大小写的文件系统中处理 AOSP 源文件。使用下文中介绍的磁盘映像可以非常轻松地做到这一点。
</p>
<p>
有了适当的文件系统，在新型 macOS 环境中编译 <code>master</code> 分支就会变得非常简单。要编译较早版本的分支，则需要一些额外的工具和 SDK。
</p>

<h3 id="creating-a-case-sensitive-disk-image">创建区分大小写的磁盘映像</h3>
<p>
您可以使用磁盘映像在现有的 macOS 环境中创建区分大小写的文件系统。要创建磁盘映像，请启动磁盘工具，然后选择<strong>新建映像</strong>。完成编译至少需要 25GB 空间；更大的空间能够更好地满足未来的需求。使用稀疏映像有助于节省空间，同时可以根据需要进行扩展。请选择 <strong>Case sensitive, Journaled</strong> 存储卷格式。
</p>
<p>
您也可以通过 shell 使用以下命令创建文件系统：
</p>
<pre class="devsite-click-to-copy devsite-terminal" data-terminal-prefix="# ">
hdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 40g ~/android.dmg
</pre>
<p>
这将创建一个 <code>.dmg</code>（也可能是 <code>.dmg.sparseimage</code>）文件，该文件在装载后可用作具有 Android 开发所需格式的驱动程序。
</p>
<p>
如果您以后需要更大的存储卷，可以使用以下命令来调整稀疏映像的大小：
</p>
<pre class="devsite-click-to-copy devsite-terminal" data-terminal-prefix="# ">hdiutil resize -size &lt;new-size-you-want&gt;g ~/android.dmg.sparseimage
</pre>
<p>
对于存储在主目录下的名为 <code>android.dmg</code> 的磁盘映像，您可以向 <code>~/.bash_profile</code> 中添加辅助函数：
</p>
<ul>
  <li>要在执行 <code>mountAndroid</code> 时装载磁盘映像，请运行以下命令：
<pre class="devsite-click-to-copy"># mount the android file image
mountAndroid() { hdiutil attach ~/android.dmg -mountpoint /Volumes/android; }</pre>
<aside class="note"><strong>注意</strong>：如果系统创建的是 <code>.dmg.sparseimage</code> 文件，请将 <code>~/android.dmg</code> 替换为 <code>~/android.dmg.sparseimage</code>。
</aside>
  </li>
  <li>要在执行 <code>umountAndroid</code> 时卸载磁盘映像，请运行以下命令：
<pre class="devsite-click-to-copy"># unmount the android file image
umountAndroid() { hdiutil detach /Volumes/android; }</pre>
  </li>
</ul>
<p>
装载 <code>android</code> 存储卷后，您将在其中开展所有工作。您可以像对待外接式驱动盘一样将其弹出（卸载）。
</p>

<h3 id="xcode-other-packages">安装 Xcode 和其他软件包</h3>
<ol>
  <li>使用以下命令安装 Xcode 命令行工具：
<pre class="devsite-terminal devsite-click-to-copy">xcode-select --install</pre>
对于旧版 macOS（10.8 或更低版本），您必须从 <a href="http://developer.apple.com/" class="external">Apple 开发者网站</a>安装 Xcode。如果您尚未注册成为 Apple 开发者，则必须创建一个 Apple ID 才能下载。
  </li>
  <li>安装 <a href="http://www.macports.org/install.php" class="external">MacPorts</a> 或 <a href="https://brew.sh/" class="external">Homebrew</a> 以进行软件包管理。
  </li>
  <li>确保关联的目录位于 <code>~/.bash_profile</code> 文件的路径中：
    <ol>
      <li>MacPorts - <code>/opt/local/bin</code> 必须显示在 <code>/usr/bin</code> <strong>之前</strong>：
<pre class="devsite-click-to-copy">export PATH=/opt/local/bin:$PATH</pre>
      </li>
      <li>Homebrew - <code>/usr/local/bin</code>：
<pre class="devsite-click-to-copy">export PATH=/usr/local/bin:$PATH</pre>
      </li>

  <li>如果使用 MacPorts，请发出：
<pre class="devsite-terminal devsite-click-to-copy">POSIXLY_CORRECT=1 sudo port install git gnupg</pre>
  </li>
  <li>如果使用 Homebrew，请发出：
<pre class="devsite-terminal devsite-click-to-copy">brew install git gnupg2</pre>
  </li>
</ol>

<h3 id="setting-a-file-descriptor-limit">设置文件描述符数量上限</h3>
<p>
在 macOS 中，可同时打开的文件描述符的默认数量上限太低，在高度并行的编译流程中，可能会超出此上限。要提高此上限，请将下列行添加到 <code>~/.bash_profile</code> 中：
</p>
<pre class="devsite-click-to-copy">
# set the number of open files to be 1024
ulimit -S -n 1024</pre>

<h2 id="next-download-the-source">下一篇：下载源代码</h2>
<p>
编译环境已准备就绪！请继续阅读<a href="/setup/build/downloading">下载源代码</a>一文。
</p>

</li></ol></body></html>