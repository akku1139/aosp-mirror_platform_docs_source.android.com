<html devsite><head>
    <title>编译 Android</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>

  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>请按照以下说明编译 Android。</p>

<h2 id="initialize">设置环境</h2>
<p>使用 <code>envsetup.sh</code> 脚本初始化环境。请注意，将 <code>source</code> 替换成 <code>.</code>（一个点）可以省去一些字符，这种简写形式在文档中更为常用。</p>
<pre class="devsite-terminal devsite-click-to-copy">
source build/envsetup.sh
</pre>
<p>或</p>
<pre class="devsite-terminal devsite-click-to-copy">
. build/envsetup.sh
</pre>

<p class="note">您将需要在每次运行 <code>repo sync</code> 后重新发出此命令，以获取对该脚本所做的任何更改。</p>

<p><code>envsetup.sh</code> 脚本导入了一些命令，可让您使用 Android 源代码，其中包括本练习中使用的命令。以下是一些重要的命令示例：</p>

<ul>
<li><strong><code>lunch</code></strong> - <code>lunch
  <var>product_name</var>-<var>build_variant</var></code> 会选择“product_name”作为要编译的产品，并选择“build_variant”作为要编译的变体，然后将这些选择存储在环境中，以便被后续对 <code>m</code> 和其他类似命令的调用读取。<var></var><var></var></li>
<li><strong><code>m</code></strong> - 从树的顶部运行编译版本。这很有用，因为您可以在子目录中运行 <code>make</code>。如果您设置了 <code>TOP</code> 环境变量，它便会使用此变量。如果您未设置此变量，它便会从当前目录中查找相应的树，以尝试找到树的顶层。您可以通过运行不包含参数的 <code>m</code> 来编译整个源代码树，也可以通过指定相应名称来编译特定目标。</li>
<li><strong><code>mma</code></strong> - 编译当前目录中的所有模块及其依赖项。</li>
<li><strong><code>mmma</code></strong> - 编译提供的目录中的所有模块及其依赖项。</li>
<li><strong><code>croot</code></strong> - <code>cd</code> 到树顶部。</li>
</ul>

<p>要查看可用命令的完整列表，请运行以下命令：</p>

<pre class="devsite-terminal devsite-click-to-copy">
hmm
</pre>

<h2 id="choose-a-target">选择目标</h2>
<p>使用 <code>lunch</code> 选择要编译的目标。确切的配置可作为参数进行传递。例如，以下命令表示针对模拟器进行完整编译，并且启用所有调试功能.</p>
<pre class="devsite-terminal devsite-click-to-copy">
lunch aosp_arm-eng
</pre>
<p>如果在没有参数的情况下运行，则 <code>lunch</code> 会提示您从菜单中选择目标。要了解所有现有设备的编译配置，请参阅<a href="/setup/build/running#selecting-device-build">选择设备编译系统</a>一文。</p>

<p>所有编译目标都采用 <code>BUILD-BUILDTYPE</code> 形式，其中 <code>BUILD</code> 是表示特定功能组合的代号。<code>BUILDTYPE</code> 是以下类型之一。</p>
<table>
  <thead>
    <tr>
      <th>编译类型</th>
      <th>使用情况</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>user</td>
      <td>权限受限；适用于生产环境</td>
    </tr>
    <tr>
      <td>userdebug</td>
      <td>与“user”类似，但具有 root 权限和调试功能；是进行调试时的首选编译类型</td>
    </tr>
    <tr>
      <td>eng</td>
      <td>具有额外调试工具的开发配置</td>
    </tr>
  </tbody>
</table>

<p>userdebug 版本的运行方式应该与 user 版本一样，且能够启用通常不符合平台安全模型的额外调试功能。这就使得 userdebug 版本具有更强大的诊断功能，因此是进行 user 测试的最佳选择。使用 userdebug 编译系统进行开发时，请遵循 <a href="/setup/develop/new-device#userdebug-guidelines">userdebug 指南</a>。</p>

<p>eng 编译系统会优先考虑在平台上工作的工程师的工程生产率。eng 编译系统会关闭用于提供良好用户体验的各种优化。除此之外，eng 编译系统的运行方式类似于 user 和 userdebug 编译系统，以便设备开发者能够看到代码在这些环境下的运行方式。</p>

<p>要详细了解如何针对实际硬件进行编译以及如何在实际硬件上运行编译系统，请参阅<a href="/setup/build/running">运行编译系统</a>。</p>

<h2 id="build-the-code">编译代码</h2>

<p>本部分是一个简短摘要，用于确保设置已完成。</p>

<p>请使用 <code>m</code> 进行所有编译。<code>m</code> 可以使用 <code>-jN</code> 参数处理并行任务。如果您未提供 <code>-j</code> 参数，编译系统便会自动选择其认为对您的系统最佳的并行任务计数。</p>

<pre class="devsite-terminal devsite-click-to-copy">
m
</pre>

<p>如上所述，您可以通过在 <code>m</code> 命令行中列出相应名称来编译特定模块，而不是编译完整的设备映像。此外，<code>m</code> 还针对各种特殊目的提供了一些伪目标。以下是一些示例：</p>

<ul>
<li><strong><code>droid</code></strong> - <code>m droid</code> 是正常编译。此目标在此处，因为默认目标需要名称。</li>
<li><strong><code>all</code></strong> - <code>m all</code> 会编译 <code>m droid</code> 能够编译的所有元素，以及没有 <code>droid</code> 标记的所有元素。编译服务器会运行此命令，以确保包含在树中且包含 <code>Android.mk</code> 文件的所有元素都会编译。</li>
<li><strong><code>clean</code></strong> - <code>m clean</code> 会删除此配置的所有输出和中间文件。这与 <code>rm -rf out/</code> 相同。</li>
</ul>

<p>运行 <code>m help</code> 即可查看 <code>m</code> 提供的其他伪目标。</p>

<h2 id="run-it">开始运行！</h2>

<p>您可以在模拟器上运行编译版本，也可以将其刷写到设备上。因为您已经使用 <code>lunch</code> 选择了编译目标，所以编译版本不可能在其编译目标以外的目标上运行。</p>

<aside class="note">
  <p><strong>注意</strong>：请注意获取专有二进制文件，否则编译版本将无法在目标硬件上成功启动。有时，源代码可能会对不同编译版本和分支提供不同的二进制文件。如果此时获取二进制 Blob，则需要解压缩这些 Blob 并执行 <code>m installclean</code> 命令，然后重新编译。要详细了解此过程，请参阅<a href="/setup/build/downloading#obtaining-proprietary-binaries">下载源代码</a>一文。
  </p>
</aside>

<h3 id="flash-a-device">使用 fastboot 刷机</h3>

<p>要刷写设备，请使用 <code>fastboot</code>；在成功编译后，它应该会包含在您的路径中。如需相关说明，请参阅<a href="/setup/build/running#flashing-a-device">刷写设备</a>。</p>

<h3 id="emulate-an-android-device">模拟 Android 设备</h3>

<p>编译流程会自动将模拟器添加到您的路径中。要运行模拟器，请输入以下命令：</p>

<pre class="devsite-terminal devsite-click-to-copy">
emulator
</pre>

<h2 id="troubleshooting-common-build-errors">排查常见编译错误</h2>

<h3 id="wrong-java-version">Java 版本不正确</h3>

<p>如果您试图编译与 Java 版本不一致的 Android 版本，则 <code>make</code> 会终止并显示如下消息：</p>

<pre>
************************************************************
You are attempting to build with the incorrect version
of java.

Your version is: WRONG_VERSION.
The correct version is: RIGHT_VERSION.

Please follow the machine setup instructions at
    https://source.android.com/source/initializing.html
************************************************************
</pre>

<p>以下是可能的原因和解决方案：</p>

<ul>
<li>无法按照 <a href="/setup/build/requirements#jdk">JDK 要求</a>中指定的方式安装正确的 JDK。请确保您已按照<a href="/setup/build/building#initialize">设置环境</a>和<a href="/setup/build/building#choose-a-target">选择目标</a>中的步骤操作。</li>
<li>之前安装的另一个 JDK 出现在您的路径中。将正确的 JDK 附加到路径开头，或者移除有问题的 JDK。</li>
</ul>

<h3 id="python-version-3">Python 版本 3</h3>

<p>Repo 是基于 Python 2.x 中的特定功能构建的，与 Python 3 不兼容。要使用 Repo，请安装 Python 2.x：</p>

<pre class="devsite-terminal devsite-click-to-copy">
apt-get install python
</pre>

<h3 id="case-insensitive-filesystem">不区分大小写的文件系统</h3>

<p>在 macOS 中的 HFS 文件系统上进行编译时，可能会遇到如下错误：</p>
<pre>
************************************************************
You are building on a case-insensitive filesystem.
Please move your source tree to a case-sensitive filesystem.
************************************************************
</pre>
<p>请按照<a href="/setup/build/initializing#creating-a-case-sensitive-disk-image">创建区分大小写的磁盘映像</a>中的说明操作。</p>

<h3 id="no-usb-permission">没有 USB 权限</h3>

<p>默认情况下，在大多数 Linux 系统中，无特权的用户无法使用 USB 端口。如果您看到权限遭拒错误，请按照<a href="/setup/build/initializing#configuring-usb-access">配置 USB 使用权限</a>中的说明操作。</p>

<p>如果上述规则设置完成后，adb 已在运行且无法连接到设备，您可以使用 <code>adb kill-server</code> 将其终止。此命令将使 adb 重启并采用新配置。</p>

</body></html>