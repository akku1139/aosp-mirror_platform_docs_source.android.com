<html devsite><head>
    <title>构建 ODM 分区</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  {% include "_versions.html" %}
  <body>

  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>Android 10 支持使用 Android 构建系统构建 <code>/odm</code> 分区。</p>

  <h2 id="about-odm-partitions">ODM 分区简介</h2>

<p>原始设计制造商 (ODM) 能够为其特定设备（开发板）自定义系统芯片 (SoC) 供应商板级支持包 (BSP)。这样，他们就可以为板级组件、板级守护进程或者其基于硬件抽象层 (HAL) 的自有功能实现内核模块。他们可能还需要替换或自定义 SoC 组件。</p>

  <p>在之前的 Android 版本中，对于使用相同 SoC（或使用同一系列中的不同 SoC）的设备，此类自定义会阻止使用单个供应商映像。在 Android {{androidQVersionNumber}} 中，您可以为自定义使用单独的 <code>/odm</code> 分区，因而能够针对多个硬件 SKU 使用单个供应商映像。</p>

  <h3 id="using-prod-and-ODM-partitions">使用产品分区和 ODM 分区</h3>

<p>Android 9 添加了对构建 <a href="/devices/bootloader/product-partitions"><code>/product</code> 分区</a>的支持，让您可以针对由不同 <code>product.img</code> 映像提供的多个软件 SKU 使用单个系统映像。<code>/product</code> 分区适用于软件 SKU，而 <code>/odm</code> 分区适用于硬件 SKU。</p>

  <p>有了专用的产品分区和 ODM 分区，您可以使用 <code>/system</code> 分区来托管通用代码（这类代码在许多软件 SKU 之间共享），以及使用 <code>/vendor</code> 分区来托管 SoC 专属 BSP 代码（这类代码基于指定 SoC 在多台设备之间共享）。</p>

  <p>使用单独的分区存在一些弊端，例如，难以管理磁盘空间（您必须预留一定的空间满足未来增长的空间需求）。但是，Android 10 对<a href="/devices/tech/ota/dynamic_partitions">动态分区</a>的支持解决了磁盘空间问题，并且让您可以在<a href="/devices/tech/ota/">无线下载 (OTA)</a> 更新期间对设备进行重新分区。</p>

  <h3 id="odm-components">/odm 组件</h3>

<p><code>/odm</code> 分区包含以下 ODM 专用组件（类似于 <code>/vendor</code> 分区），如下表所示。</p>

    <table>
      <tbody><tr>
        <th>ODM 专用组件</th>
         <th>位置</th>
      </tr>
      <tr>
        <td>可加载内核模块 (LKM)</td>
        <td><code>/odm/lib/modules/*.ko</code></td>
      </tr>
      <tr>
        <td>原生库</td>
        <td><code>/odm/lib[64]</code></td>
      </tr>
      <tr>
        <td>HAL</td>
        <td><code>/odm/lib[64]/hw</code></td>
      </tr>
      <tr>
        <td>SEPolicy</td>
        <td><code>/odm/etc/selinux</code></td>
      </tr>
       <tr>
        <td><a href="/devices/architecture/vintf/objects">VINTF 对象数据</a></td>
        <td><code>/odm/etc/vintf</code></td>
      </tr>
      <tr>
        <td><a href="https://android.googlesource.com/platform/system/core/+/master/init/README.md"><code>init.rc</code> 文件</a></td>
        <td><code>/odm/etc/init</code></td>
      </tr>
      <tr>
        <td>系统属性</td>
        <td><code>/odm/build.prop</code></td>
      </tr>
      <tr>
        <td>运行时资源叠加层 (RRO)</td>
        <td><code>/odm/overlay/*.apk</code></td>
      </tr>
      <tr>
        <td>应用</td>
        <td><code>/odm/app/*.apk</code></td>
      </tr>
      <tr>
        <td>特权应用</td>
        <td><code>/odm/priv-app/*.apk</code></td>
      </tr>
      <tr>
        <td>Java 库</td>
        <td><code>/odm/framework/*.jar</code></td>
      </tr>
       <tr>
        <td>Android 框架系统配置</td>
        <td><code>/odm/etc/sysconfig/*</code> 和 <code>/odm/etc/permissions/*</code></td>
      </tr>
    </tbody></table>

<p>
</p>

  <h3 id="no-custom_images">不得使用 custom_images</h3>

<p>请勿使用 <a href="https://android.googlesource.com/platform/build/+/bc7e3f98f41108c03a06abbf98add08ad4a05040/cor
e/tasks/build_custom_images.mk#53">custom images</a>，因为它们缺乏对以下方面的支持：</p>

<ul>

<li><strong>将模块安装到特定目标分区中。</strong><code>custom_images</code> 支持将软件工件复制到映像中，但无法通过将目标分区指定为构建规则的一部分，来将模块安装到特定分区中。</li>
    <li><strong>Soong。</strong>
      无法使用 Soong 构建系统构建 <code>custom_images</code>。</li>
    <li><strong>OTA 更新。</strong><code>custom_images</code> 用作出厂 ROM 映像，无法执行 OTA 更新。
</li>
</ul>

<h3 id="maintain-ABIs">维护分区之间的 ABI</h3>

<p><code>/odm</code> 分区是 <code>/vendor</code> 分区的扩展。在考虑应用二进制接口 (ABI) 稳定性时，请记住以下架构：</p>

<img src="images/build_sys_to_prod_odm_partitions.png" alt="维护分区之间的 ABI"/>

<figcaption><strong>图 1.</strong> 维护分区之间的 ABI</figcaption>

<ul>
<li><code>/odm</code> 和 <code>/vendor</code> 分区之间不具有 ABI 稳定性。必须同时升级这两个分区。
</li><li><code>/odm</code> 和 <code>/vendor</code> 分区可以相互依赖，但是在没有 <code>/odm</code> 分区的情况下，<code>/vendor</code> 分区<strong>必须</strong>运行。
</li><li><code>/odm</code> 和 <code>/system</code> 之间的 ABI 与 <code>/vendor</code> 和 <code>/system</code> 之间的 ABI 相同。</li>
</ul>

<p><code>/product</code> 分区与 <code>/vendor</code> 或 <code>/odm</code> 分区之间<strong>不允许</strong>有任何直接交互。（这一规则将由 SEpolicy 强制执行。）</p>

<h2 id="implement-ODM">实现 ODM 分区</h2>

<p>在实现新分区之前，请先了解<a href="https://android-
review.googlesource.com/q/topic:odm_partition_+OR+topic:odm_partition+(status:open+OR+status:merged)
">相关 AOSP 变化</a>。</p>

<h3 id="set-ODM">设置 ODM 分区</h3>

<p>要设置 <code>/odm</code> 分区，请添加以下构建标记：</p>

<ul>

  <li><code>BOARD_ODMIMAGE_PARTITION_SIZE</code>（适用于固定分区大小）</li>
<li><code>PRODUCT_USE_DYNAMIC_PARTITIONS</code> 和 <code>BOARD_ODMIMAGE_PARTITION_RESERVED_SIZE</code>（适用于<a href="/devices/tech/ota/dynamic_partitions">动态分区</a>大小）</li>
  <li><code>BOARD_ODMIMAGE_FILE_SYSTEM_TYPE</code> 文件系统类型（用于 ODM 映像）</li>
  <li><code>PRODUCT_ODM_PROPERTIES</code>（适用于 <code>/odm/build.prop</code>）<br />在 <code>$(call inherit-product
path/to/device.mk)</code> 中使用该标记，例如 <code>PRODUCT_ODM_PROPERTIES += product.abc=ok</code></li></ul>

<h3 id="install-to-ODM">向 ODM 分区中安装模块</h3>

<p>使用以下构建标记向 <code>/odm</code> 分区中安装模块：</p>

<ul>
  <li><code>Android.bp</code> 中的 <code>device_specific: true</code></li>
<li><code>Android.mk</code> 中的 <code>LOCAL_ODM_MODULE := true</code></li>
</ul>

<h3 id="enable-verified-boot">启用启动时验证</h3>

<p>要防止恶意软件篡改 <code>/odm</code> 分区，请为这些分区启用 <a href="/security/verifiedboot/avb">Android 启动时验证</a> (AVB)（就像为 <code>/vendor</code> 和 <code>/system</code> 分区启用一样）。</p>

<p>要启用 AVB，请添加构建标记 <code>BOARD_AVB_ODM_ADD_HASHTREE_FOOTER_ARGS</code>。要详细了解如何在动态分区上配置 AVB，请参阅 <a href="/devices/tech/ota/dynamic_partitions/implement#avb-
configuration-changes">AVB 配置更改</a>。</p>

<h3 id="treating-odm-as-vendor">将 /odm 作为另一个 /vendor 分区处理</h3>

<p>要确保系统将 <code>/odm</code> 分区作为 <code>/vendor</code> 分区处理，请将所有硬编码的 <code>/vendor</code> 引用替换为一组面向硬件的分区（当前为 <code>/odm</code> 和 <code>/vendor</code>）。平台中值得注意的 <code>/vendor</code> 引用位置包括<a href="https://android.googlesource.com/platform/bionic/+/master/linker/">动态链接器</a>、<a href="https://android.googlesource.com/platform/frameworks/base/+/master/services/core/java/com/andr
oid/server/pm/PackageManagerService.java">软件包管理器</a>和 <code>shell/libc</code>。</p>

</body></html>