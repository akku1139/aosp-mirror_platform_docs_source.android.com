<html devsite><head>

  <meta name="book_path" value="/_book.yaml"/>

  <meta name="project_path" value="/_project.yaml"/>
</head>
<body>

<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<h1 id="heif_imaging" class="page-title">HEIF 图片处理</h1>

<p>搭载 Android 10 的设备支持 HEIC 压缩图片格式，它是 <a href="https://www.iso.org/standard/66067.html" class="external">ISO/IEC 23008-12</a> 中规定的高效图片文件格式 (HEIF) 的高效视频编码 (HEVC) 特定品牌。<em></em>与 JPEG 文件相比，HEIC 编码的图片质量更好且文件更小。</p>

<p>HEIC 图片由摄像头传输框架生成，请求来自<a href="/devices/camera/camera3">相机 HAL</a> 的未压缩图片并将其发送到媒体子系统，以便由 HEIC 或 HEVC 编码器进行编码。</p>

<h2 id="requirements">要求</h2>

<p>要支持 HEIC 图片格式，您的设备必须拥有支持 <a href="https://developer.android.com/reference/android/media/MediaFormat.html#MIMETYPE_IMAGE_ANDROID_HEIC" class="external"><code>MIMETYPE_IMAGE_ANDROID_HEIC</code></a> 或 <a href="https://developer.android.com/reference/android/media/MediaFormat.html#MIMETYPE_VIDEO_HEVC" class="external"><code>MIMETYPE_VIDEO_HEVC</code></a>（具有<a href="https://developer.android.com/reference/android/media/MediaCodecInfo.EncoderCapabilities.html#BITRATE_MODE_CQ" class="external">恒定质量模式</a>）的硬件编码器。</p>

<h2 id="implementation">实现</h2>

<p>要在您的设备上支持 HEIC 图片格式，请实现 HEIC/HEVC 编解码器，并为所需的流配置（即 <code>IMPLEMENTATION_DEFINED</code>/<code>YUV</code> 流和 JPEG 应用细分流）提供支持。</p>

<h3 id="media">媒体</h3>

<p>对于相应的硬件，以恒定质量 (CQ) 模式实现 HEIC/HEVC 编解码器，如下所示：</p>

<ul>
<li>HEVC 类型编解码器使用具有 <code>GRALLOC_USAGE_HW_VIDEO_ENCODER</code> 用法的 <code>IMPLEMENTATION_DEFINED</code> 格式或 <code>HAL_PIXEL_FORMAT_YCBCR_420_888</code> 格式，具体取决于图片大小。</li>
<li>HEIC 类型编解码器使用具有 <code>GRALLOC_USAGE_HW_IMAGE_ENCODER</code> 用法的 <code>IMPLEMENTATION_DEFINED</code> 格式。</li>
</ul>

<h3 id="camera">摄像头</h3>

<p>在静态元数据中，将 <code>ANDROID_HEIC_INFO_SUPPORTED</code> 设置为 true，并将 <code>ANDROID_HEIC_INFO_MAX_JPEG_APP_SEGMENTS_COUNT</code> 设置为介于 <code>[1, 16]</code> 之间的值，以表明 JPEG 应用细分的数量。</p>

<p>对于每个必要的流组合，您的摄像头设备必须支持使用相同大小的 HEIC 流替换 JPEG 流。</p>

<p>对于公共 API 上的 HEIC 输出流，摄像头服务会创建两个 HAL 内部流：</p>

<ul>
<li>具有 <code>JPEG_APPS_SEGMENT</code> 使用标记的 BLOB 流，可存储应用细分（包括 EXIF 和缩略图细分）</li>
<li><code>IMPLEMENTATION_DEFINED</code> 和 <code>YCBCR_420_888</code> 会根据目标编解码器和 HEIC 流的大小流式传输 HEIC 流的大小</li>
</ul>

<p>摄像头传输框架根据 <code>ANDROID_HEIC_INFO_MAX_JPEG_APP_SEGMENTS_COUNT</code> 为相机 HAL 分配足够大的缓冲区，以便填充 JPEG 应用细分。<code>APP1</code> 细分为必填项，但 <code>APP1</code> 之后（<code>APP2</code> 及以上）的细分为可选项。摄像头传输框架可以覆盖 <code>APP1</code> 细分中的 EXIF 标记（这些标记可以派生自捕获结果元数据或者与主图片比特流相关），并将它们发送至 <code>MediaMuxer</code>。</p>

<p>由于媒体编码器将屏幕方向嵌入到了输出图片的元数据中，以确保主图片和缩略图的屏幕方向一致，因此相机 HAL 不得根据 <code>android.jpeg.orientation.</code> 旋转缩略图。 该框架将屏幕方向写入到 EXIF 元数据和 HEIC 容器中。</p>

<p>与 JPEG 格式相关的静态、控制和动态元数据标记也适用于 HEIC 格式。例如，捕获请求中的 <code>android.jpeg.orientation</code> 和 <code>android.jpeg.quality</code> 元数据标记用于控制 HEIC 图片的屏幕方向和质量。</p>
<aside class="note"><strong>注意</strong><span>：无法同时配置 JPEG 和 HEIC 流。</span></aside>
<p>要在应用中使用 HEIC 格式，请使用 <a href="https://developer.android.com/reference/android/graphics/ImageFormat#HEIC" class="external">HEIC 公共 API</a>。</p>

<p>如需了解详情，请参阅以下来源。</p>

<p><strong>相机 HAL</strong></p>

<ul>
<li><a href="https://android.googlesource.com/platform/system/media/+/refs/heads/master/camera/docs/docs.html#31756" class="external"><code>docs.html</code></a> </li>
<li><code>CameraBlob</code></li>
<li><code>ANDROID_HEIC_INFO_SUPPORTED</code></li>
<li><code>ANDROID_HEIC_INFO_MAX_JPEG_APP_SEGMENTS_COUNT</code></li>
</ul>

<p><strong>图形缓冲区数据空间</strong></p>

<ul>
<li><code>JPEG_APP_SEGMENTS</code></li>
<li><code>HEIF</code></li>
</ul>

<p><strong>图形缓冲区使用空间</strong></p>

<ul>
<li><code>HW_IMAGE_ENCODER</code></li>
</ul>

<h2 id="validation">验证</h2>

<p>要验证您的实现是否支持 HEIC 图片，请使用 <a href="https://android.googlesource.com/platform/pdk/+/refs/heads/master/apps/TestingCamera2/" class="external"><code>TestingCamera2</code></a> 测试应用，并运行以下摄像头 CTS 和 VTS 测试。</p>

<p><strong>摄像头 CTS 测试</strong></p>

<ul>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/NativeImageReaderTest.java#46" class="external"><code>NativeImageReaderTest#testHeic</code></a> </li>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ImageReaderTest.java#207" class="external"><code>ImageReaderTest#testHeic</code></a> </li>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ImageReaderTest.java#257" class="external"><code>ImageReaderTest#testRepeatingHeic</code></a> </li>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ReprocessCaptureTest.java#122" class="external"><code>ReprocessCaptureTest#testBasicYuvToHeicReprocessing</code></a> </li>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/ReprocessCaptureTest.java#170" class="external"><code>ReprocessCaptureTest#testBasicOpaqueToHeicReprocessing</code></a> </li>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/RobustnessTest.java#230" class="external"><code>RobustnessTest#testMandatoryOutputCombinations</code></a> </li>
<li><a href="https://android.googlesource.com/platform/cts/+/refs/heads/master/tests/camera/src/android/hardware/camera2/cts/StillCaptureTest.java#116" class="external"><code>StillCaptureTest#testHeicExif</code></a> </li>
</ul>

<p><strong>摄像头 VTS 测试</strong></p>

<ul>
<li><a href="https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/camera/provider/2.4/vts/functional/VtsHalCameraProviderV2_4TargetTest.cpp#2357" class="external"><code>VtsHalCameraProviderV2_4TargetTest.cpp</code></a> </li>
</ul>

</body></html>