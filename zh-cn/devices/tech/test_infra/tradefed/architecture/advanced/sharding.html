<html devsite><head>

  <meta name="book_path" value="/_book.yaml"/>

  <meta name="project_path" value="/_project.yaml"/>
</head>
<body>
<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<h1 id="shard_tests" class="page-title">分片测试</h1>

<p>当测试语料库很大或执行时间变得很长时，我们可以将测试拆分到多部设备上：这种做法就是“分片”。<em></em></p>

<p>若要支持分片，测试运行程序需满足分片的<a href="/devices/tech/test_infra/tradefed/testing/through-tf/sharded-runner">先决条件</a>。</p>

<p>大多数主要测试运行程序已经支持分片，所以不需要进行额外的处理。以下测试已经支持分片：插桩测试、主机端驱动测试和 GTest。</p>

<p>我们在 Tradefed 中支持两种类型的分片：本地分片和分布式分片。它们有一些相似之处，所以我们先介绍通用属性，然后再介绍每种类型的具体细节。</p>

<h2 id="common_properties">通用属性</h2>

<p>这两种形式的分片都与测试运行程序具有相同的属性：分片需要具有独立性和确定性。<em></em><em></em>这两种分片的第一步都是构建完整有序的测试列表，然后将它们拆分成不同的组/分片。</p>

<p>分片形式的主要区别在于它们执行测试的方式。下面几部分提供了更多详情。</p>

<h2 id="local_sharding">本地分片</h2>

<p>“本地分片”表示执行分片调用所涉及的所有设备连接到同一物理主机。<em></em></p>

<h3 id="execution">执行</h3>

<p>本地分片利用连接到同一主机的所有设备，方法是创建需要执行的测试池，并让每个设备在空闲时（即完成上一个测试时）轮询测试。这样可以优化设备利用率。我们也称之为“动态分片”。<em></em></p>

<h3 id="options">选项</h3>
<pre class="prettyprint lang-shell"><code>--shard-count XX
</code></pre>
<h2 id="distributed_sharding">分布式分片</h2>

<p>“分布式分片”表示执行分片调用所涉及的所有设备可以位于任何位置并连接到不同的物理主机。<em></em></p>

<h3 id="execution_2">执行</h3>

<p>在分布式分片过程中，首先构建测试列表，接着每个分片的内容仅执行当前请求的分片。因此，所有分布式分片首先构建相同的列表，然后执行它的互斥子集，这样就会将所有测试执行完毕。</p>

<p>这种形式的主要特性是分片完全不知道彼此并且可以独立失败。</p>

<h3 id="options_2">选项</h3>
<pre class="prettyprint lang-shell"><code>--shard-count XX --shard-index XX
</code></pre>
<h2 id="token_sharding">令牌分片</h2>

<p>令牌分片只能与本地分片一起使用。该标记在非本地分片用例中会不起作用。有时，分片中所涉及的某个设备拥有其他设备没有的特殊资源，如 SIM 卡。某些测试可能仅在该特殊资源可用时才能成功执行，否则会失败。</p>

<p>令牌分片是我们针对此类用例提供的解决方案。<em></em>测试模块能够在 <code>AndroidTest.xml</code> 中声明它们需要的特殊资源，而 Tradefed 会将测试传送到拥有相应资源的设备。</p>

<h2 id="xml_configuration">XML 配置</h2>
<pre class="prettyprint lang-XML"><code>&lt;option name="config-descriptor:metadata" key="token" value="SIM_CARD" /&gt;
</code></pre>
<p>令牌的 <code>value</code> 与 Tradefed 的 <a href="https://android.googlesource.com/platform/tools/tradefederation/+/refs/heads/master/src/com/android/tradefed/invoker/shard/token/TokenProperty.java">TokenProperty</a> 匹配，并与 <a href="https://android.googlesource.com/platform/tools/tradefederation/+/refs/heads/master/src/com/android/tradefed/invoker/shard/token/TokenProviderHelper.java">TokenProviderHelper</a> 中的处理程序相关联。</p>

<p>这样一来，就能针对可正确执行测试的设备运行测试模块。</p>

<h3 id="what_if_no_devices_can_run_the_test">如果没有设备可以运行测试，该怎么办？</h3>

<p>如果没有可用的设备具有与测试模块匹配的资源，那么相应测试模块将会失败并被跳过，因为它无法正确执行。</p>

<p>例如，如果某个测试模块请求运行 SIM 卡，但没有设备具有 SIM 卡，那么该测试模块将会失败。</p>

<h3 id="implementation">实现</h3>

<p>将以下功能标记传递到 Tradefed 主命令行：</p>
<pre class="prettyprint lang-shell"><code>--enable-token-sharding
</code></pre>

</body></html>