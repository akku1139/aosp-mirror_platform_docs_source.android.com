<html devsite><head>

  <meta name="book_path" value="/_book.yaml"/>

  <meta name="project_path" value="/_project.yaml"/>
</head>
<body>
<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<h1 id="device-side_metric_collection" class="page-title">设备端指标收集</h1>

<p>在运行设备端测试（插桩测试、UI Automator 测试等）时，主机端收集器可能并不理想，因为很难将指标收集同步到设备上运行的测试。例如，异步截取的屏幕截图很可能会错过想要的屏幕，变得毫无用处。</p>

<p>为了满足这些用例的要求，我们提供了收集器的设备端版本，该版本可用于任何“AndroidJUnitRunner”插桩测试。
可以实现 <a href="https://android.googlesource.com/platform/platform_testing/+/refs/heads/master/libraries/device-collectors/src/main/java/android/device/collectors/BaseMetricListener.java">BaseMetricListener</a>，以便自动报告采用与 Tradefed 报告渠道完全兼容的方式收集的指标。</p>

<p>此库与 Tradefed 本身分离，可以在没有 Tradefed 的情况下使用。</p>

<p>如果您使用的是 Tradefed 的“<a href="https://android.googlesource.com/platform/tools/tradefederation/+/refs/heads/master/src/com/android/tradefed/testtype/AndroidJUnitTest.java">AndroidJUnitTest</a>”运行程序，那么您可以直接指定以下命令行选项，让您的收集器与测试一起运行：</p>
<pre class="prettyprint lang-shell"><code>  --device-listeners android.device.collectors.ScreenshotListener
</code></pre>
<p>注意：为了能够在运行时解析收集器类，您的插桩测试 APK 很可能需要静态地包含这些类。为此，您可以将以下内容添加到 makefile：</p>
<pre class="prettyprint lang-shell"><code>  LOCAL_STATIC_JAVA_LIBRARIES += collector-device-lib
</code></pre>
<h2 id="implementation">实现</h2>

<p>在基类 <code>BaseMetricListener</code> 之上实现时，您可以选择要在插桩测试生命周期内的什么时间收集指标：</p>

<ul>
<li>测试运行开始时：<code>onTestRunStart</code></li>
<li>测试用例开始时：<code>onTestStart</code></li>
<li>测试用例结束时：<code>onTestEnd</code></li>
<li>测试用例失败时：<code>onTestFail</code></li>
<li>测试运行结束时：<code>onTestRunEnd</code></li>
</ul>

<h2 id="interaction">交互</h2>

<p>设备端的指标收集会与插桩测试执行本身同步进行，并且指标会传递回插桩测试结果并由 Tradefed 解析，以作为调用的一部分进行报告。</p>

</body></html>