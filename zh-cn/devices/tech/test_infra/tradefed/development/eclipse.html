<html devsite><head>

  <meta name="book_path" value="/_book.yaml"/>

  <meta name="project_path" value="/_project.yaml"/>
</head>
<body>

<!--
  Copyright 2019 The Android Open Source Project

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<h1 id="set_up_eclipse" class="page-title">设置 Eclipse</h1>

<p>您可以按照以下步骤来使用 Eclipse 设置 Tradefed。</p>

<p>创建一个单独的工作区来开发 Trade Federation，而不要重复使用已经用于 Android 设备开发的工作区。</p>

<p><em></em>如果需要，您可以从以下网址下载适用于 Java 开发者的 Eclipse <a href="https://www.eclipse.org/downloads/">IDE：eclipse.org/downloads</a></p>

<h2 id="create_projects">创建项目</h2>

<ol>
<li>从命令行运行一次 make 命令。这样将构建以下项目所依赖的外部库。</li>
<li>在 <code>Window &gt; Preferences &gt; Java &gt; Build
Path&gt; Classpath Variables</code> 中设置 TRADEFED_ROOT 类路径变量，并使其指向您的 tradefed 源根</li>
<li>在 <code>Window &gt; Preferences &gt; General &gt;
Workspace &gt; Linked Resources</code> 中设置 TRADEFED_ROOT 路径变量，并使其指向您的 tradefed 源根</li>
<li><p>使用 <code>File &gt; Import...-&gt; General &gt; Existing Projects into
workspace"</code> 向导引入以下路径下的这些开放源代码 Java 项目：</p>
<pre class="prettyprint"><code>prebuilts/misc/common/ddmlib\*
tools/loganalysis
tools/loganalysis/tests
tools/tradefederation/core
tools/tradefederation/core/tests
tools/tradefederation/contrib
tools/tradefederation/core/remote
platform_testing/libraries/longevity
platform_testing/libraries/annotations
platform_testing/libraries/composer
</code></pre></li>
<li><p>（可选）如果您想看到 <code>ddmlib</code> 源代码，请从未捆绑工具分支（如 <a href="https://android.googlesource.com/platform/tools/base/+/tools_r22/ddmlib/src/main/java/com/android/ddmlib/IDevice.java">/platform/tools/base/tools_r22/ddmlib/src/main/java/com/android/ddmlib/IDevice.java</a>）附加该源代码。</p></li>
<li><p>（可选）如果您还想加载 CTS 自动化测试框架项目，请导入：</p>
<pre class="prettyprint"><code>test/suite_harness/common/util
test/suite_harness/common/host-side/util
test/suite_harness/common/host-side/tradefed
</code></pre></li>
</ol>

<h2 id="auto_format">自动设置格式</h2>

<p>注意：必需的文件位于完整平台源代码树的 <code>development/ide/eclipse</code> 中。所以，您需要签出一个平台分支（如 <code>master</code>）来获取这些文件：<a href="https://android.googlesource.com/platform/development/+/refs/heads/master/ide/eclipse/">/development/master/ide/eclipse</a>/</p>

<p>您可以使用 Eclipse 中的首选项文件自动将格式设置标准设为 Android 样式指南。为此，请在 Studio 中执行以下操作：</p>

<ol>
<li>依次转到“Window”&gt;“Preferences”&gt;“Java”&gt;“Code Style”。<em></em></li>
<li><em></em>在“Formatter”下，导入 <code>android-formatting.xml</code> 文件。</li>
<li><em></em>在“Organize”&gt;“Imports”下，导入 <code>android.importorder</code> 文件。</li>
</ol>

<h3 id="remove_trailing_whitespaces">移除尾随空格</h3>

<p>要强制 Eclipse 移除所有尾随空格，请执行以下操作：</p>

<ol>
<li>依次转到“Window”&gt;“Preferences”&gt;“Java”&gt;“Editor”&gt;“Save Actions”。<em></em></li>
<li>然后，依次转到“Additional Actions”&gt;“Configure”&gt;“Code”&gt;“Organizing”标签 &gt;“Formatter”。<em></em></li>
<li>勾选 <strong>Remove Trailing Whitespace</strong>。</li>
<li>点击 <strong>Apply and Close</strong>。</li>
</ol>

<h3 id="check_code_style">检查代码样式</h3>

<p>提交更改列表时，将运行自动预上传钩子来检查您的代码格式：<code>google-java-format</code></p>

<p>这有助于将您的代码设置为符合通用标准的格式。</p>

<h2 id="debug_eclipse">Eclipse 调试</h2>

<p>如果您要通过 Eclipse 中的调试程序运行 TF 代码，建议您先为相关代码创建单元测试，因为这将是运用相关功能的最简单、最快捷的方式。</p>

<p>要调试 TF 单元测试，只需右键点击该单元测试，然后依次选择 <strong>Debug As &gt; JUnit test</strong>。</p>

<p>要调试 TF 功能测试，请按照上一部分中关于运行功能测试的说明操作，但使用“Run”&gt;“Debug configurations”菜单。<em></em></p>

<p>要调试 TF 程序本身，在运行任意配置时，请按照上一部分中关于运行功能测试的说明操作，但在第 4 步中为您希望运行的配置提供命令行参数。<em></em><em></em>因此，要调试“instrument”配置，请依次转到“Run”&gt;“Debug configurations”菜单，然后将 Eclipse 调试配置中的“Arguments”标签设为 <code>-- package &lt;package to run&gt; instrument</code>。</p>

<h3 id="remote_debug_with_eclipse">使用 Eclipse 进行远程调试</h3>

<p>您可以按照以下步骤来远程调试从 <code>tradefed.sh</code> 命令行启动的 tradefed 会话：</p>

<ol>
<li>使用调试标记启动 tradefed.sh：<code>TF_DEBUG=1 tradefed.sh</code></li>
<li>等待 JVM 显示以下提示符：<code>Listening for transport
dt_socket at address: 10088</code>。这意味着 JVM 正在等待调试程序在端口 <code>10088</code> 处连接。</li>
<li>从主菜单中，将 JVM 与 Eclipse 的远程调试连接：依次选择“Run”&gt;“Debug Configurations...”。<em></em></li>
<li>在弹出式对话框中，从左侧菜单中选择“Remote Java Application”。<em></em></li>
<li>点击操作栏上的“New launch configuration”图标。<em></em></li>
<li>根据需要为配置命名，并选择 <strong>tradefederation</strong> 作为项目。</li>
<li>使用前面提供的地址填写端口。</li>
<li><em></em><em></em>切换到“Source”标签，然后将 <strong>tradefederation</strong> 和 <strong>google-tradefed</strong> 项目添加到“Source Lookup Path”。</li>
<li>点击 <strong>Debug</strong> 以启动调试会话。</li>
</ol>

<p>调试程序将连接到正在监听 JVM 进程，并且运行 <code>tradefed.sh</code> 的终端将显示 <code>tf&gt;</code> 提示符。</p>

<p>要在调试模式下单步调试代码，请在 Eclipse 中设置断点，并在终端中调用 Tradefed 命令（即 <code>run &lt;test&gt;</code>）。要在 TF 启动期间调试任何内容，您可以先设置断点，然后再连接 Eclipse 调试程序。</p>

<p>提示：要使用备用端口，请将 <code>TF_DEBUG_PORT=nnn</code> 添加到上方第 1 步中的命令。如果您要调查难解的挂起错误，甚至可以在生产环境中使用此方法：在 <code>tradefed.sh</code> 中将 <code>suspend=y</code> 更改为 <code>suspend=n</code>，并使用调试标记启动。JVM 不会等待连接调试程序，但只要进程仍在运行，您就可以随时执行此操作。</p>

<h3 id="remote_debug_using_jdb">使用 JDB 进行远程调试</h3>

<p>要使用 Java 调试程序 JDB，请按照以下步骤操作（这些步骤与使用 Eclipse 时的步骤类似）：</p>

<ol>
<li>使用调试标记启动 <code>tradefed.sh</code>：<code>TF_DEBUG=1 tradefed.sh</code></li>
<li>等待 JVM 显示以下提示符：<code>Listening for transport dt_socket
at address: 10088</code>。</li>
<li><p>连接 <code>jdb</code>。例如，从 croot 运行：</p>
<pre class="prettyprint lang-shell"><code>jdb -attach 10088 \
    -sourcepath tools/tradefederation/core/src:vendor/google_tradefederation/core/src
</code></pre></li>
<li><p>等待连接并进行调试！要获取更多帮助，请运行 <code>man jdb</code>。</p></li>
</ol>

<h2 id="examine_code_coverage">检查代码覆盖率</h2>

<ol>
<li>安装 <a href="https://www.eclemma.org/">Eclemma 插件</a>。</li>
<li>依次转到“Help”&gt;“Install New Software”，然后将向导指向：http://update.eclemma.org/<em></em></li>
<li>安装后，依次选择“Coverage As”&gt;“JUnit test”选项以执行代码覆盖率运行。<em></em></li>
</ol>

</body></html>