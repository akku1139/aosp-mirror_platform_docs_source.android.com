<html devsite><head>
    <title>内核控制流完整性</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>
  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          //www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->
<p>
<a href="https://clang.llvm.org/docs/ControlFlowIntegrity.html">控制流完整性 (CFI)</a> 是一种安全机制，它不允许更改已编译二进制文件的原始控制流图，因而执行此类攻击变得异常困难。
</p>
<p>
在 Android 9 中，我们在更多组件以及内核中启用了 LLVM 的 CFI 实现。<a href="/devices/tech/debug/cfi">系统 CFI</a> 默认处于启用状态，但内核 CFI 需要您手动启用。</p>
<p>
LLVM 的 CFI 需要使用<a href="https://llvm.org/docs/LinkTimeOptimization.html">链接时优化 (LTO)</a> 进行编译。LTO 会一直保留对象文件的 LLVM 位码表示法直至链接时，以便编译器更好地推断可以执行哪些优化。启用 LTO 可缩减最终二进制文件的大小并提高性能，但会增加编译时间。在 Android 上进行测试时，结合使用 LTO 和 CFI 对代码大小和性能开销的影响微乎其微；在少数情况下，这两者都会有所改善。
</p>
<p>
有关 CFI 以及如何处理其他前向控制检查的更多技术详情，请参阅 <a href="https://clang.llvm.org/docs/ControlFlowIntegrityDesign.html">LLVM 设计文档</a>。
</p>
<h2 id="implementation">实现</h2>
<p>
Android 通用内核 4.9 和 4.14 版本中提供对内核 CFI 的支持。如果您的内核基于 4.9 或 4.14 版本且使用 Clang 进行构建，那么您可以启用它。要启用 kCFI，您需要复制相关修补程序并更新内核配置文件。
</p>
<h3 id="copy-kcfi-patches">复制 kCFI 补丁程序</h3>
<p>
将以下更改添加到您的内核：
</p>
<ul>
<li><a href="https://android-review.googlesource.com/q/topic:android-4.9-cfi">4.9 版本</a></li>
<li><a href="https://android-review.googlesource.com/q/topic:android-4.14-cfi">4.14 版本</a></li>
</ul>

<h3 id="enable-kcfi">启用 kCFI</h3>
<p>
复制相关更改后，您需要在内核配置文件中启用 kCFI，例如 <code>/kernel/<var>PROJECT</var>/+/<var>BRANCH</var>/arch/arm64/configs/<var>PROJECT</var>_defconfig</code>。
</p>
<p>
要启用 kCFI，请添加以下行：
</p>

<pre class="prettyprint">CONFIG_LTO_CLANG=y
CONFIG_CFI_CLANG=y</pre>

<h3 id="troubleshooting">问题排查</h3>
<p>
启用 kCFI 后，修正其驱动程序可能存在的任何类型不匹配错误。通过不兼容的函数指针调用 indirect 函数，将导致 CFI 故障。当检测到 CFI 故障时，内核会输出一条警告，其中包括被调用的函数和导致故障的堆栈轨迹。您可以通过确保函数指针始终与调用的函数属于同一类型来修正此问题。
</p>
<p>
要协助调试 CFI 故障，请启用 <code>CONFIG_CFI_PERMISSIVE</code>，它会输出警告（而不会导致内核崩溃）。切勿在正式版中使用宽容模式。
</p>

<h2 id="validation">验证</h2>
<p>
目前没有专门针对 CFI 的 CTS 测试。不过，您可以确保无论是否启用 CFI，CTS 测试均能通过，从而确定 CFI 不会影响设备。
</p>

</body></html>