<html devsite><head>
    <title>跟踪窗口转换</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>

  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>WinScope 提供了用于在窗口转换期间和转换后记录和分析 WindowManager 状态和 SurfaceFlinger 状态的基础架构和工具。WinScope 将所有相关的系统服务状态记录在一个跟踪文件中，您可以使用该文件重现并逐步查看转换。</p>

<h2 id="capture_trace">记录跟踪情况</h2>

<p>在运行 userdebug 或 eng 版本的设备上通过<strong>快捷设置</strong>或 <code>adb</code> 记录跟踪情况。</p>

<h3 id="quick_settings">快捷设置</h3>

<p>要通过<strong>快捷设置</strong>记录跟踪情况，请执行以下操作：</p>

<ol>
  <li><a href="https://developer.android.com/studio/debug/dev-options#enable" class="external">启用开发者选项</a>。</li>
  <li>依次转到<strong>开发者选项</strong> &gt; <strong>快捷设置开发者图块</strong>。</li>
  <li>启用 <strong>WinScope 跟踪</strong>。</li>
  <li>打开<strong>快捷设置</strong>。</li>
  <li>点按 <strong>Winscope 跟踪</strong>以启用跟踪。</li>
  <li>在设备上执行窗口转换。</li>
  <li>窗口转换完成后，打开<strong>快捷设置</strong>，然后点按 <strong>Winscope 跟踪</strong>以停用跟踪。</li>
</ol>

<p>跟踪记录会被写入 <code>/data/misc/wmtrace/wm_trace.pb</code> 和 <code>/data/misc/wmtrace/layers_trace.pb</code>，同时还会包含在错误报告中。</p>

<h3 id="adb"><code>adb</code></h3>

<p>在通过 <code>adb</code> 记录跟踪情况时，请分别记录 WindowManager 和 SurfaceFlinger 的跟踪情况。</p>

<h4 id="wm-traces">WindowManager 跟踪</h4>

<p>要记录 WindowManager 的跟踪情况，请执行以下操作：</p>

<ol>
  <li>启用跟踪：<pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing start</pre>
  </li>
  <li>停用跟踪：<pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing stop</pre>
    </li>
    <li>获取跟踪文件：<pre class="devsite-terminal devsite-click-to-copy">
adb pull /data/misc/wmtrace/wm_trace.pb wm_trace.pb</pre>
  </li>
</ol>

<p>您可以选择性地为 WindowManager 跟踪更改各种设置的默认日志配置：</p>

<ul>
  <li>设置日志频率（针对事务或帧）：<pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing [<var>frame</var>&amp;hairsp;|&amp;hairsp;<var>transaction</var>]</pre></li>
  <li>配置日志条目的 Verbose 级别：<pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing level [<var>all</var>&amp;hairsp;|&amp;hairsp;<var>trim</var>&amp;hairsp;|&amp;hairsp;<var>critical</var>]</pre></li>
  <li>设置缓冲区空间上限（以 KB 为单位）：<pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing size <var>size-value</var></pre></li>
  <li>转储缓冲区状态、日志级别、剩余容量和元素数量：<pre class="devsite-terminal devsite-click-to-copy">
adb shell cmd window tracing status</pre></li>
</ul>

<h4 id="sf-traces">SurfaceFlinger 跟踪</h4>

<p>要记录 SurfaceFlinger 的跟踪情况，请执行以下操作：</p>

<ol>
  <li>启用跟踪：<pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1025 i32 1</pre>
  </li>
  <li>停用跟踪：<pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1025 i32 0</pre>
  </li>
  <li>获取跟踪文件：<pre class="devsite-terminal devsite-click-to-copy">
adb pull /data/misc/wmtrace/layers_trace.pb layers_trace.pb</pre>
  </li>
</ol>

<p>您可以选择性地为 SurfaceFlinger 跟踪更改各种设置的默认日志配置：</p>

<ul>
  <li>设置缓冲区空间上限（以 KB 为单位）：<pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1029 i32 <var>size-value</var></pre></li>
  <li>配置日志条目的 Verbose 级别：<pre class="devsite-terminal devsite-click-to-copy">
adb shell su root service call SurfaceFlinger 1033 i32 <var>flags</var></pre></li>
</ul>

<h3 id="capture_trace_gen_state">生成状态转储文件</h3>

<p>WinScope 可以从错误报告中读取 WindowManager 状态和 SurfaceFlinger 状态的快照。错误报告会将状态信息以单独的 Proto 文件的形式存储在 <code>proto</code> 文件夹中。要使用 <code>adb</code> 生成状态转储文件，请运行以下命令。</p>

<p><strong>WindowManager</strong></p><p>

</p><pre class="devsite-terminal devsite-click-to-copy">
adb exec-out dumpsys window --proto &gt; window_dump.pb</pre>

<p><strong>SurfaceFlinger</strong></p><p>

</p><pre class="devsite-terminal devsite-click-to-copy">
adb exec-out dumpsys SurfaceFlinger --proto &gt; sf_dump.pb</pre>

<h2 id="analyze_traces">分析跟踪记录</h2>

<p>要分析跟踪文件，请使用 WinScope Web 应用。您可以在源代码的基础上编译此应用，也可以从预编译目录中打开此应用。</p>

<ol>
  <li>从 Android 源代码库中下载预编译的软件工件：<pre class="devsite-terminal devsite-click-to-copy">
curl 'https://android.googlesource.com/platform/prebuilts/misc/+/master/common/winscope/winscope.html?format=TEXT' | base64 -d &gt; winscope.html</pre></li>
  <li>在网络浏览器中打开下载的软件工件。</li>
  <li>打开 WinScope 后，选择<strong>打开文件</strong>以加载跟踪文件。</li>
</ol>

<h3 id="using_winscope">使用 WinScope</h3>

<p>在 WinScope 中打开跟踪文件后，您便可以通过多种方式对该文件进行分析。</p>

<img src="images/winscope_screenshot.png" alt="WinScope 屏幕截图"/>
<figcaption><strong>图 1. </strong> 在 WinScope 中分析跟踪记录</figcaption>

<ul>
  <li><strong>时间轴</strong> - 您可以通过时间轴查看跟踪记录中的事件序列。您可以使用箭头键或点击各个条目以浏览时间轴。</li>
  <li><strong>屏幕</strong> - 您可以在屏幕上直观地查看每个可见窗口。点击屏幕上的某个窗口即可选择层次结构中相应的源窗口。</li>
  <li><strong>层次结构</strong> - 您可以通过层次结构查看系统已知的每个窗口。有些窗口不包含缓冲区，它们存在的目的在于为其子项设置政策。可见窗口均标有 <code>V</code> 图标。</li>
  <li><strong>属性</strong> - 您可以在属性中查看层次结构中所选条目的状态信息。</li>
</ul>

</body></html>
