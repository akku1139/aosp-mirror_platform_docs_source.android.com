<html devsite><head>
    <title>内核配置</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>
  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>
您可以将以下配置设置用作 Android 内核配置的基础。设置会整理到 <code>android-base</code>、<code>android-base-<var>ARCH</var></code> 和 <code>android-recommended</code> .cfg 文件中：</p>

<ul>
  <li><code>android-base</code>。这些选项可实现核心 Android 功能，并且应配置为所有设备指定的选项。</li>
  <li><code>android-base-<var>ARCH</var></code>。这些选项可实现核心 Android 功能，并且应配置为架构 ARCH 的所有设备指定的选项。并非所有架构都具有相应的特定于架构的必需选项文件。<var></var>如果您的架构没有相应文件，则它没有额外特定于架构的 Android 内核配置要求。</li>
  <li><code>android-recommended</code>。这些选项可实现高级 Android 功能，设备可选择性启用。</li>
</ul>

<p>这些配置文件位于 <code><a href="https://android.googlesource.com/kernel/configs/" class="external">kernel/configs</a></code> repo 中。使用一组对应您正在使用的内核版本的配置文件。
</p>

<p>
  如需详细了解已用于加强设备内核的控件，请参阅<a href="/security/overview/kernel-security.html">系统和内核安全</a>。如需详细了解必需的设置，请参阅 <a href="/compatibility/cdd.html">Android 兼容性定义文档 (CDD)</a>。
</p>

<h2 id="generating">生成内核配置</h2>

<p>
  对于具有极简 <code>defconfig</code> 的设备，您可以在内核树中使用 <code>merge_config.sh</code> 脚本来启用选项：
</p>

<pre class="devsite-click-to-copy">
ARCH=<var>ARCH</var> scripts/kconfig/merge_config.sh &lt;...&gt;/device_defconfig &lt;...&gt;/android-base.cfg &lt;...&gt;/android-base-<var>ARCH</var>.cfg &lt;...&gt;/android-recommended.cfg
</pre>

<p>
  这会生成一个 <code>.config</code> 文件，您可以使用该文件来保存新的 <code>defconfig</code> 或编译一个启用 Android 功能的新内核。
</p>

<h2 id="additional-kernel-reqs">其他内核配置要求</h2>

<p>
  在某些情况下，平台维护人员可以从多项内核功能中进行选择以满足 Android 依赖项的要求。此类依赖项不能在内核配置片段文件（如上所述）中表示，因为这些文件的格式不支持逻辑表达式。在 Android 9 中，<a href="/compatibility/cts/">兼容性测试套件 (CTS)</a> 和<a href="/compatibility/vts/">供应商测试套件 (VTS)</a> 会验证是否满足以下要求：
</p>

<ul>
  <li><code>CONFIG_OF=y</code> 或 <code>CONFIG_ACPI=y</code></li>
  <li>4.4 和 4.9 内核具有 <code>CONFIG_ANDROID_LOW_MEMORY_KILLER=y</code>，或同时具有 <code>CONFIG_MEMCG=y</code> 和 <code>CONFIG_MEMCG_SWAP=y</code>
  </li>
  <li><code>CONFIG_DEBUG_RODATA=y</code> 或 <code>CONFIG_STRICT_KERNEL_RWX=y</code></li>
  <li><code>CONFIG_DEBUG_SET_MODULE_RONX=y</code> 或 <code>CONFIG_STRICT_MODULE_RWX=y</code></li>
  <li>仅适用于 ARM64：<code>CONFIG_ARM64_SW_TTBR0_PAN=y</code> 或 <code>CONFIG_ARM64_PAN=y</code></li>
</ul>

<p>
  此外，对于 Android 9 中的 4.9 内核，必须将 <code>CONFIG_INET_UDP_DIAG</code> 选项设置为 <code>y</code>。
</p>

<h2 id="usb">启用 USB 主机模式选项</h2>

<p>
  对于 USB 主机模式音频，请启用以下选项：
</p>

<pre class="devsite-click-to-copy">
CONFIG_SND_USB=y
CONFIG_SND_USB_AUDIO=y
# CONFIG_USB_AUDIO is for a peripheral mode (gadget) driver
</pre>

<p>
  对于 USB 主机模式 MIDI，请启用以下选项：
</p>

<pre class="devsite-click-to-copy">CONFIG_SND_USB_MIDI=y</pre>

<h2 id="Seccomp-BPF-TSYNC">Seccomp-BPF 与 TSYNC</h2>

<p>
  Seccomp-BPF 是一种内核安全技术，支持创建沙盒来限制进程可以进行的系统调用。TSYNC 功能可以实现从多线程程序中使用 Seccomp-BPF。这种能力仅限由上游提供 seccomp 支持的架构（ARM、ARM64、x86 和 x86_64）。
</p>

</body></html>