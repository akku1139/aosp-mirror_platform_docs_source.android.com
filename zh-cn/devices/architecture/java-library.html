<html devsite><head>
    <title>实现 Java SDK 库</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>

  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

    <p>Android 平台包含大量共享 Java 库，可以使用应用清单中的 <code>&lt;uses-library&gt;</code> 标记选择性将其纳入应用的类路径中。由于应用链接到这些库，因此在兼容性、API 审核和工具支持方面，应将其视为 Android API 的其余部分。不过，大多数库都没有这些功能。
    </p>
    <p>Android 10 引入了 <code>java_sdk_library</code>，这是一个新的编译规则，可修复共享 Java 库的兼容性问题。设备制造商可以将此机制用于自己的共享 Java 库，以维护其 API 的向后兼容性。如果设备制造商通过 <code>&lt;uses-library&gt;</code> 标记（而不是 bootclass 路径）使用自己的共享 Java 库，则 <code>java_sdk_library</code> 可以验证这些 Java 库是否具备 API 稳定性。
    </p>
    <p><code>java_sdk_library</code> 是一个 Java 库，为应用实现可选的 SDK API。通过 make 文件 (<code>Android.bp</code>) 中的 <code>java_sdk_library</code> 实现的库执行以下操作：</p>
    <ul>
      <li>生成存根库以包括 <code>stubs</code>、<code>stubs.system</code> 和 <code>stubs.test</code>。系统通过识别 <code>@hide</code>、<code>@SystemApi</code> 和 <code>@TestApi</code> 注释创建这些存根库。在编译时，当 SDK 版本分别为 <code>current</code>、<code>system_current</code> 和 <code>test_current</code> 时，它们会自动进行引用。</li>
      <li>Android 通过存根文件获取 API 列表，并通过将 master 中的当前 API 列表与最新发布的 Android 版本中的 API 列表进行比较来验证 API 是否以向后兼容的方式进行维护。</li>
      <li>如果安装了运行时的实现库，则会生成并安装 XML 文件。</li>
    </ul>

   <figure>
     <img src="/devices/architecture/images/build-flow-java-lib.png" alt="使用 Java SDK 库的编译流程"/>
     <figcaption><b>图 1.</b> 使用 Java SDK 库的编译流程</figcaption>
   </figure>

    <h2 id="examples-and-sources">示例和来源</h2>

    <p>存根库的最小组件是必需的 <code>srcs</code> 和 <code>api_packages</code> 属性。
    </p>

    <pre class="prettyprint">java_sdk_library {
        name: "com.android.future.usb.accessory",
        srcs: ["src/**/*.java"],
        api_packages: ["com.android.future.usb"],
    }</pre>

    <p>要编译用于运行时的 impl 库，请填充所有 <code>java_library</code> 属性，例如 <code>hostdex</code>、<code>compile_dex</code> 和 <code>errorprone</code>。
    </p>

    <pre class="prettyprint">java_sdk_library {
        name: "android.test.base",

        srcs: ["src/**/*.java"],

        errorprone: {
          javacflags: ["-Xep:DepAnn:ERROR"],
        },

        hostdex: true,

        api_packages: [
            "android.test",
            "android.test.suitebuilder.annotation",
            "com.android.internal.util",
            "junit.framework",
        ],

        compile_dex: true,
    }</pre>

    <p>要创建存根库，请填充 <code>droidstubs</code> 属性，例如 <code>srcs_lib</code>、<code>srcs_lib_whitelist_dirs</code>、<code>srcs_lib_whitelist_pkgs</code>、<code>merge_annotations_dirs</code> 和 <code>merge_inclusion_annotations_dirs</code>。您还可以将以下属性用于存根库：</p>
    <ul>
      <li><code>api_srcs</code>：可选源文件列表，属于 API，但不属于运行时库。</li>
      <li><code>stubs_only_libs</code>：编译存根时类路径中的 Java 库列表。</li>
      <li><code>hidden_api_packages</code>：必须从 API 隐藏的软件包名称列表。</li>
      <li><code>droiddoc_options</code>：metalava 的附加参数。

      <pre class="prettyprint">java_sdk_library {
          name: "android.test.mock",

          srcs: ["src/**/*.java"],

          api_packages: [
              "android.test.mock",
          ],

          srcs_lib: "framework",
          srcs_lib_whitelist_dirs: ["core/java"],
          srcs_lib_whitelist_pkgs: ["android"],
          compile_dex: true,
      }</pre>

      </li>
    </ul>

    <h3 id="maintaining-backward-compatibility">保持向后兼容性</h3>

    <p>编译系统通过在编译时将最新的 API 文件与生成的 API 文件进行比较来检查 API 是否保持向后兼容性。此操作通过名为 <code>prebuilt_apis</code> 的新编译规则完成，该规则会创建预编译的存根库模块及 API 列表模块。使用 <code>java_sdk_library</code> 编译的所有库必须在 <code>prebuilt_apis</code> 中最新版本的 <code>api_dirs</code> 中包含 API 文件。当您发布版本时，可以使用 <code>PRODUCT-sdk_phone_armv7-sdk</code> 通过 dist build 获取 API 列表文件和存根库。
    </p>
    <p><code>api_dirs</code> 属性是 <code>prebuilt_apis</code> 中的 API 版本目录列表。API 版本目录应位于与 <code>Android.bp</code> 相同的目录级。
    </p>

    <pre class="prettyprint">prebuilt_apis {
        name: "sdk",
        api_dirs: [
            "1",
            "2",
              ....
            "28",
            "current",
        ],
    }</pre>

    <p>在 prebuilts 目录下配置 <code><var>version</var>/<var>scope</var>/api/</code> 结构的目录。<code><var>version</var></code> 对应于 API 级别，并且 <code><var>scope</var></code> 确定目录是公共、系统还是测试。</p>

    <ul>
      <li><code><var>version</var>/<var>scope</var></code> 包含 Java 库。</li>
      <li><code><var>version</var>/<var>scope</var>/api</code> 包含 API <code>.txt</code> 文件。在此处创建名为 <code><var>module_name</var>.txt</code> 和 <code><var>module_name</var>-removed.txt</code> 的空文本文件。

      <pre class="prettyprint">├── 28
      │   ├── public
      │   │   ├── api
      │   │   │   ├── android.test.base-removed.txt
      │   │   │   └── android.test.base.txt
      │   │   └── android.test.base.jar
      │   ├── system
      │   │   ├── api
      │   │   │   ├── android.test.base-removed.txt
      │   │   │   └── android.test.base.txt
      │   │   └── android.test.base.jar
      │   └── test
      │       ├── api
      │       │   ├── android.test.base-removed.txt
      │       │   └── android.test.base.txt
      │       └── android.test.base.jar
      └── Android.bp</pre>

      </li>
    </ul>

</body></html>