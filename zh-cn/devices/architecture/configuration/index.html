<html devsite><head>
    <title>配置</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>

  <!--
      Copyright 2019 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>Android 10 因 ConfigStore HAL 内存耗用量高且难以使用而将其弃用，并用系统属性替换了这个 HAL。在 Android 10 中：</p>

<ul>
  <li>ConfigStore 使用编译标记在供应商分区中存储配置值，系统分区中的服务使用 HIDL 访问这些值（在 Android 9 中也是如此）。
  </li><li>系统属性使用 <code>PRODUCT_DEFAULT_PROPERTY_OVERRIDES</code> 在供应商分区的 <code>default.prop</code> 中存储系统属性，而该服务使用 <code>sysprop</code> 读取这些属性。</li>
</ul>

<p>ConfigStore HAL 保留在 AOSP 中以支持旧版供应商分区。在搭载 Android 10 的设备上，<code>surfaceflinger</code> 首先读取系统属性；如果没有为 <code>SurfaceFlingerProperties.sysprop</code> 中的配置项定义任何系统属性，则 <code>surfaceflinger</code> 会回退到 ConfigStore HAL。</p>

<h2 id="build-flags-and-system-properties">编译标记和系统属性</h2>

<p>ConfigStore 中的每个编译标记都有一个匹配的系统属性，如下表所示。
</p>

<table>
  <tbody><tr>
   <th>编译标记</th>
   <th>系统属性</th>
  </tr>
  <tr>
  <td><code>TARGET_FORCE_HWC_FOR_VIRTUAL_DISPLAYS</code>
   </td>
   <td><code>ro.surface_flinger.force_hwc_copy_for_virtual_displays</code>
   </td>
  </tr>
  <tr>
  <td><code>TARGET_HAS_HDR_DISPLAY</code>
   </td>
   <td><code>ro.surface_flinger.has_HDR_display</code>
   </td>
  </tr>
  <tr>
   <td><code>TARGET_HAS_WIDE_COLOR_DISPLAY</code>
   </td>
   <td><code>ro.surface_flinger.has_wide_color_display</code>
   </td>
  </tr>
  <tr>
   <td><code>NUM_FRAMEBUFFER_SURFACE_BUFFERS</code>
   </td>
   <td><code>ro.surface_flinger.max_frame_buffer_acquired_buffers</code>
   </td>
  </tr>
  <tr>
   <td><code>MAX_VIRTUAL_DISPLAY_DIMENSION</code>
   </td>
   <td><code>ro.surface_flinger.max_virtual_display_dimension</code>
   </td>
  </tr>
  <tr>
   <td><code>PRIMARY_DISPLAY_ORIENTATION</code>
   </td>
   <td><code>ro.surface_flinger.primary_display_orientation</code>
   </td>
  </tr>
  <tr>
   <td><code>PRESENT_TIME_OFFSET_FROM_VSYNC_NS</code>
   </td>
   <td><code>ro.surface_flinger.present_time_offset_from_vsync_ns</code>
   </td>
  </tr>
  <tr>
   <td><code>TARGET_RUNNING_WITHOUT_SYNC_FRAMEWORK</code>
   </td>
   <td><code>ro.surface_flinger.running_without_sync_framework</code>
   </td>
  </tr>
  <tr>
   <td><code>SF_START_GRAPHICS_ALLOCATOR_SERVICE</code>
   </td>
   <td><code>ro.surface_flinger.start_graphics_allocator_service</code>
   </td>
  </tr>
  <tr>
   <td><code>TARGET_USE_CONTEXT_PRIORITY</code>
   </td>
   <td><code>ro.surface_flinger.use_context_priority</code>
   </td>
  </tr>
  <tr>
   <td><code>USE_VR_FLINGER</code>
   </td>
   <td><code>ro.surface_flinger.use_vr_flinger</code>
   </td>
  </tr>
  <tr>
   <td><code>VSYNC_EVENT_PHASE_OFFSET_NS</code>
   </td>
   <td><code>ro.surface_flinger.vsync_event_phase_offset_ns</code>
   </td>
  </tr>
  <tr>
   <td><code>SF_VSYNC_EVENT_PHASE_OFFSET_NS</code>
   </td>
   <td><code>ro.surface_flinger.vsync_sf_event_phase_offset_ns</code>
   </td>
  </tr>
</tbody></table>

<h2 id="new-system-properties">新系统属性</h2>

<p>Android 10 包含以下新系统属性：</p>

<ul>
<li><code>ro.surface_flinger.default_composition_dataspace</code>
  </li><li><code>ro.surface_flinger.default_composition_pixel_format</code>
  </li><li><code>ro.surface_flinger.use_color_management</code>
  </li><li><code>ro.surface_flinger.wcg_composition_dataspace</code>
  </li><li><code>ro.surface_flinger.wcg_composition_pixel_format</code>
  </li><li><code>ro.surface_flinger.display_primary_red</code>
  </li><li><code>ro.surface_flinger.display_primary_green</code>
  </li><li><code>ro.surface_flinger.display_primary_blue</code>
  </li><li><code>ro.surface_flinger.display_primary_white</code>
  </li><li><code>ro.surface_flinger.protected_contents</code>
  </li><li><code>ro.surface_flinger.set_idle_timer_ms</code>
  </li><li><code>ro.surface_flinger.set_touch_timer_ms</code>
  </li><li><code>ro.surface_flinger.use_smart_90_for_video</code>
  </li><li><code>ro.surface_flinger.protected_contents</code>
  </li><li><code>ro.surface_flinger.support_kernel_idle_timer</code></li>
</ul>

<p>如需详细了解这些属性，请参阅 <code>frameworks/native/services/surfaceflinger/sysprop/SurfaceFlingerProperties.sysprop</code>。
</p>

<h2 id="using-surfaceflingerproperties">使用 SurfaceFlingerProperties</h2>
<p>在 SurfaceFlingerProperties 库的以下示例中，函数名称是 <code>SurfaceFlingerProperties.sysprop</code> 中的 <code>api_name</code>。
</p>

<pre class="prettyprint">cc_binary {
    name: "cc_client",
    srcs: ["baz.cpp"],
    shared_libs: ["SurfaceFlingerProperties"],
}
java_library {
    name: "JavaClient",
    srcs: ["foo/bar.java"],
    libs: ["SurfaceFlingerProperties"],
}</pre>

<pre class="prettyprint">import android.sysprop.SurfaceFlingerProperties;
...

static void foo() {
    ...
    boolean temp = SurfaceFlingerProperties.vsync_event_phase_offset_ns().orElse(true);
    ...
}
...</pre>

<pre class="prettyprint">#include &lt;SurfaceFlingerProperties.sysprop.h&gt;
using namespace android::sysprop;

...

void bar() {
    ...
    bool temp = SurfaceFlingerProperties::vsync_event_phase_offset_ns(true);
    ...
}
...</pre>

</body></html>