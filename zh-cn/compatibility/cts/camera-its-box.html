<html devsite><head>
    <title>相机盒装 ITS</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>

  <!--
      Copyright 2017 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>Android 相机图像测试套件 (ITS) 是 Android 兼容性测试套件 (CTS) 验证程序的一部分，并且包含可验证图像内容的测试。从 CTS 7.0_r8 开始，CTS 验证程序通过相机盒装 ITS 支持 ITS 测试自动化；而且继续支持手动测试以确保涵盖所有类型的 Android 设备。</p>

<p>盒装 ITS 具有以下优势：</p>
<ul>
<li><strong>自动化</strong>。在测试期间不需要人为干预。</li>
<li><strong>缩短测试时间</strong>。可以对前置/后置摄像头进行并行测试，将测试周期缩短了 50％。</li>
<li><strong>问题排查更轻松</strong>。测试环境保持一致，减少了设置错误并提升了重现能力。</li>
<li><strong>高效</strong>。能够针对单个相机/场景进行重试，提高了测试执行效率。</li>
</ul>

<h2 id="get-started">开始设置</h2>
<p>盒装 ITS 由一个根据计算机辅助设计 (CAD) 图纸激光切割而成的塑料盒、一部图表平板电脑和一部被测设备 (DUT) 组成。您可以使用宽视野 (WFoV) 盒装 ITS（这种 ITS 能够测试 WFoV（FoV &gt; 90 度）相机和 RFoV（FoV &lt; 90 度）相机），也可以使用常规视野 (RFoV) 盒装 ITS。</p>

<p>要开始使用相机盒装 ITS，请执行以下操作：</p>
<ol>
<li>购买或构建<a href="/compatibility/cts/camera-wfov-box-assembly">宽视野 (WFoV)</a> 或<a href="/compatibility/cts/camera-its-box-assembly">常规视野 (RFoV)</a> 盒装 ITS。</li>
<li>使用 CameraITS 软件<a href="#configure-tablet">配置平板电脑</a>。</li>
<li><a href="#run-tests">运行测试</a>。</li>
<li>从 DUT 中<a href="#get-results">获取结果</a>。</li>
</ol>

<h2 id="configure-tablet">配置平板电脑</h2>
<p>本部分将分步说明如何设置平板电脑以与相机 ITS 软件配合使用。这些说明使用 Pixel C 作为示例平板电脑。要了解针对平板电脑的要求和建议，请参阅<a href="#tablet-requirements">针对平板电脑的要求</a>。</p>

<p class="note"><strong>注意</strong>：相机 ITS Python 脚本会自动在平板电脑上为您设置以下选项：<br /><em>设置 &gt; 显示 &gt; 休眠 &gt; 无操作 30 分钟后</em>
<br /><em>自动调节亮度 &gt; 关闭</em>
</p>

<ol>
<li>为平板电脑接通电源并开机。如果系统提示您设置帐号，请跳过（相机 ITS 不需要与平板电脑配对任何帐号）。</li>
<li>将平板电脑更新为 Android 7.0 或更高版本。Android 6.x 及更低版本不支持相机 ITS。</li>
<li>启用<a href="https://developer.android.com/studio/debug/dev-options#enable" class="external">开发者模式</a>。</li>
<li><em></em>返回“设置”并选择<strong>开发者选项</strong>。

<table>
<tbody><tr>
<th>启用选项</th>
<td>
<ul>
<li>开启</li>
<li>不锁定屏幕</li>
<li>USB 调试（这样可以允许主机在调试模式下运行平板电脑。首次将平板电脑连接到主机时，平板电脑会提示您“允许 USB 调试吗？”。如果平板电脑没有显示调试提示，请断开连接，然后重新连接平板电脑。）</li>
</ul>
</td>
</tr>
<tr>
<th>停用选项</th>
<td>
<ul>
<li>自动系统更新</li>
<li>通过 USB 验证应用</li>
</ul>
</td>
</tr>
</tbody></table>
</li>
<li>通过运行 <code>$ adb devices</code> 列出可用设备来确定 DUT 和图表 ID。要确定 <code>device_id</code> 和 <code>chart_id</code>，请插上再拔下设备并观察连接和断开连接的设备。</li>
<li>执行三次测试，以隐藏可能会遮盖平板电脑屏幕上的图表的提示和用户提示。
<ol style="list-style-lower-alpha">
<li>将平板电脑正面朝上放在桌子上（请勿将平板电脑连接到盒子的后板）</li>
<li>运行以下命令：<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=$device_id camera=0 chart=$chart_id scenes=2,3
</pre>场景 2 和 3 需要使用平板电脑来显示图像，因此平板电脑会提示您“允许云端硬盘访问您设备上的照片、媒体和文件吗？”。通过按<strong>允许</strong>清除此提示（并防止以后再次出现提示）。</li>
<li>再次运行该命令。平板电脑会提示您“保留此文件的副本吗？”，并建议保存到 Google 云端硬盘。通过按“云端硬盘”图标，然后按<strong>取消</strong>上传到云端硬盘，清除此提示（并防止以后再次出现提示）。</li>
<li>最后，运行 <code>tools/run_all_tests.py</code> 并确认当前场景会随着脚本循环自动变换为不同的场景。尽管大多数测试将失败（因为相机未指向图表），但您可以验证平板电脑是否正确地循环播放场景，而不会在屏幕上显示任何提示或其他弹出式窗口。</li></ol></li></ol>

<h2 id="run-tests">运行测试</h2>
<p>在运行盒装 ITS 之前，请确保您的测试设置包含以下硬件和软件：</p>
<ul>
<li>一 (1) 个盒装 ITS</li>
<li>一 (1) 部用于显示场景的 Pixel C，序列号：5811000011</li>
<li>两 (2) 个 DUT，它们使用相同的版本号指纹并安装了 CTS 验证程序 7.0_8+ 应用。DUT 示例：<ul>
<li>一 (1) 部用于后置摄像头 (0) 测试的 Pixel NOF26W，序列号：FA6BM0305016。要安装 CTS 验证程序应用，请解压缩 android-cts-verifier.zip，然后运行<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305016 install -r android-cts-verifier/CtsVerifier.apk
</pre></li>
<li>一 (1) 部用于前置摄像头 (1) 测试的 Pixel NOF26W，序列号：FA6BM0305439。要安装 CTS 验证程序应用，请解压缩 android-cts-verifier.zip，然后运行<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305439 install -r android-cts-verifier/CtsVerifier.apk
</pre>
</li>
</ul>
</li></ul>

<h3 id="scenes-0-4">运行场景 0-4</h3>
<p>对前置和后置摄像头并行运行场景 0-4：</p>
<pre class="devsite-click-to-copy">
<code class="devsite-terminal">cd android-cts-verifier/CameraITS</code>
<code class="devsite-terminal">. build/envsetup.sh</code>
<code class="devsite-terminal">python tools/run_parallel_tests.py device0=FA6BM0305016 device1=FA6BM0305439 chart=5811000011</code>
</pre>

<p>示例：</p>
<table>
<tbody><tr>
<td><img src="/compatibility/cts/images/camera_its_cam0.png" align="center"/></td>
<td align="center"><img src="/compatibility/cts/images/camera_its_cam0.png"/></td>
</tr>
<tr>
<td align="center"><p class="caption"><strong>图 1.</strong> 相机 0 序列号：FA6BM0305016</p>
</td>
<td align="center"><p class="caption"><strong>图 2.</strong> 相机 1 序列号：FA6BM0305439</p>
</td>
</tr>
</tbody></table>

<h3 id="retry-scenes">重试场景</h3>
<p>您可以为前置和后置摄像头或单个摄像头重试场景：</p><ul>
<li>对前置和后置摄像头并行重试场景：<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_parallel_tests.py device0=FA6BM0305016 device1=FA6BM0305439 chart=5811000011 scenes=3,4
</pre>
</li>
<li>对单个摄像头重试场景：<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=FA6BM0305016 chart=5811000011 camera=1 scenes=3,4
</pre>
</li>
</ul>

<h3 id="scenes-0-4">运行场景 5</h3>
<p>场景 5 需要进行特殊设置以获得特定光线（有关详情，请参阅 CTS 验证程序中的 <code>CameraITS.pdf</code> 文档，您可以在<a href="/compatibility/cts/downloads">兼容性测试套件下载</a>中进行下载）。您可以单独运行场景 5（在盒子外部）以并行测试两部设备。</p>
<ul>
<li>在两部设备上为前置和后置摄像头并行运行场景 5：<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_parallel_tests.py device0=FA6BM0305016 device1=FA6BM0305439 chart=5811000011 scenes=5
</pre>
<br /><img src="/compatibility/cts/images/camera_its_scene5.png" width="50%"/><br />
<strong>图 3.</strong> 相机场景 5</li>
<li>在单部设备上为前置和后置摄像头运行场景 5：<pre class="devsite-click-to-copy">
<code class="devsite-terminal">python tools/run_all_tests.py device=FA6BM0305016 camera=0 scenes=5</code>
<code class="devsite-terminal">python tools/run_all_tests.py device=FA6BM0305016 camera=1 scenes=5</code>
</pre></li>
</ul>

<h2 id="get-results">获取结果</h2>
<p>您可以在测试期间查看结果，并将完成的结果另存为报告。</p>
<ul>
<li><strong>查看运行测试的进度</strong>。命令 <code>run_parallel_tests</code> 仅在相机场景测试完成后输出结果，因此要在执行测试期间查看结果，您必须使用 Android 设备监控器或 <code>adb logcat</code> 来验证进度和/或查看屏幕截图。<br />
<br />adb 命令示例：<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305016 logcat -v time
</pre>屏幕截图命令示例：<pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb -s FA6BM0305016 shell screencap -p /sdcard/screencap.png</code>
<code class="devsite-terminal">adb -s FA6BM0305016 pull /sdcard/screencap.png</code>
<code class="devsite-terminal">display ./screencap.png</code>
</pre></li>
<li><strong>查看结果</strong>。将相机 ITS 结果另存为报告：<ol>
<li>按<strong>通过</strong>并保存报告：<br /><img src="/compatibility/cts/images/camera_its_results.png" width="50%"/><br />
<strong>图 4.</strong> 相机 ITS 报告</li>
<li>从设备中提取报告：<pre class="devsite-terminal devsite-click-to-copy">
adb -s FA6BM0305016 pull /sdcard/verifierReports
</pre>
</li>
<li>解压缩报告文件并查看 test_result.xml。
<br /><img src="/compatibility/cts/images/camera_its_reports.png"/><br />
<strong>图 5.</strong> 相机 ITS 报告<br /></li>
</ol>
</li>
</ul>

<h2 id="tablet-requirements">针对平板电脑的要求</h2>

<p>平板电脑的显示屏尺寸必须为 10 英寸左右，并且屏幕分辨率必须大于 2000 x 1500 像素。必须根据平板电脑型号在 <code>CameraITS/tools/wake_up_screen.py</code> 中设置 <code>DISPLAY_LEVEL</code> 值。下表列出了适用于推荐的平板电脑的值。</p>

<p>下面显示了针对 ITS 测试推荐的平板电脑：</p>

<table>
  <tbody><tr>
    <th>设备</th>
    <th>显示屏尺寸<br />（英寸）</th>
    <th>显示大小<br />（像素）</th>
    <th>平板电脑尺寸<br />（英寸）</th>
    <th>显示级别</th>
    <th>操作系统</th>
  </tr>
  <tr>
    <td>Asus Zen Pad 3</td>
    <td>9.7</td>
    <td>2048 x 1536</td>
    <td>9.47 x 6.44 x 0.28</td>
    <td>192</td>
    <td>Android 6.0</td>
  </tr>
  <tr>
    <td>Huawei Mediapad m5</td>
    <td>10.8</td>
    <td>2560 x 1600</td>
    <td>10.18 x 6.76 x 0.29</td>
    <td>192</td>
    <td>Android 8.0</td>
  </tr>
  <tr>
    <td>Pixel C</td>
    <td>10.2</td>
    <td>2560 x 1800</td>
    <td>9.53 x 7.05 x 0.28</td>
    <td>96</td>
    <td>Android 8.0</td>
  </tr>
  <tr>
    <td>Samsung S3</td>
    <td>9.7</td>
    <td>2048 x 1536</td>
    <td>10.76 x 6.65 x 0.24</td>
    <td>192</td>
    <td>Android 7.0</td>
  </tr>
  <tr>
    <td>Sony Xperia Z4</td>
    <td>10.1</td>
    <td>2560 x 1600</td>
    <td>10 x 6.57 x 0.24</td>
    <td>192</td>
    <td>Android 7.0</td>
  </tr>
</tbody></table>

<h2 id="faq">常见问题解答 (FAQ)</h2>

<h3 id="faq-1">Q1：如何确定我的设备需要哪些测试装置？</h3>

<p><a href="/compatibility/cts/camera-its-box-assembly">RFoV 盒装 ITS 修订版 1</a> 用于测试常规视野 (RFoV) 相机，可以运行 <code><a href="https://android.googlesource.com/platform/cts/+/master/apps/CameraITS/tests/">
  CameraITS/tests</a></code> 目录下的场景 0-4 测试。RFoV 的定义为：60° &lt; FoV &lt; 90°。<em></em>对于 FoV 更大的相机，图像中可能会出现光线，或者图表覆盖的 FoV 区域可能过小，这会影响测试结果。</p>

<p><a href="/compatibility/cts/camera-wfov-box-assembly">WFoV 盒装 ITS 修订版 2</a> 用于测试宽视野 (WFoV) 相机，可以运行 <code><a href="https://android.googlesource.com/platform/cts/+/master/apps/CameraITS/tests/">
  CameraITS/tests</a></code> 目录下的场景 0-4 测试。WFoV 的定义为：FoV &gt;= 90°。<em></em>它的功能与修订版 1 相同，但视野更大。修订版 2 测试装置可用于测试 Android 9 及更高版本中的 RFoV 和 WFoV 相机。</p>

<p><a href="/compatibility/cts/sensor-fusion-quick-start">传感器融合盒</a>可以通过 <code>scenes=sensor_fusion</code> 中的测试来测试相机/陀螺仪定时偏差以及多摄像头系统帧同步。<code>REALTIME</code> 功能标记和 VR/AR 应用要求相机/陀螺仪定时偏差小于 1 毫秒。</p>

<p>如果相机具有 <code>REALTIME</code> 功能标记，则可以通过用于静态 ITS 测试的单个装置以及传感器融合装置来测试多摄像头设备。</p>

<p>下表提供了一组示例配置。</p>

<table>
<tbody><tr>
<th>示例</th>
<th>相机 FoV</th>
<th>是否具有 REALTIME？</th>
<th>推荐装置</th>
<th>备注</th>
</tr>
<tr>
<td>1</td>
<td>75°</td>
<td>否</td>
<td>修订版 1</td>
<td>Android 7.0 或更高版本</td>
</tr>
<tr>
<td>2</td>
<td>75°</td>
<td>是</td>
<td>修订版 1 + 传感器融合</td>
<td>Android 9 或更高版本</td>
</tr>
<tr>
<td>3</td>
<td>75° + 95°</td>
<td>是</td>
<td>修订版 2 + 传感器融合</td>
<td>Android 9 或更高版本</td>
</tr>
</tbody></table>

<h3 id="faq-2">Q2：如何调试单个测试？</h3>

<p>可以单独运行各个测试以进行调试，但除非运行整个场景，否则系统不会将测试结果上报给 <code>CtsVerifier.apk</code>。在运行 <code>tools/run_all_tests.py</code> 时，系统会将结果输出到本地屏幕，同时将图像保存到本地目录，而不是生成 <code>/tmp/tmp###</code> 目录。</p>

<p>要运行单个场景，请执行以下操作：</p>

<ol>
  <li>通过在 <code>tools/run_all_tests.py</code> 中添加 <code>scenes</code> 标记来加载场景：<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=# camera=# chart=# scenes=#
</pre>
  </li><li>
  <p>在场景被记录为已加载到 <code>stdout</code> 之后，按<kbd><strong> Control+C</strong></kbd> 停止测试。</p>
  <p>如果屏幕上已经显示正确场景，请唤醒屏幕：</p>
<pre class="devsite-terminal devsite-click-to-copy">
python tools/wake_up_screen.py screen=#
</pre>
  </li>
  <li>
    <p>运行单个测试。</p>
    <pre class="devsite-terminal devsite-click-to-copy">python tests/scene#/test_*.py device=# camera=#</pre>
    <p>然后，系统会在本地目录下生成绘图，并将 <code>stdout</code> 和 <code>stderr</code> 输出到屏幕上。</p>
    <p>要详细了解如何进行调试，请将 <code>print</code> 语句添加到脚本中。要增加用于调试的测试输出，请添加 <code>debug=True</code> 标记。</p>
    <pre class="devsite-terminal devsite-click-to-copy">python tests/scene#/test_*.py device=# camera=# debug=True</pre>
  </li>
</ol>

<h3 id="faq-3">问题 3：为什么需要将失败的测试作为整个场景运行，而不是单独重新运行相应测试？</h3>

<p>可以单独运行各个测试以进行调试，但除非运行整个场景，否则系统不会将测试结果上报给 <code>CtsVerifier.apk</code>。</p>

<p>相机 ITS 确保第三方应用具有兼容的摄像头接口。与单元测试类似，每个测试侧重于相机的一项规范。<em></em>为了捕获不可靠的行为，预计这些测试将在整个场景中作为一个整体通过。例如，虽然在重新运行整个场景时单个不可靠的测试可能会通过，但多个不可靠的测试很难通过。</p>

<p>以一种极端情况为例，假设某个场景中有 10 个测试，每个测试都有 50% 的概率返回 <code>PASS</code>。通过单独运行每个测试，操作人员让相机通过相机 ITS 测试的概率会很高。但是，如果将测试作为一个场景以整体运行，则场景通过的概率只有 0.1%。</p>

<h3 id="faq-4">问题 4：如何运行单个场景或重新排列运行场景顺序？</h3>

<p>默认情况下，脚本 <code>tools/run_all_tests.py</code> 按顺序运行所有场景。但是，系统也可以单独运行各个场景或按指定顺序运行场景，并将结果上报给 <code>CtsVerifier.apk</code>。</p>

<p>要运行单个场景（例如 scene2），请使用以下命令：</p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=# camera=# chart=# <strong>scenes=2</strong>
</pre>

<p>要按特定顺序运行多个场景，请使用以下命令：</p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py device=# camera=# chart=# <strong>scenes=3,2</strong>
</pre>

<h3 id="faq-5">问题 5：场景 1 中的许多测试在采用平板电脑设置时会失败，但在采用纸质图表时会通过。这是怎么回事？</h3>

<p>确保平板电脑和测试环境符合以下规范。</p>

<h4>平板电脑规范</h4>
<p>确保平板电脑符合以下规范：</p>
<ul>
  <li>显示屏尺寸（英寸）：10 英寸</li>
  <li>显示大小（像素）：大于 2000 x 1400 像素</li>
</ul>
<p>如需了解更多详情，请参阅<a href="/compatibility/cts/camera-its-box#tablet-requirements">针对平板电脑的要求</a>。
</p>

<h4>平板电脑亮度</h4>
<p>如果平板电脑显示屏亮度过低，测试可能无法获得正确结果。要提高运行 Android 7.0 及更高版本的平板电脑的亮度，请运行以下命令：</p>
<pre class="devsite-click-to-copy">
edit tools/wake_up_screen.py
DISPLAY_LEVEL=96 → DISPLAY_LEVEL=<strong>192</strong>
</pre>

<h4>盒子的光线强度（需要勒克斯计）</h4>
<p>确保平板电脑开启时的目标勒克斯值介于 100 到 300 之间。</p>
<p>如果勒克斯级别过高，<code>scene1/test_param_flash_mode.py</code> 会返回 <code>FAIL</code>。如果勒克斯级别过低，多个测试会失败。
</p>

<h3 id="faq-6">问题 6：在采用 WFoV 盒装 ITS 修订版 2 时，为什么场景中出现了 FoV 之外的对象？</h3>

<p>图表可能无法正确调节。图表调节适用于 Android 9 或更高版本。确保图表距离输入对于测试装置的版本而言正确无误。</p>

<p><strong>WFoV 盒装 ITS 修订版 2</strong></p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py ... chart=# <strong>dist=22</strong>
</pre>

<p><strong>RFoV 盒装 ITS 修订版 1（<code>dist=30</code> 是默认值）</strong></p>

<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_all_tests.py ... chart=#
</pre>

<h3 id="faq-7">问题 7：如何调试传感器融合测试？</h3>

<ol>
<li><p>确保您目前在 <code>dialout</code> 组中。</p>
<pre class="devsite-terminal devsite-click-to-copy">groups | egrep ‘dialout'</pre>
</li>
<li><p>确定 Microchip Technology 是否连接到 USB 端口，以此来确保传感器融合控制器已连接。</p>
<pre class="devsite-terminal devsite-click-to-copy">
lsusb
…
Bus 003 Device 004: ID 04d8:fc73 Microchip Technology, Inc.
…
</pre>
</li>
<li><p>使用以下命令多次运行测试，以获得测试尝试的分布情况：</p>
<pre class="devsite-terminal devsite-click-to-copy">
python tools/run_sensor_fusion_box.py device=A camera=0 num_runs=10 rotator=default
</pre>
<p>运行输出将位于在 <code>sensor_fusion_#</code> 文件夹下创建的 <code>/tmp/tmp###</code> 文件夹中，其中 <code>#</code> 是运行编号。失败的常见原因如下：</p>
  <ol>
  <li>手机未准确位于中心位置。</li>
  <li>未在图像中发现足够特征（通常是 FoV 或光线问题）。</li>
  <li>返回的 <code>FAIL</code> 有效，必须纠正相机和陀螺仪之间的定时偏差。</li>
  </ol>
</li>
</ol>

<h3 id="faq-8">问题 8：报告测试错误时应包含哪些信息？</h3>

<p>报告测试错误时，请包含测试的生成文件和图片。</p>

<ol>
<li>如果您通过 <code>tools/run_all_tests.py</code> 运行测试，请将压缩后的 <code>/tmp/tmp###</code> 目录附加到错误。</li>
<li>如果您单独运行测试，请将所有屏幕输出和生成的图片附加到错误。</li>
</ol>

<p>您还应包含错误报告。相关测试失败后，请使用以下命令生成错误报告，并将生成的 zip 文件附加到错误。
</p>

<pre class="devsite-terminal devsite-click-to-copy">
adb -s device_id bugreport
</pre>

</body></html>