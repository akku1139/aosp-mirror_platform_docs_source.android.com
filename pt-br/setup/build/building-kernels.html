<html devsite><head>
  <title>Como criar kernels</title>
  <meta name="project_path" value="/_project.yaml"/>
  <meta name="book_path" value="/_book.yaml"/>
</head>
<body>

<!--
    Copyright 2017 The Android Open Source Project

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<p>Esta página detalha o processo de criação de <a href="/devices/architecture/kernel/">kernels</a> personalizados para dispositivos Android. As instruções a seguir oferecem orientação sobre o processo para selecionar as origens certas, criar o kernel e incorporar os resultados em uma imagem do sistema criada a partir do Android Open Source Project (AOSP).</p>

<p>Origens mais recentes de kernel podem ser adquiridas utilizando o <a href="/setup/develop/repo#init">repo</a> e ser criadas sem outras configurações, executando <code>build/build.sh</code> a partir da raiz da saída da sua origem.</p>

<p class="note">A raiz da saída da origem do kernel contém <code>build/build.sh</code>. A árvore do Android contém apenas binários pré-construídos do kernel. As árvores do kernel contêm as origens e todas as ferramentas para criar os kernels, incluindo este script.</p>

<p>Para ver informações sobre kernels mais antigos ou kernels não listados abaixo, consulte as instruções sobre como criar <a href="/setup/build/building-kernels-deprecated">kernels legados</a>.</p>

<h2 id="downloading">Como fazer o download de origens e ferramentas de criação</h2>

<p>Para kernels recentes, é possível fazer o download de origens, conjuntos de ferramentas e scripts de criação usando o <a href="/setup/develop/repo#init"><code>repo</code></a>.
   Alguns kernels (por exemplo, os do Pixel 3) exigem origens de vários repositórios git, enquanto outros, como os kernels comuns, exigem apenas uma. O uso da abordagem <code>repo</code> garante uma configuração correta do diretório de origem.</p>

<p>Faça o download das origens para o branch apropriado:

</p><pre class="devsite-terminal devsite-click-to-copy">repo init -u https://android.googlesource.com/kernel/manifest -b <var>BRANCH</var></pre>
<pre class="devsite-terminal devsite-click-to-copy">repo sync</pre>

A tabela a seguir lista os nomes de <var>BRANCH</var> para kernels disponíveis por meio desse método:
   <table>
       <tbody><tr>
            <th>Dispositivo</th>
            <th>Caminho do binário na árvore AOSP</th>
            <th>Branches do repo</th>
       </tr>
       <tr>
            <td>Pixel 3a (sargo)</td>
            <td rowspan="2">device/google/bonito-kernel</td>
            <td rowspan="2">android-msm-bonito-4.9-pie-b4s4</td>
       </tr>
       <tr>
            <td>Pixel 3a XL (bonito)</td>
       </tr>
       <tr>
            <td>Pixel 3 (blueline)</td>
            <td rowspan="2">device/google/crosshatch-kernel</td>
            <td rowspan="2">android-msm-crosshatch-4.9-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel 3 XL (crosshatch)</td>
       </tr>
       <tr>
            <td>Pixel 2 (walleye)</td>
            <td rowspan="2">device/google/wahoo-kernel</td>
            <td rowspan="2">android-msm-wahoo-4.4-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel 2 XL (taimen)</td>
       </tr>
       <tr>
            <td>Pixel (sailfish)</td>
            <td rowspan="2">device/google/marlin-kernel</td>
            <td rowspan="2">android-msm-marlin-3.18-pie-qpr2</td>
       </tr>
       <tr>
            <td>Pixel XL (marlin)</td>
       </tr>
       <tr>
            <td>Hikey / Hikey960</td>
            <td>device/linaro/hikey-kernel</td>
            <td>hikey-linaro-android-4.4<br />
                hikey-linaro-android-4.9<br />
                hikey-linaro-android-4.14<br />
                hikey-linaro-android-4.19
            </td>
       </tr>
       <tr>
            <td>Beagle x15</td>
            <td>device/ti/beagle_x15-kernel</td>
            <td>omap-beagle-x15-android-4.14<br />
                omap-beagle-x15-android-4.19
            </td>
       </tr>
       <tr>
            <td>Beagle x15</td>
            <td>device/ti/beagle_x15-kernel</td>
            <td>omap-beagle-x15-android-4.14<br />
                omap-beagle-x15-android-4.19
            </td>
       </tr>
       <tr>
            <td>Kernel comum do Android</td>
            <td>N/A</td>
            <td>common-android-4.4<br />
                common-android-4.9<br />
                common-android-4.14<br />
                common-android-4.19<br />
                common-android-mainline
            </td>
       </tr>
   </tbody></table>
<p></p>

<aside class="note"><b>Observação</b>: você pode alternar entre diferentes branches dentro de uma saída de repo. Os manifestos comuns do kernel (e a maioria dos outros) definem o repositório git do kernel para ser clonado completamente (não superficialmente), o que permite a rápida alternância entre eles.
    Mudar para um branch diferente é semelhante a inicializar um branch. O parâmetro <code>-u</code> é opcional. Por exemplo, para mudar para <code>common-android-mainline</code> partir da sua saída de repo existente, execute:<br />
    <code>$ repo init -b common-android-mainline &amp;&amp; repo sync</code>.
</aside>

<h2 id="building">Como criar o kernel</h2>

<p>Em seguida, crie o kernel com:

</p><pre class="devsite-terminal devsite-click-to-copy">build/build.sh</pre>
<p></p>

<p class="note"><b>Observação</b>: os kernels comuns são genéricos e personalizáveis e, portanto, não definem uma configuração padrão. Consulte a <a href="#customize-build">seção de <i>criação personalizada</i></a> para saber como especificar o <code>BUILD_CONFIG</code> para kernels comuns.</p>

<p>O binário, os módulos e a imagem correspondente do kernel estão localizados no diretório <code>out/<var>BRANCH</var>/dist</code>.</p>

<h2 id="running">Como executar o kernel</h2>

<p>Existem várias maneiras de executar um kernel personalizado. A seguir apresentamos as maneiras conhecidas que são adequadas para vários cenários de desenvolvimento:</p>

<h3>Como incorporar na criação da imagem do Android</h3>

<p>Copie a <code>Image.lz4-dtb</code> para o respectivo local do binário do kernel dentro da árvore AOSP e recrie a imagem de inicialização.</p>

<p>Outra alternativa é incluir a variável <code>TARGET_PREBUILT_KERNEL</code> ao usar <code>make bootimage</code> (ou qualquer outra linha de comando <code>make</code> que crie uma imagem de inicialização). Essa variável é compatível com todos os dispositivos, porque ela é configurada por <code>device/common/populate-new-device.sh</code>.
   Exemplo:</p>

<pre class="devsite-terminal devsite-click-to-copy">
export TARGET_PREBUILT_KERNEL=<var>DIST_DIR</var>/Image.lz4-dtb
</pre>

<h3>Como realizar uma atualização flash e inicializar kernels com fastboot</h3>
<p>Os dispositivos mais recentes têm uma extensão do carregador de inicialização para otimizar o processo de geração e inicialização de uma bootimage.

Para inicializar o kernel sem realizar uma atualização flash:

</p><pre class="devsite-click-to-copy">
<code class="devsite-terminal">adb reboot bootloader</code>
<code class="devsite-terminal">fastboot boot Image.lz4-dtb</code>
</pre>

Com o uso desse método, uma atualização flash não é realizada no kernel e, portanto, não persistirá durante a reinicialização.
<p></p>

<p class="note"><strong>Observação</strong>: os nomes do kernel diferem de acordo com o dispositivo. Para localizar o nome de arquivo correto do seu kernel, consulte <code>device/<var>VENDOR</var>/<var>NAME</var>-kernel</code> na árvore AOSP.</p>

<h2 id="customize-build">Personalizar a criação do kernel</h2>

<p>O processo de criação e o resultado podem ser influenciados por variáveis de ambiente.
   A maior parte das variáveis é opcional e cada branch do kernel apresenta uma configuração padrão adequada. As mais usadas estão listadas aqui. Para ver uma lista completa (e atualizada), consulte <code>build/build.sh</code>.
   </p><table>
       <tbody><tr>
            <th>Variável de ambiente</th>
            <th>Descrição</th>
            <th>Exemplo</th>
       </tr>
       <tr>
            <td><code>BUILD_CONFIG</code></td>
            <td>Cria o arquivo de configuração para inicializar o ambiente de criação a partir dele.
                O local precisa ser definido em relação ao diretório raiz do repo. O padrão é "build.config".<br />
                <b>Obrigatório para kernels comuns.</b>
            </td>
            <td><code>BUILD_CONFIG=common/build.config.cuttlefish.x86_64</code></td>
       </tr>
       <tr>
            <td><code>OUT_DIR</code></td>
            <td>Diretório de saída base para a criação do kernel.</td>
            <td><code>OUT_DIR=/path/to/my/out</code></td>
       </tr>
       <tr>
            <td><code>DIST_DIR</code></td>
            <td>Diretório de saída base para a distribuição do kernel.</td>
            <td><code>OUT_DIR=/path/to/my/dist</code></td>
       </tr>
       <tr>
            <td><code>CC</code></td>
            <td>Substitui o compilador a ser usado. Volta para o compilador padrão definido pelo build.config.</td>
            <td><code>CC=clang</code></td>
       </tr>
       <tr>
            <td><code>SKIP_MRPROPER</code></td>
            <td>Pula <code>make mrproper</code></td>
            <td><code>SKIP_MRPROPER=1</code></td>
       </tr>
       <tr>
            <td><code>SKIP_DEFCONFIG</code></td>
            <td>Pula <code>make defconfig</code></td>
            <td><code>SKIP_DEFCONFIG=1</code></td>
       </tr>
   </tbody></table>

<h2 id="customize-config">Configuração personalizada do kernel para criações locais</h2>

<p>Se você precisar alternar regularmente uma opção de configuração do kernel, por exemplo, quando estiver trabalhando em um recurso ou se precisar configurar uma opção para fins de desenvolvimento, é possível conseguir essa flexibilidade mantendo uma modificação ou cópia local da configuração de criação.</p>
<p>Defina a variável <var>POST_DEFCONFIG_CMDS</var> como uma declaração que é avaliada logo após a etapa normal de <code>make defconfig</code> ter sido realizada. Como os arquivos <code>build.config</code> são originados no ambiente de criação, as funções definidas em <code>build.config</code> podem ser chamadas como parte dos comandos post-defconfig.</p>
<p>Um exemplo comum é desativar a Otimização de tempo de vinculação (LTO, na sigla em inglês) para kernels crosshatch durante o desenvolvimento. Embora a LTO seja benéfica para os kernels lançados, a sobrecarga no tempo de criação pode ser significativa. O snippet a seguir, incluído no <code>build.config</code> local, sempre desativará a LTO ao usar <code>build/build.sh</code>.
</p><pre class="devsite-click-to-copy">
<code>POST_DEFCONFIG_CMDS="check_defconfig &amp;&amp; update_debug_config"
function update_debug_config() {
    ${KERNEL_DIR}/scripts/config --file ${OUT_DIR}/.config \
         -d LTO \
         -d LTO_CLANG \
         -d CFI \
         -d CFI_PERMISSIVE \
         -d CFI_CLANG
    (cd ${OUT_DIR} &amp;&amp; \
     make O=${OUT_DIR} $archsubarch CROSS_COMPILE=${CROSS_COMPILE} olddefconfig)
}</code>

</pre><p>

</p><h2 id="id-version">Como identificar as versões do kernel</h2>
<p>Há várias maneiras de identificar a versão correta a ser criada.</p><p>

</p><h3 id="id-version-from-aosp">Versão do kernel da árvore AOSP</h3>
<p>A árvore AOSP contém versões pré-criadas do kernel. Na maioria dos casos, o log do git revela a versão correta como parte da mensagem de confirmação:
</p><pre class="devsite-click-to-copy">
<code class="devsite-terminal">cd $AOSP/device/<var>VENDOR</var>/<var>NAME</var></code>
<code class="devsite-terminal">git log --max-count=1</code>
</pre><p></p>

<h3 id="id-version-from-system-image">Versão do kernel da imagem do sistema</h3>

<p>Para determinar a versão do kernel usada em uma imagem do sistema, execute o seguinte comando no arquivo do kernel:
</p><pre class="devsite-terminal devsite-click-to-copy">
file kernel
</pre><p></p>

<p>Para arquivos <code>Image.lz4-dtb</code>, execute:</p>
<pre class="devsite-terminal devsite-click-to-copy">
grep -a 'Linux version' Image.lz4-dtb
</pre>

</body></html>