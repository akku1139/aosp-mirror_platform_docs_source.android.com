<html devsite><head>
    <title>Imagens genéricas do sistema</title>
    <meta name="project_path" value="/_project.yaml"/>
    <meta name="book_path" value="/_book.yaml"/>
  </head>
  <body>
  <!--
      Copyright 2018 The Android Open Source Project

      Licensed under the Apache License, Version 2.0 (the "License");
      you may not use this file except in compliance with the License.
      You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

      Unless required by applicable law or agreed to in writing, software
      distributed under the License is distributed on an "AS IS" BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
      See the License for the specific language governing permissions and
      limitations under the License.
  -->

<p>
  Uma imagem genérica do sistema (GSI, na sigla em inglês) é uma imagem do sistema com configurações ajustadas para dispositivos Android. Ela é considerada uma implementação de <em>Android puro</em> com código do Android Open Source Project (AOSP) não modificado que qualquer dispositivo com Android 8.1 ou versões posteriores pode executar.
</p>

<p>
  As GSIs são usadas para executar testes de VTS e CTS-on-GSI. A imagem do sistema de um dispositivo Android é substituída por uma GSI e testada com o <a href="/compatibility/vts/">Teste de fornecedor (VTS, na sigla em inglês)</a> e o <a href="/compatibility/cts/">Teste de compatibilidade (CTS, na sigla em inglês)</a> para garantir que o dispositivo implemente interfaces do fornecedor corretamente com a versão mais recente do Android.
</p>

<aside class="note"><strong>Observação</strong>: este artigo descreve tópicos relacionados à GSI para desenvolvedores de ROM e OEM do Android. Os desenvolvedores de apps Android precisam consultar <a href="https://developer.android.com/topic/generic-system-image/" class="external">developer.android.com</a> para ver os detalhes de GSI destinados a eles.
</aside>

<p>
  Para começar a usar GSIs, leia as seções a seguir para ver mais detalhes sobre as <a href="#gsi-configuration-and-variances">configurações de GSI</a> (e as variações permitidas), os <a href="#gsi-types">tipos</a> (GSI Android e GSI legada) e os <a href="#vendor-binaries-and-vndk-dependencies">binários do fornecedor e dependências de VNDK</a>. Quando estiver tudo pronto para usar uma GSI, <a href="#building-gsis">faça o download da GSI e compile-a</a> para seu dispositivo de destino. Depois, <a href="#flashing-gsis">atualize a GSI</a> para um dispositivo Android.
</p>

<h2 id="gsi-configuration-and-variances">Configuração e variações de GSI</h2>

<p>
  O projeto atual do Android GSI tem a seguinte configuração:
</p>

<ul>
  <li><strong>Treble.</strong> A GSI inclui compatibilidade total com as <a href="/devices/architecture/#hidl">alterações de arquitetura baseadas em HIDL</a> (também conhecidas como <em>Treble</em>) introduzidas no Android 8.0, incluindo compatibilidade com as <a href="/reference/hidl/">interfaces HIDL</a>. Você pode usar uma GSI em qualquer dispositivo Android que use interfaces de fornecedores HIDL. Para ver mais detalhes, consulte <a href="/devices/architecture/#resources">Recursos de arquitetura</a>.</li>
  <li><strong>Verificação de inicialização.</strong> A GSI não inclui uma solução para verificação de inicialização (<a href="/security/verifiedboot">vboot 1.0</a> ou <a href="/security/verifiedboot/avb">AVB</a>). Para atualizar a GSI com flash em um dispositivo Android, será preciso ter um método para desativar a verificação de inicialização.
    </li>
  <li><strong>Variante de versão.</strong> Uma GSI sempre usa uma variante de versão <code>userdebug</code> para possibilitar a execução de VTS e CTS. Depois de substituir a imagem do sistema pela GSI, você pode ativar o acesso root no dispositivo e testar com uma imagem do fornecedor de versão <code>user</code> e uma imagem do sistema de criação <code>userdebug</code>.</li>
  <li><strong>Sistema de arquivos e formato da imagem.</strong> A GSI usa um sistema de arquivos ext4 com formato de imagem esparsa.</li>
</ul>

<p>
  O projeto atual do Android GSI inclui as seguintes variações principais:
</p>

<ul>
  <li><strong>Versão.</strong> Compatível com Android 8.0, Android 8.1 e Android 9.</li>
  <li><strong>Arquitetura da CPU.</strong> Compatível com diferentes instruções de CPU (ARM, x86 etc.) e quantidades de bits de CPU (32 ou 64 bits).</li>
  <li><strong>Layout de partição.</strong> Pode usar o layout de partição de <a href="/devices/bootloader/system-as-root">sistema como raiz</a> ou sistema não usado como raiz.</li>
  <li>Compatível com a quantidade de bits da interface Binder.</li>
</ul>

<h2 id="gsi-types">Tipos de GSI</h2>

<p>
  A GSI usada para teste de conformidade é determinada pela versão do Android com que o dispositivo é lançado. O Android é compatível com as seguintes GSIs:
</p>

<table>
  <tbody><tr>
   <th style="width:15%">Nome da GSI</th>
   <th>Descrição</th>
   <th style="width:15%">Nome do produto</th>
  </tr>
  <tr>
   <td>GSI Android</td>
   <td>Para dispositivos lançados com o Android 9. Esta GSI só pode ser executada em dispositivos com o Android 9 ou posterior.</td>
   <td><code>aosp_$arch</code></td>
  </tr>
  <tr>
   <td>GSI legada</td>
   <td>Para dispositivos lançados com o Android 8.0 ou Android 8.1. Esta GSI só pode ser executada em dispositivos com Android 8.x.</td>
   <td><code>aosp_$arch_a(b)</code></td>
  </tr>
</tbody></table>

<p>
  Todas as GSIs são criadas a partir da codebase do Android 9, e cada arquitetura de CPU tem um binário GSI correspondente (veja a lista de destinos de criação em <a href="#building-gsis">Como criar GSIs</a>).
</p>

<h3 id="changes-in-p-gsis">Alterações na GSI do Android 9</h3>

<p>
  Os dispositivos lançados com o Android 9 precisam usar as GSIs dessa versão do sistema para testes de conformidade. Isso inclui as seguintes alterações importantes das GSIs anteriores:
</p>

<ul>
  <li><strong>Combinação de GSI e emulador.</strong> As GSIs são criadas com base nas imagens do sistema de produtos emuladores, como <code>aosp_arm64</code> e <code>aosp_x86</code>.</li>
  <li><strong>Sistema como raiz.</strong> Nas versões anteriores do Android, os dispositivos que não eram compatíveis com atualizações A/B podiam ativar a imagem do sistema no diretório <code>/system</code>. No Android 9, a raiz da imagem do sistema é ativada como a raiz do dispositivo.</li>
  <li><strong>Interface Binder de 64 bits.</strong> No Android 8.x, as GSIs de 32 bits usavam a interface Binder de 32 bits. O Android 9 não é compatível com a interface Binder de 32 bits, então GSIs de 32 bits e de 64 bits usam a interface Binder de 64 bits.</li>
  <li><strong>Obrigatoriedade do VNDK.</strong> No Android 8.1, o VNDK era opcional. No Android 9, o VNDK é obrigatório, o que significa que <code>BOARD_VNDK_RUNTIME_DISABLE</code> <strong>não</strong> pode ser definido (<code>BOARD_VNDK_RUNTIME_DISABLE :=  # must not be set</code>).</li>
  <li><strong>Propriedade do sistema compatível.</strong> O Android 9 ativa a verificação de acesso para propriedades de sistema compatíveis (<code>PRODUCT_COMPATIBLE_PROPERTY_OVERRIDE :=
    true</code>).</li>
</ul>

<p>
  Para testar os dispositivos que são lançados com o Android 9 com CTS-on-GSI, use os <a href="#p-gsi-build-targets">destinos de criação da GSI do Android 9</a>.
</p>

<h3 id="changes-in-legacy-gsis">Alterações da GSI legada do Android 9</h3>

<p>
  Dispositivos que passam por upgrade para o Android 9 podem usar o nome do produto da GSI legada com sufixo <code>_ab</code> ou <code>_a</code> (por exemplo, <code>aosp_arm64_ab</code>, <code>aosp_x86_a</code>) para o teste de conformidade. Essa GSI é compatível com os seguintes casos de uso de upgrade:
</p>

<ul>
  <li>Dispositivos com a implementação da interface de fornecedor do Android 8.1</li>
  <li>Dispositivos atualizados para a implementação da interface do fornecedor do Android 9</li>
</ul>

<p>
  As GSIs legadas são criadas com base na árvore de origem do Android 9, mas contêm as seguintes configurações retrocompatíveis para dispositivos que passaram por upgrade:
</p>

<ul>
  <li><strong>Sistema não usado como raiz.</strong> Dispositivos não compatíveis com o uso do sistema como raiz podem continuar a usar produtos <code>_a</code> (por exemplo, <code>aosp_arm_a</code>).</li>
  <li><strong>Espaço do usuário de 32 bits + interface Binder de 32 bits</strong>. As GSIs de 32 bits podem continuar usando a interface Binder de 32 bits.</li>
  <li><strong>VNDK do 8.1</strong>. Os dispositivos podem usar o VNDK do 8.1 incluso.</li>
  <li><strong>Diretórios de ativação.</strong> Alguns dispositivos legados usam diretórios como indicadores de ativação (por exemplo, <code>/bluetooth</code>, <code>/firmware/radio</code> e <code>/persist</code>).</li>
</ul>

<p>
  Para testar os dispositivos que passam por upgrade para o Android 9 com CTS-on-GSI, use os <a href="#legacy-gsi-build-targets">destinos de criação da GSI legada</a>.
</p>

<aside class="note">
  <strong>Observação</strong>: se um dispositivo anterior ao Android 9 implementar a interface do fornecedor do Android 9 e atender a todos os requisitos introduzidos nessa versão, não use as GSIs legadas, mas sim as GSIs do Android 9 para VTS e CTS-on-GSI.
</aside>

<h3 id="changes-to-keymaster-behavior">Alterações no Keymaster do Android 9</h3>

<p>
  Nas versões anteriores do Android, os dispositivos que implementavam o Keymaster 3 ou versões anteriores precisavam verificar se as informações da versão (<code>ro.build.version.release</code> e <code>ro.build.version.security_patch</code>) relatadas pelo sistema em execução correspondiam às informações de versão relatadas pelo carregador de inicialização. Essa informação geralmente vinha do cabeçalho da imagem de inicialização.
</p>

<p>
  No Android 9, esse requisito foi alterado para permitir que os fornecedores inicializem uma GSI. Especificamente, o Keymaster não pode mais executar a verificação, porque as informações de versão relatadas pela GSI podem não corresponder às informadas pelo carregador de inicialização do fornecedor. No caso de dispositivos que implementam o Keymaster 3 ou versões anteriores, os fornecedores precisam modificar a implementação do Keymaster para ignorar a verificação (ou fazer upgrade para o Keymaster 4). Para ver mais detalhes sobre o Keymaster, consulte <a href="/security/keystore/">Armazenamento de chaves protegido por hardware</a>.
</p>

<h2 id="vendor-binaries-and-vndk-dependencies">Binários do fornecedor e dependências do VNDK</h2>

<p>
  Os dispositivos que passam por upgrade para o Android 9 têm diferentes caminhos de upgrade, dependendo da versão dos binários do fornecedor em uso no dispositivo e das configurações relacionadas ao VNDK usadas para criar os dispositivos. A tabela a seguir resume a compatibilidade da GSI legada com dispositivos que passaram por upgrade:
</p>

<table>
  <tbody><tr>
   <th>Caso de uso</th>
   <th>Versão<br />dos binários do<br />fornecedor</th>
   <th><code>BOARD_VNDK_VERSION</code></th>
   <th><code>BOARD_VNDK_<br />RUNTIME_DISABLE</code></th>
   <th>Versão dos binários do sistema<br />da GSI legada</th>
   <th>Compatível com a GSI legada</th>
  </tr>
  <tr>
   <td>0</td>
   <td>8.0</td>
   <td>(qualquer)</td>
   <td>(N/A)</td>
   <td>9</td>
   <td>Não</td>
  </tr>
  <tr>
   <td>1.a</td>
   <td>8.1</td>
   <td>(vazio)</td>
   <td>(qualquer)</td>
   <td>9</td>
   <td>Não</td>
  </tr>
  <tr>
   <td>1.b</td>
   <td>8.1</td>
   <td><code>current</code></td>
   <td><code>true</code></td>
   <td>9</td>
   <td>Não</td>
  </tr>
  <tr>
   <td>2</td>
   <td>8.1</td>
   <td><code>current</code></td>
   <td>(vazio)</td>
   <td>9</td>
   <td>Sim</td>
  </tr>
  <tr>
   <td>3</td>
   <td>9</td>
   <td><code>current</code></td>
   <td><code>true</code></td>
   <td>9</td>
   <td>Sim</td>
  </tr>
  <tr>
   <td>4</td>
   <td>9</td>
   <td><code>current</code></td>
   <td>(vazio)</td>
   <td>9</td>
   <td>Sim</td>
  </tr>
</tbody></table>

<p>
  O caso de uso compatível mais comum é o 2, em que a GSI legada é compatível com dispositivos que executam o Android 8.1 e foram criados com <code>BOARD_VNDK_VERSION</code>, mas sem <code>BOARD_VNDK_RUNTIME_DISABLE</code>. Ou seja, a aplicação do ambiente de execução NÃO foi desativada.
</p>

<p>
  Os dois casos de uso não compatíveis são 1.a e 1.b. Nesses casos, as GSIs legadas NÃO são compatíveis com dispositivos que executam o Android 8.1, em que 1) <code>BOARD_VNDK_VERSION</code> foi omitido da compilação ou 2) a aplicação de tempo de execução foi desativada (ou seja, eles foram criados com <code>BOARD_VNDK_RUNTIME_DISABLE</code>). Esses dispositivos não são compatíveis, porque seus binários de fornecedores dependem de bibliotecas compartilhadas do Android 8.1 não VNDK, que não estão incluídas em GSIs legadas. Para tornar esses dispositivos compatíveis com a GSI legada, é necessário seguir um destes procedimentos:
</p>

<ul>
  <li>Ativar <code>BOARD_VNDK_VERSION</code> sem <code>BOARD_VNDK_RUNTIME_DISABLE</code> (caso de uso 2)
    <br /><br />OU<br /><br /></li>
  <li>Portar/fazer upgrade dos binários do fornecedor para depender de bibliotecas compartilhadas do Android 9 (casos de uso 3 e 4).</li>
</ul>

<h2 id="downloading-gsis">Download de GSIs</h2>

<p>
  É possível fazer o download de GSIs pré-construídas para alguns tipos de Android 9 GSI no site de integração contínua (CI) do AOSP em <a href="https://ci.android.com/builds/branches/aosp-pie-gsi/grid?" class="external">ci.android.com</a>. Se o tipo de GSI da sua plataforma de hardware não estiver disponível para download, consulte a seção a seguir para saber sobre como criar GSIs para destinos específicos.
</p>

<h2 id="building-gsis">Como criar GSIs</h2>

<p>
  A partir do Android 9, todas as versões têm um branch de GSI chamado <code><var>DESSERT</var>-gsi</code> no AOSP (por exemplo, <code>pie-gsi</code> é o branch de GSI no Android 9). Os branches de GSI incluem o conteúdo do Android com todos os <a href="/security/bulletin/">patches de segurança</a> e <a href="#contributing-to-gsis">de GSI</a> aplicados.
</p>

<p>
  Para criar uma GSI, configure a árvore de origem do Android <a href="/setup/build/downloading">fazendo o download</a> de um branch de GSI e <a href="/setup/build/building#choose-a-target">escolhendo um destino de criação da GSI</a>. Use as tabelas de destino de criação abaixo para determinar a versão correta da GSI para seu dispositivo. Quando a criação for concluída, a GSI se tornará a imagem do sistema (ou seja, <code>system.img</code>) e aparecerá na pasta de saída <code>out/target/product/<strong>generic_arm64_ab</strong></code>. A criação também gera <code>vbmeta.img</code>, que você pode usar para desativar a verificação de inicialização nos dispositivos por meio da <a href="/security/verifiedboot/avb">Inicialização verificada do Android</a>.
</p><p>

</p><p>
  Por exemplo, para gerar o destino de criação <code>aosp_arm64_ab-userdebug</code> da GSI legada no branch de GSI <code>pie-gsi</code>, execute os seguintes comandos:
</p>

<pre class="prettyprint">
$ repo init -u https://android.googlesource.com/platform/manifest -b pie-gsi
$ repo sync -cq
$ source build/envsetup.sh
$ lunch aosp_arm64_ab-userdebug
$ make -j4
</pre>

<h3 id="p-gsi-build-targets">Destinos de criação de GSI do Android 9</h3>

<p>
  Os seguintes destinos de criação de GSI são voltados para dispositivos lançados com o Android 9. Devido à redução nas variações entre as arquiteturas, o Android 9 inclui apenas quatro produtos GSI.
</p>

<table>
  <tbody><tr>
   <th>Nome da GSI</th>
   <th>Arquitetura da CPU</th>
   <th>Quantidade de bits da interface Binder</th>
   <th>Sistema como raiz</th>
   <th>Nome do produto</th>
  </tr>
  <tr>
   <td><code>aosp_arm</code></td>
   <td>ARM</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_arm-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_arm64</code></td>
   <td>ARM64</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_arm64-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_x86</code></td>
   <td>x86</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_x86-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_x86_64</code></td>
   <td>x86-64</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_x86_64-userdebug</code></td>
  </tr>
</tbody></table>

<h3 id="legacy-gsi-build-targets">Destinos de criação de GSI legada do Android 9</h3>

<p>
  Os seguintes destinos de criação de GSI legada são voltados para dispositivos que passam por upgrade para o Android 9. Nomes de GSI legadas incluem o sufixo <code>_ab</code> ou <code>_a</code> para distingui-los dos nomes da GSI do Android 9.
</p>

<table>
  <tbody><tr>
   <th>Nome da GSI</th>
   <th>Arquitetura da CPU</th>
   <th>Quantidade de bits da interface Binder</th>
   <th>Sistema como raiz</th>
   <th>Nome do produto</th>
  </tr>
  <tr>
   <td><code>aosp_arm_a</code></td>
   <td>ARM</td>
   <td>32</td>
   <td>N</td>
   <td><code>aosp_arm_a-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_arm_ab</code></td>
   <td>ARM</td>
   <td>32</td>
   <td>Y</td>
   <td><code>aosp_arm_ab-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_arm_64b_ab</code></td>
   <td>ARM</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_arm_64b_ab-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_arm64_a</code></td>
   <td>ARM64</td>
   <td>64</td>
   <td>N</td>
   <td><code>aosp_arm64_a-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_arm64_ab</code></td>
   <td>ARM64</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_arm64_ab-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_x86_a</code></td>
   <td>x86</td>
   <td>32</td>
   <td>N</td>
   <td><code>aosp_x86_a-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_x86_ab</code></td>
   <td>x86</td>
   <td>32</td>
   <td>Y</td>
   <td><code>aosp_x86_ab-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_x86_64_a</code></td>
   <td>x86-64</td>
   <td>64</td>
   <td>N</td>
   <td><code>aosp_x86_64_a-userdebug</code></td>
  </tr>
  <tr>
   <td><code>aosp_x86_64_ab</code></td>
   <td>x86-64</td>
   <td>64</td>
   <td>Y</td>
   <td><code>aosp_x86_64_ab-userdebug</code></td>
  </tr>
</tbody></table>

<aside class="aside">
  <strong>Observação</strong>: esses destinos de criação provavelmente serão removidos em uma versão futura do Android.
</aside>

<h2 id="flashing-gsis">Requisitos de atualização de GSIs com flash</h2>

<p>
  Os dispositivos Android podem ter designs diferentes, então não é possível ter um comando ou conjunto de instruções único para atualizar uma GSI com flash para um dispositivo específico. Consulte o fabricante do dispositivo Android para receber as instruções explícitas de atualização com flash ou use as seguintes etapas gerais como diretrizes:
</p>

<ol>
  <li>Verifique se o dispositivo conta com:
    <ul>
      <li>compatibilidade com interfaces HIDL-HAL;</li>
      <li>um método para desbloquear dispositivos (para que eles possam ser atualizados com flash usando <code>fastboot</code>);</li>
      <li>um método para desativar a verificação de inicialização (por exemplo, <a href="/security/verifiedboot/">vboot 1.0</a> ou <a href="/security/verifiedboot/avb">AVB</a>);</li>
      <li>um estado desbloqueado para torná-lo atualizável com flash por meio de <code>fastboot</code>. Necessária a versão mais recente do <code>fastboot</code>, criada a partir da árvore de origem do Android.</li>
    </ul>
  </li>
  <li>Desative a verificação de inicialização.</li>
  <li>Limpe a partição atual do sistema e, em seguida, atualize a GSI com flash para a partição.</li>
  <li>Exclua permanentemente os dados do usuário e limpe outras partições necessárias (por exemplo, dados do usuário e partições do sistema).</li>
  <li>Reinicialize o dispositivo.</li>
</ol>

<p>
  Por exemplo, para atualizar uma GSI com flash para qualquer dispositivo Pixel, faça o seguinte:
</p>

<ol>
  <li><a href="/setup/build/running#booting-into-fastboot-mode">Inicialize no modo <code>fastboot</code></a> e <a href="/setup/build/running#unlocking-the-bootloader">desbloqueie o carregador de inicialização</a>.</li>
  <li>Desative a verificação de inicialização do Android (AVB, na sigla em inglês) atualizando com flash o <code>vbmeta.img</code>:
<pre class="prettyprint">$ fastboot --disable-verification flash vbmeta vbmeta.img</pre></li>
  <li>Limpe e atualize a GSI com flash para a partição do sistema:
<pre class="prettyprint">
$ fastboot erase system
$ fastboot flash system system.img
</pre></li>
  <li>Exclua permanentemente os dados do usuário e limpe outras partições necessárias (por exemplo, dados do usuário e partições do sistema).
<pre class="prettyprint">$ fastboot -w</pre></li>
  <li>Reinicialize:
<pre class="prettyprint">$ fastboot reboot</pre></li>
</ol>

<h2 id="contributing-to-gsis">Como contribuir com GSIs</h2>

<p>
  O Android aceita de braços abertos suas contribuições para o desenvolvimento de GSI. Você pode participar e ajudar na melhoria da GSI da seguinte forma:
</p>

<ul>
  <li><strong>Criando um patch de GSI.</strong> Como o <code><var>DESSERT</var>-gsi</code> <strong>não</strong> é um branch de desenvolvimento e aceita apenas seleções do branch master do AOSP, você precisa fazer o seguinte para enviar um patch de GSI:
    <ol>
      <li>Enviar o patch para o branch <code>master</code> do <a href="https://android-review.googlesource.com" class="external">AOSP</a>.</li>
      <li>Selecionar o patch para <code><var>DESSERT</var>-gsi</code>.</li>
      <li>Informar um bug para que a seleção seja analisada.</li>
    </ol>
  </li>
  <li><strong>Informando bugs da GSI</strong> ou fazendo outras sugestões. Leia as instruções em <a href="/setup/contribute/report-bugs#platform">Como informar bugs</a> e depois procure ou registre <a href="https://issuetracker.google.com/issues?q=componentid:470386%2B" class="external">bugs de GSI</a>.</li>
</ul>

</body></html>
